<!-- Copyright (c) Abstract Machines
SPDX-License-Identifier: Apache-2.0 -->

{{ define "broadcast" }}
<!doctype html>
<html lang="en">
<head>
	<title>实时</title>
	{{ template "header" }}
	<style>
		.volumeFormItemLine {
			height: 8px;
			width: 50px;
			margin: 10px auto 5px;
			background-color: #d8d8d8;
			border-radius: 6px;
			cursor: pointer;
		}
		.volumeFormItemLine.selected {
			background-color: #28c840;
		}
		#playarea_channels_container {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
			grid-gap: 10px;
			overflow-y: auto;
		}
	</style>
</head>
<body>
	{{ template "navbar" . }}
	<div class="main-content pt-3">
		<div class="container-fluid">
			<div class="row-mb-3 p-3">
				<div class="col-12 mx-auto">
					<!-- 选择文件弹框 -->
					<div 
						class="modal fade" 
						id="filesModal" 
						tabindex="-1" 
						role="dialog" 
						aria-labelledby="filesModalLabel" 
						aria-hidden="true"
						data-bs-backdrop="static" 
						data-bs-keyboard="false"  
					>
						<div class="modal-dialog" role="document">
							<div class="modal-content" style="width: 580px;">
								<div class="modal-header">
									<h1 class="modal-title" id="filesModal">音频文件</h1>
									<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="sourceModal.show();"></button>
								</div>
								<div class="modal-body">
									<div class="mb-3">
										<nav>
											<ol class="breadcrumb" id="breadcrumbNavigator" style="margin-left: 5px; margin-bottom: 5px;"></ol>
										</nav>
									</div>
									<div class="mb-3 row modalTableContainer">
										<table 
											id="filesModalTable"
											class="table table-hover"
											data-checkbox-header="true"
											data-click-to-select="true"
										>
											<thead>
												<tr>
													<th data-field="state" data-checkbox="true" data-formatter="fileNameTableStateFormatter"></th>
													<th data-field="fileName" data-formatter="fileNameTableFormatter">文件名</th>
												</tr>
											</thead>
										</table>
									</div>
									<div class="modal-footer">
										<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="sourceModal.show();">
											<i class="fa-solid fa-xmark"></i> 取消
										</button>
										<button type="button" class="btn body-button" id="confirmFileBtn">
											<i class="fa-solid fa-floppy-disk"></i> 确定
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div 
						class="table-responsive table-container" 
						style="
							display: flex;
							justify-content: space-between;
							padding: 0;
						"
					>
						<div 
							style="
								width: 100%;
								display: flex;  
								flex-direction: column;
								justify-content: space-between;
							"
						>
							<div style="display: flex; justify-content: space-between; padding: 10px;">
								<div style="display: flex;">
									<div style="width: 110px; line-height: 38px;">调音设备: </div>
									<select class="form-control form-select" id="thingsSelect" placeholder="请选择调音设备"></select>
								</div>
								<div>
									<select class="form-control form-select" id="sceneSelect" placeholder="请选择场景"></select>
								</div>
							</div>
							<div 
								style="
									display: flex;
									flex-direction: column;
									backdrop-filter: blur(5px);
									-webkit-backdrop-filter: blur(5px);
									background: rgba(0, 0, 0, 0.05);
									height: calc(100vh - 560px);
									margin: 0px 10px;
									border-radius: 5px;
									padding: 10px;
								"
							>
								<div style="display: flex; justify-content: space-between; margin-bottom: 7px;">
									<div>播放区域</div>
									<div
										id="play-area-select-unselect-all-btn" 
										style="color: var(--main-color); cursor: pointer;" 
										title="全选"
									>
										<i class="fa-solid fa-list-check"></i>
									</div>
								</div>
								<div id="playarea_channels_container"></div>
							</div>
							<div 
								style="
									display: flex;
									flex-direction: column;
									height: 330px;
									margin: 10px 10px 0px 10px;
									border-top-left-radius: 5px;
									border-top-right-radius: 5px;
									backdrop-filter: blur(5px);
									-webkit-backdrop-filter: blur(5px);
									background: rgba(0, 0, 0, 0.05);
								"
							>
								<div 
									style="
										display: flex; 
										justify-content: space-evenly; 
										border-bottom: thin solid lightgray;
										height: 64px;
										padding: 10px;
									"
								>
									<div style="text-align: center; width: 64px;">
										<div class="volumeFormItemLine"></div>
										<div>线路输入</div>
									</div>
									<div style="text-align: center; width: 64px;">
										<div class="volumeFormItemLine selected"></div>
										<div>麦克风</div>
									</div>
									<div style="text-align: center; width: 64px;">
										<div class="volumeFormItemLine selected"></div>
										<div>文件</div>
									</div>
								</div>
								<div 
									style="
										display: flex; 
										justify-content: space-evenly; 
										padding: 10px;
									"
								>
									<div style="text-align: center; width: 64px;">
										<div class="range-wrapper speaker-volume-wrapper" style="background: transparent;">
											<div class="range-value" style="margin-top: 0px; margin-bottom: 205px;">0</div>
											<input
												type="range"
												min="0"
												max="15"
												class="vertical-range rangeInput"
												value="0"
												oninput="updateVerticalRangeValue(this)"
											/>
										</div>
									</div>
									<div style="text-align: center; width: 64px;">
										<div class="range-wrapper speaker-volume-wrapper" style="background: transparent;">
											<div class="range-value" style="margin-top: 0px; margin-bottom: 205px;">0</div>
											<input
												type="range"
												min="0"
												max="15"
												class="vertical-range rangeInput"
												value="0"
												oninput="updateVerticalRangeValue(this)"
											/>
										</div>
									</div>
									<div style="text-align: center; width: 64px;">
										<div class="range-wrapper speaker-volume-wrapper" style="background: transparent;">
											<div class="range-value" style="margin-top: 0px; margin-bottom: 205px;">0</div>
											<input
												type="range"
												min="0"
												max="15"
												class="vertical-range rangeInput"
												value="0"
												oninput="updateVerticalRangeValue(this)"
											/>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div 
							style="
								width: 450px;
								display: flex; 
								flex-direction: column; 
								justify-content: space-between;
							"
						>
							<div class="playlist" style="padding: 10px; background: whitesmoke; border-bottom-left-radius: 5px;">
								<div style="display: flex; justify-content: space-between;">
									<div style="line-height: 38px;">播放列表</div>
									<div class="btn-group" role="group">
										<button 
											id="playlist-delete-all-btn" 
											type="button" 
											class="btn btn-light" 
											title="清空列表" 
											disabled
											onclick="deleteAllPlaylistItems()"
										>
											<i class="fa-solid fa-trash-can"></i>
										</button>
										<button type="button" class="btn btn-light" title="添加文件" id="addSourceModalFileBtn">
											<i class="fa-solid fa-plus"></i>
										</button>
									</div>
								</div>
								<ul 
									class="list-group list-group-flush" 
									style="
										margin-top: 10px;
										height: calc(100vh - 480px);
										overflow-y: auto;
										background: whitesmoke;
									"
									id="playlist-container"
								>
								</ul>
							</div>
							<div
								style="
									margin-top: 10px; 
									margin-bottom: 10px;
									border-bottom-left-radius: 5px; 
									border-top-left-radius: 5px;
									height: 170px;
									padding: 5px;
									backdrop-filter: blur(5px);
									-webkit-backdrop-filter: blur(5px);
									background: rgba(0, 0, 0, 0.05);
								"
							>
								<img src="/images/icon_music.png" style="width: 33px; height: 33px;" />
								<div style="width: 100%; text-align: center; margin-top: 15px;">
									<input 
										type="range" 
										class="form-conrtol rangeInput" 
										min="0" 
										max="15" 
										step="1" 
										value="0"
										style="width: 300px;"
									/>
									<div style="display: flex; justify-content: space-between; padding: 10px;">
										<div>00:00</div>
										<div>00:00</div>
									</div>
									<div style="display: flex; justify-content: space-evenly;">
										<div style="line-height: 45px; cursor: pointer;" title="上一曲">
											<i class="fa-solid fa-backward-step"></i>
										</div>
										<div 
											id="playlist-play-pause-btn" 
											style="font-size: 30px; line-height: 45px; cursor: pointer;"
											title="播放"
										>
											<i class="fa-solid fa-play"></i>
										</div>
										<div style="line-height: 45px; cursor: pointer;" title="下一曲">
											<i class="fa-solid fa-forward-step"></i>
										</div>
									</div>
								</div>
								
							</div>
							<div 
								class="d-grid gap-2" 
								style="
									padding: 10px;
									border-top-left-radius: 5px;
									backdrop-filter: blur(5px);
									-webkit-backdrop-filter: blur(5px);
									background: rgba(0, 0, 0, 0.05);
								"
							>
								<button class="btn btn-primary" type="button" title="开始广播">
									开始广播
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		const protocol = window.location.protocol,
			  hostname = window.location.hostname,
			  filesModal = new bootstrap.Modal(document.getElementById("filesModal")), // 文件弹框
			  $filesModalTable = $('#filesModalTable'), // 文件弹框表格
			  domainID = sessionStorage.getItem("domainID"), // 当前机构ID
			  minioBridgePort =  sessionStorage.getItem("minioBridgePort") || "9102"; // 获取minio桥接端口
		let comID = "", // 当前通信ID
			curPlaylist = [], //当前文件播放列表
			breadCrumbFolderList = [], //当前选中文件夹列表-文件弹框
			isPlaying = false, //当前是否正在播放
			selectedPlayAreaList = []; //当前选中的播放区域
			currentFolderKey = ""; //当前文件夹key-文件弹框
		$(document).ready(function() {
			initPage();
			createThingsSelectOptions();
			createSceneSelectOptions();
			createPlaylistDom();
			updatePlayAreaSelectBtnStatus();
			createPlayareaChannelsDom();

			$filesModalTable.bootstrapTable({});
			$filesModalTable.removeClass('table-bordered');
			// 点击添加文件按钮打开文件弹框
			$('#addSourceModalFileBtn').click(function() {
				filesModal.show();
				loadFilesTable("");
			});

			// 文件弹框中点击确认按钮时，隐藏文件弹框并更新音源弹框中的文件列表
			$('#confirmFileBtn').click(function() {
				filesModal.hide();
				const selectedRows = $filesModalTable.bootstrapTable('getSelections');
				curPlaylist = [
					...curPlaylist,
					...selectedRows,
				];
				createPlaylistDom();
			});

			//点击播放按钮时，开始、暂停播放
			$('#playlist-play-pause-btn').click(function() {
				$(this).empty();
				if (isPlaying) {
					const $pauseIcon = $('<i class="fa-solid fa-pause"></i>');
					$(this).append($pauseIcon);
					$(this).attr('title', '暂停');
				} else {
					const $playIcon = $('<i class="fa-solid fa-play"></i>');
					$(this).append($playIcon);
					$(this).attr('title', '播放');
				}
				isPlaying = !isPlaying;
			});

			//点击全选按钮时，全选或取消全选
			$('#play-area-select-unselect-all-btn').click(function() {
				if (selectedPlayAreaList.length) {
					selectedPlayAreaList = [];
				} else {
					selectedPlayAreaList = [1];
				}
				updatePlayAreaSelectBtnStatus();
			});

			//不同类型音量开关切换效果
			$('.volumeFormItemLine').click(function() {
				$(this).toggleClass('selected');
			});

			//设置rangeInput的value值时，改变其背景色
			const rangeInputs = document.querySelectorAll('.rangeInput');
			rangeInputs.forEach(rangeInput => {
				rangeInput.addEventListener('input', () => updateRangeBackground(rangeInput));
				updateRangeBackground(rangeInput); // 初始化背景
			});
		});

		//生成播放区域分区列表dom
		function createPlayareaChannelsDom () {
			const channelList = [
				{
					name: '主通道',
					id: 1,
				},
				{
					name: '副通道',
					id: 2,
				},
				{
					name: '副通道3',
					id: 3,
				},{
					name: '副通道d',
					id: 32,
				},{
					name: '副通道asdfafdafadfafdafdafdafa',
					id: 42,
				},{
					name: '副adfa通道',
					id: 26,
				},{
					name: '副adf通道',
					id: 72,
				},{
					name: 'af副通道',
					id: 82,
				},{
					name: 'adf副通道',
					id: 22,
				},{
					name: 'adf副通道',
					id: 12,
				},{
					name: 'asdf副通道',
					id: 11122,
				},{
					name: '副adf通道',
					id: 122,
				},{
					name: '副通adf道',
					id: 1212,
				},{
					name: '副通道asdf',
					id: 2222,
				},
			];
			const $playareaChannelsContainer = $('#playarea_channels_container');
			$playareaChannelsContainer.empty();
			channelList.forEach(channel => {
				const $channel = $(`
					<div class="hoverCard card" style="height: 100px;">
						<div class="card-body">
							<div class="row">
								<div class="col">
									<img 
										loading="lazy" 
										src="/images/icon_organization_area.svg" 
										class="hoverCardIcon" 
										style="height: 24px;"
									/>
								</div>
								<div class="col">
								</div>
							</div>
							<div class="row">
								<h5 
									class="card-title truncate-text" 
									style="font-size: 15px; font-weight: normal;"
									title="${channel.name}"
								>
									${channel.name}
								</h5>
							</div>
						</div>
					</div>
				`);
				$playareaChannelsContainer.append($channel);
			});
		}

		//更新播放区域全选、反选按钮的状态
		function updatePlayAreaSelectBtnStatus () {
			const $btn = $('#play-area-select-unselect-all-btn');
			$btn.empty();
			if (selectedPlayAreaList.length) {
				$btn.attr('title', '清空选择');
				const $unselectIcon = $(`<i class="fa-solid fa-list"></i>`);
				$btn.append($unselectIcon);
			} else {
				$btn.attr('title', '全选');
				const $selectIcon = $(`<i class="fa-solid fa-list-check"></i>`);
				$btn.append($selectIcon);
			}
		}

		//生成场景下拉框
		function createSceneSelectOptions () {
			$('#sceneSelect').empty();
			for (let i = 1; i <= 6; i++) {
				const $option = $(`<option value="${i}">场景${i}</option>`);
				$('#sceneSelect').append($option);
			}
		}

		//生成调音设备下拉框
		function createThingsSelectOptions () {
			$('#thingsSelect').empty();
			fetch(`/ui/things/thingsInJSON?page=1&limit=1000&onlineStatus=1`, {
				method: "GET",
			})
				.then(response => {
					if (!response.ok) {
						throw new Error('Network response was not ok');
					}
					return response.json(); // 直接将流转换为JSON对象
				})
				.then(json => {
					const data = json.data;
					const thingsData = JSON.parse(data).thingsData;
					const onlineThingsList = thingsData.things && thingsData.things.length ? 
						_.cloneDeep(thingsData.things) : [];
					console.log("onlineThingsList: ", onlineThingsList)
					onlineThingsList.forEach(thing => {
						$option = $(`<option value="${thing.id}">${thing.name}</option>`);
						$('#thingsSelect').append($option);
					});
				});
		}

		// 页面初始化
		function initPage () {
			if (domainID) {
				fetch(`/ui/domains/${domainID}/domainInJSON`, {
					method: "GET",
				})
					.then(response => {
						if (!response.ok) {
						throw new Error('Network response was not ok');
						}
						return response.json(); // 直接将流转换为JSON对象
					})
					.then(json => {
						const data = json.data;
						const domainData = JSON.parse(data).domainData;
						comID = domainData.metadata["comID"];
					});
			} else {
				redirectToLogin();
			}
		}

		//生成播放列表dom
		function createPlaylistDom () {
			$('#playlist-container').empty();
			$('#playlist-delete-all-btn').prop('disabled', true);
			if (curPlaylist.length) {
				curPlaylist.forEach((item, index) => {
					const $item = (`
						<li 
							class="list-group-item" 
							style="
								display: flex; 
								justify-content: space-between;
								background: whitesmoke;
							"
							id="playlist-item-${index}-container"
						>
							<div style="line-height: 38px; width: 100%; display: flex;">
								<img 
									loading="lazy" 
									src="/images/icon_mp3.png" 
									style="
										width: 20px;
										height: 20px;
										margin-top: 8px;
										margin-right: 5px;
									"
								/>
								<div 
									class="text-truncate" 
									style="width: 240px;"
									title="${item.fileName}"
									id="playlist-item-${index}-label" 
								>
									${item.fileName}
								</div>
							</div>
							<button 
								id="playlist-item-${index}-delete-btn" 
								type="button" 
								class="btn btn-light" 
								title="删除"
								style="display: none; color: orangered;"
								onclick="deletePlaylistItem(${index})"
							>
								<i class="fa-solid fa-trash-can"></i>
							</button>
						</li>
					`);
					$('#playlist-container').append($item);
					$(`#playlist-item-${index}-container`).mouseenter(() => {
						$(`#playlist-item-${index}-delete-btn`).show();
						$(`#playlist-item-${index}-label`).css('width', '200px');
					});
					$(`#playlist-item-${index}-container`).mouseleave(() => {
						$(`#playlist-item-${index}-delete-btn`).hide();
						$(`#playlist-item-${index}-label`).css('width', '240px');
					});
				});
				$('#playlist-delete-all-btn').prop('disabled', false);
			}
		}

		//删除播放列表项
		function deletePlaylistItem (index) {
			curPlaylist.splice(index, 1);
			createPlaylistDom();
		}

		//删除播放列表中的所有项
		function deleteAllPlaylistItems () {
			curPlaylist = [];
			createPlaylistDom();
		}

		// 初始化加载文件列表-文件弹框
		function loadFilesTable(folder) {
			$filesModalTable.bootstrapTable('load', []);
			if (!folder) {
				breadCrumbFolderList = [];
				breadCrumbFolderList.push({fileName: "文件列表", key: ""});
				currentFolderKey = "";
				generateBreadCrumb(breadCrumbFolderList);
			}
			const queryData = { path: folder, comID: comID };
			fetch(`${protocol}//${hostname}:${minioBridgePort}/resourceList`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					"Authorization": getCookie('session'),
				},
				body: JSON.stringify(queryData)
			})
				.then(response => {
					if (!response.ok) {
						throw new Error("Network response was not ok");
					}
					return response.json(); // 直接将流转换为JSON对象
				}).then(data => {
					$filesModalTable.bootstrapTable('load', data || []);
				}).catch(error => {
					console.error('Error:', error);
				});
		}

		// 禁用文件夹勾选框-文件弹框
		function fileNameTableStateFormatter(value, row, index) {
			if (row.isDir) {
				return { disabled: true };
			}
			return value;
		}
		
		// 文件名称-文件弹框
		function fileNameTableFormatter(value, row, index) {
			if (row.isDir) {
				return `<div style="cursor: pointer" data-key="${row.key}" data-filename="${row.fileName}" onclick="onClickFolder(event)">
							<img loading="lazy" src="/images/icon_folder.png" style="width: 16px; margin-bottom: 3px;" />
							<span>${value}</span>
						</div>`;
			} else {
				return `<div>
							<img loading="lazy" src="/images/icon_mp3.png" style="width: 16px; margin-bottom: 3px;" />
							<span>${value}</span>
						</div>`;
			}
		}

		//生成面包屑导航-文件弹框
		function generateBreadCrumb(folderList) {
			//监听breadCrumbFolderList变化，更新面包屑导航
			const breadcrumbNavigator = $("#breadcrumbNavigator");
			breadcrumbNavigator.empty();
			folderList.forEach((folder, index) => {
				let activeClass = "";
				if (index === folderList.length - 1) {
					activeClass = "active";
				}
				const li = $(`
					<li 
						class="breadcrumb-item ${activeClass}" 
						data-key="${folder.key}" 
						data-filename="${folder.fileName}" 
						onclick="onClickBreadcrumbItem(event)"
					>
						${folder.fileName}
					</li>
				`);
				breadcrumbNavigator.append(li);
			});
		}

		//点击breadCrumb-文件弹框
		function onClickBreadcrumbItem(e) {
			const key = e.currentTarget.dataset.key;
			currentFolderKey = key;
			//删除后面的所有文件夹
			const rowIndex = breadCrumbFolderList.findIndex(item => item.key === key);
			breadCrumbFolderList.splice(rowIndex + 1, breadCrumbFolderList.length - rowIndex);

			generateBreadCrumb(breadCrumbFolderList);
			loadFilesTable(key);
		}

		//点击文件夹-文件弹框
		function onClickFolder(e) {
			// Use event.currentTarget to get the element that the event listener is attached to
			// event.currentTarget：指向事件监听器所附加的元素，即 <div> 元素。
			// event.target：指向触发事件的实际元素，即 <span> 或 <img> 元素。
			const key = e.currentTarget.dataset.key;
			const fileName = e.currentTarget.dataset.filename;
			currentFolderKey = key;
			breadCrumbFolderList.push({fileName: fileName, key: key});
			generateBreadCrumb(breadCrumbFolderList);
			loadFilesTable(key);
		}
	</script>
</body>
</html>
{{ end }}
