<!-- Copyright (c) Abstract Machines
SPDX-License-Identifier: Apache-2.0 -->

{{ define "broadcast" }}
<!doctype html>
<html lang="en">
<head>
	<title>实时</title>
	{{ template "header" }}
</head>
<body>
	{{ template "navbar" . }}
	<div class="main-content pt-3">
		<div class="container-fluid">
			<div class="row-mb-3 p-3">
				<div class="col-12 mx-auto">
					<!-- 选择文件弹框 -->
					<div 
						class="modal fade" 
						id="filesModal" 
						tabindex="-1" 
						role="dialog" 
						aria-labelledby="filesModalLabel" 
						aria-hidden="true"
						data-bs-backdrop="static" 
						data-bs-keyboard="false"  
					>
						<div class="modal-dialog" role="document">
							<div class="modal-content" style="width: 580px;">
								<div class="modal-header">
									<h1 class="modal-title" id="filesModal">音频文件</h1>
									<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
								</div>
								<div class="modal-body">
									<div class="mb-3">
										<nav>
											<ol class="breadcrumb" id="breadcrumbNavigator" style="margin-left: 5px; margin-bottom: 5px;"></ol>
										</nav>
									</div>
									<div class="mb-3 row modalTableContainer">
										<table 
											id="filesModalTable"
											class="table table-hover"
											data-checkbox-header="true"
											data-click-to-select="true"
										>
											<thead>
												<tr>
													<th data-field="state" data-checkbox="true" data-formatter="fileNameTableStateFormatter"></th>
													<th data-field="fileName" data-formatter="fileNameTableFormatter">文件名</th>
												</tr>
											</thead>
										</table>
									</div>
									<div class="modal-footer">
										<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
											<i class="fa-solid fa-xmark"></i> 取消
										</button>
										<button type="button" class="btn body-button" id="confirmFileBtn">
											<i class="fa-solid fa-floppy-disk"></i> 确定
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- 播放区域选择弹框 -->
					<div 
						class="modal fade" 
						id="playAreasModal" 
						tabindex="-1" 
						role="dialog" 
						aria-labelledby="playAreasModalLabel" 
						aria-hidden="true"
						data-bs-backdrop="static" 
						data-bs-keyboard="false"  
					>
						<div class="modal-dialog" role="document">
							<div class="modal-content" style="width: 580px;">
								<div class="modal-header">
									<h1 class="modal-title" id="playAreasModal">播放通道</h1>
									<button 
										type="button" 
										class="btn-close" 
										data-bs-dismiss="modal" 
										aria-label="Close"
										onclick="closePlayareaSelectModal()"
									></button>
								</div>
								<div class="modal-body">
									<div class="mb-3 row modalTableContainer">
										<table 
											id="playAreasModalTable"
											class="table table-hover"
											data-checkbox-header="true"
											data-click-to-select="false"
										>
											<thead>
												<tr>
													<th data-field="state" data-checkbox="true"></th>
													<th data-field="channelName" data-formatter="channelNameTableFormatter">通道名</th>
												</tr>
											</thead>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="table-responsive table-container broadcast-page">
						<div class="broadcast-page-left-panel">
							<div class="broadcast-page-left-panel-header">
								<div style="display: flex;">
									<div style="width: 110px; line-height: 38px;">调音设备: </div>
									<select class="form-control form-select" id="thingsSelect" placeholder="请选择调音设备"></select>
								</div>
								<div>
									<select class="form-control form-select" id="sceneSelect" placeholder="请选择场景"></select>
								</div>
							</div>
							<div class="broadcast-page-playarea-container">
								<div class="broadcast-page-playarea-header">
									<div>播放区域</div>
									<div
										id="play-area-select-unselect-all-btn" 
										style="color: var(--main-color); cursor: pointer;" 
										title="全选"
									>
										<i class="fa-solid fa-list-check"></i>
									</div>
								</div>
								<div id="broadcast_playarea_channels_container"></div>
							</div>
							<div class="broadcast-page-volume-control-container">
								<div class="broadcast-page-volume-control-header">
									<div class="broadcast_volumeFormItemLine-container">
										<div class="broadcast_volumeFormItemLine"></div>
										<div>线路输入</div>
									</div>
									<div class="broadcast_volumeFormItemLine-container">
										<div class="broadcast_volumeFormItemLine selected"></div>
										<div>麦克风</div>
									</div>
									<div class="broadcast_volumeFormItemLine-container">
										<div class="broadcast_volumeFormItemLine selected"></div>
										<div>文件</div>
									</div>
								</div>
								<div class="broadcast-page-volume-range-container">
									<div class="broadcast_volumeFormItemLine-container">
										<div class="range-wrapper speaker-volume-wrapper" style="background: transparent;">
											<div class="range-value" style="margin-top: 0px; margin-bottom: 205px;">0</div>
											<input
												type="range"
												min="0"
												max="15"
												class="vertical-range rangeInput"
												value="0"
												oninput="updateVerticalRangeValue(this)"
											/>
										</div>
									</div>
									<div class="broadcast_volumeFormItemLine-container">
										<div class="range-wrapper speaker-volume-wrapper" style="background: transparent;">
											<div class="range-value" style="margin-top: 0px; margin-bottom: 205px;">0</div>
											<input
												type="range"
												min="0"
												max="15"
												class="vertical-range rangeInput"
												value="0"
												oninput="updateVerticalRangeValue(this)"
											/>
										</div>
									</div>
									<div class="broadcast_volumeFormItemLine-container">
										<div class="range-wrapper speaker-volume-wrapper" style="background: transparent;">
											<div class="range-value" style="margin-top: 0px; margin-bottom: 205px;">0</div>
											<input
												type="range"
												min="0"
												max="15"
												class="vertical-range rangeInput"
												value="0"
												oninput="updateVerticalRangeValue(this)"
											/>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="broadcast-page-right-panel">
							<div class="broadcast-page-playlist">
								<div class="broadcast-page-playlist-header">
									<div class="broadcast-page-playlist-header-label">播放列表</div>
									<div class="btn-group" role="group">
										<button 
											id="playlist-delete-all-btn" 
											type="button" 
											class="btn btn-light" 
											title="清空列表" 
											disabled
											onclick="deleteAllPlaylistItems()"
										>
											<i class="fa-solid fa-trash-can"></i>
										</button>
										<button type="button" class="btn btn-light" title="添加文件" id="addSourceModalFileBtn">
											<i class="fa-solid fa-plus"></i>
										</button>
									</div>
								</div>
								<ul class="list-group list-group-flush broadcast-page-playlist-container" id="playlist-container"></ul>
							</div>
							<div class="broadcast-page-player-contol-container">
								<img src="/images/icon_music.png" class="broadcast-page-player-contol-icon" />
								<div class="broadcast-page-player-contol">
									<input 
										type="range" 
										class="form-conrtol rangeInput" 
										min="0" 
										max="15" 
										step="1" 
										value="0"
										style="width: 300px;"
									/>
									<div class="broadcast-page-player-contol-time-label">
										<div>00:00</div>
										<div>00:00</div>
									</div>
									<div class="broadcast-page-player-contol-buttons">
										<div id="playlist-play-prev-btn" title="上一曲">
											<i class="fa-solid fa-backward-step"></i>
										</div>
										<div id="playlist-play-pause-btn" title="播放">
											<i class="fa-solid fa-play"></i>
										</div>
										<div id="playlist-play-next-btn" title="下一曲">
											<i class="fa-solid fa-forward-step"></i>
										</div>
									</div>
								</div>
							</div>
							<div class="d-grid gap-2 broadcast-page-broadcast-btn-container">
								<button class="btn btn-primary" type="button" title="开始广播">
									开始广播
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		const protocol = window.location.protocol,
			  hostname = window.location.hostname,
			  filesModal = new bootstrap.Modal(document.getElementById("filesModal")), // 文件弹框
			  $filesModalTable = $('#filesModalTable'), // 文件弹框表格
			  playAreasModal = new bootstrap.Modal(document.getElementById("playAreasModal")), // 播放区域弹框
			  $playAreasModalTable = $('#playAreasModalTable'), // 播放区域弹框表格
			  domainID = sessionStorage.getItem("domainID"), // 当前机构ID
			  minioBridgePort =  sessionStorage.getItem("minioBridgePort") || "9102"; // 获取minio桥接端口
		let comID = "", // 当前通信ID
			curPlaylist = [], //当前文件播放列表
			breadCrumbFolderList = [], //当前选中文件夹列表-文件弹框
			isPlaying = false, //当前是否正在播放
			selectedPlayAreaList = [], //当前选中的播放区域
			playAreaTreeData = [], // 播放区域树数据
			allThingsList = [], // 所有设备列表
			currentFolderKey = ""; //当前文件夹key-文件弹框
		$(document).ready(function() {
			initPage();
			createThingsSelectOptions();
			createSceneSelectOptions();
			createPlaylistDom();
			updatePlayAreaSelectBtnStatus();
			getPlayAreaTree();

			$filesModalTable.bootstrapTable({});
			$filesModalTable.removeClass('table-bordered');
			$playAreasModalTable.bootstrapTable({
				selectItemName: 'selectedRows',
				onCheck: function(row, $element) {
					selectedPlayAreaList.push(row);
					selectedPlayAreaList = _.uniqBy(selectedPlayAreaList, 'id');
				},
				onUncheck: function(row, $element) {
					selectedPlayAreaList = selectedPlayAreaList.filter(item => item.id !== row.id);
				},
				onCheckAll: function(e) {
					selectedPlayAreaList = [
						...selectedPlayAreaList,
						...$playAreasModalTable.bootstrapTable('getData'),
					];
					selectedPlayAreaList = _.uniqBy(selectedPlayAreaList, 'id');
				},
				onUncheckAll: function(e) {
					selectedPlayAreaList = selectedPlayAreaList.filter(itemA => 
						!$playAreasModalTable.bootstrapTable('getData').some(itemB => itemB.id === itemA.id)
					);
				}
			});
			$playAreasModalTable.removeClass('table-bordered');

			//点击全选按钮时，全选或取消全选
			$('#play-area-select-unselect-all-btn').click(function() {
				if (selectedPlayAreaList.length) {
					selectedPlayAreaList = [];
				} else {
					selectedPlayAreaList = _.cloneDeep(allThingsList);
				}
				updatePlayAreaSelectBtnStatus();
			});

			// 点击添加文件按钮打开文件弹框
			$('#addSourceModalFileBtn').click(function() {
				filesModal.show();
				loadFilesTable("");
			});

			// 文件弹框中点击确认按钮时，隐藏文件弹框并更新音源弹框中的文件列表
			$('#confirmFileBtn').click(function() {
				filesModal.hide();
				const selectedRows = $filesModalTable.bootstrapTable('getSelections');
				curPlaylist = [
					...curPlaylist,
					...selectedRows,
				];
				createPlaylistDom();
			});

			//点击播放按钮时，开始、暂停播放
			$('#playlist-play-pause-btn').click(function() {
				$(this).empty();
				if (isPlaying) {
					const $pauseIcon = $('<i class="fa-solid fa-pause"></i>');
					$(this).append($pauseIcon);
					$(this).attr('title', '暂停');
				} else {
					const $playIcon = $('<i class="fa-solid fa-play"></i>');
					$(this).append($playIcon);
					$(this).attr('title', '播放');
				}
				isPlaying = !isPlaying;
			});

			//不同类型音量开关切换效果
			$('.broadcast_volumeFormItemLine').click(function() {
				$(this).toggleClass('selected');
			});

			//设置rangeInput的value值时，改变其背景色
			const rangeInputs = document.querySelectorAll('.rangeInput');
			rangeInputs.forEach(rangeInput => {
				rangeInput.addEventListener('input', () => updateRangeBackground(rangeInput));
				updateRangeBackground(rangeInput); // 初始化背景
			});
		});

		// 获取组装播放区域设备树
		function getPlayAreaTree() {
			playAreaTreeData = [{
				id: "root",
				key: 'group_root',
				text: "全部",
				flagUrl: null,
				children: [
					{
						id: "unassigned",
						key: "group_unassigned",
						text: "未分区",
						flagUrl: "/images/icon_organization_area.svg",
						metadata: {
							"thing_ids": []
						},
						children: []
					},
				]
			}];
			allThingsList = [];
			// 获取所有设备
			fetch(`/ui/things/thingsInJSON?page=1&limit=1000&onlineStatus=2`, {
				method: "GET",
			})
				.then(response => {
					if (!response.ok) {
						throw new Error('Network response was not ok');
					}
					return response.json(); // 直接将流转换为JSON对象
				})
				.then(json => {
					const data = json.data;
					const thingsData = JSON.parse(data).thingsData;
					const things = thingsData.things;
					if (things.length) {
						allThingsList = things.map((thing) => thing);
					}
					// 获取所有分区
					fetch(`/ui/channels/channelsInJSON?page=1&limit=1000`, {
						method: "GET",
					})
						.then((response) => {
							if (!response.ok) {
								throw new Error("Network response was not ok");
							}
							return response.json(); // 直接将流转换为JSON对象
						})
						.then((json) => {
							const data = json.data;
							const channelsData = JSON.parse(data).channelsData;
							const channels = channelsData.groups;
							if (channels.length) {
								channels.forEach((channel) => {
									const channelNode = {
										id: channel.id,
										text: channel.name,
										name: channel.name,
										key: `group_${channel.id}`,
										flagUrl: "/images/icon_organization_area.svg",
										metadata: channel.metadata,
										children: channel.metadata && 
											channel.metadata.thing_ids && 
											channel.metadata.thing_ids.length ? 
												channel.metadata.thing_ids.map((thingId) => {
													const targetThing = allThingsList.find((thing) => thingId === thing.id);
													if (targetThing && targetThing.id) {
														return {
															id: targetThing.id,
															text: targetThing.metadata.aliase,
															name: targetThing.name,
															key: `${targetThing.id}`,
															flagUrl: "/images/icon_channel.png",
															metadata: targetThing.metadata,
														}
													} else {
														return {}
													}
												}).filter((thing)=>thing.id) : [],
									};
									playAreaTreeData[0].children.push(channelNode);
								});
								// 获取所有已连接分区的设备ID
								const allConnectedThingsID = [...new Set(channels.flatMap(channel => {
									// 检查 channel.metadata 是否存在以及 channel.metadata.thing_ids 是否存在
									if (channel.metadata && Array.isArray(channel.metadata.thing_ids)) {
										return channel.metadata.thing_ids;
									} else {
										// 如果不存在，返回一个空数组，不会影响 flatMap 的结果
										return [];
									}
								}))];
								// 获取所有未连接分区的设备
								const allUnconnectedThings = allThingsList.filter((thing) => !allConnectedThingsID.includes(thing.id)); 
								// 未分区
								allUnconnectedThings.forEach((thing) => {
									const thingNode = {
										id: thing.id,
										text: thing.metadata.aliase,
										name: thing.name,
										key: `${thing.id}`,
										flagUrl: "/images/icon_channel.png",
										metadata: thing.metadata,
									};
									playAreaTreeData[0].children[0].children.push(thingNode);
								});
							} else {
								//没有分区时，所有设备都属于未分区
								allThingsList.forEach((thing) => {
									const thingNode = {
										id: thing.id,
										text: thing.metadata.aliase,
										name: thing.name,
										key: `${thing.id}`,
										flagUrl: "/images/icon_channel.png",
										metadata: thing.metadata,
									};
									playAreaTreeData[0].children[0].children.push(thingNode);
								});
							}
							createPlayareaChannelsDom();
						});
				})
				.catch(error => {});
		}

		//生成播放区域分区列表dom
		function createPlayareaChannelsDom () {
			const $playareaChannelsContainer = $('#broadcast_playarea_channels_container');
			$playareaChannelsContainer.empty();
			playAreaTreeData[0]?.children.forEach(channel => {
				const $channel = $(`
					<div 
						class="hoverCard card" 
						style="height: 100px;" 
						data-channel_id="${channel.id}"
						id="channel-card-${channel.id}"
					>
						<div class="card-body">
							<div class="row">
								<div class="col">
									<img 
										loading="lazy" 
										src="/images/icon_organization_area.svg" 
										class="hoverCardIcon" 
										style="height: 24px;"
									/>
								</div>
								<div class="col" style="text-align: right;" onclick="event.stopPropagation()">
									<input 
										class="form-check-input" 
										type="checkbox" 
										value="" 
										id="channel_checkbox_${channel.id}"
									/>
								</div>
							</div>
							<div class="row">
								<h5 
									class="card-title truncate-text" 
									style="font-size: 15px; font-weight: normal;"
									title="${channel.text}"
								>
									${channel.text}
								</h5>
							</div>
						</div>
					</div>
				`);
				$playareaChannelsContainer.append($channel);
				//点击分区
				$(`#channel-card-${channel.id}`).click(function (event) {
					openPlayareaSelectModal(channel);
				});

				//更新分区选中状态
				const selectedThingsInChannel = selectedPlayAreaList.filter(item1 => 
					channel.children?.some(item2 => item2.id === item1.id)
				);
				const channelCheckbox = $(`#channel_checkbox_${channel.id}`);
				channelCheckbox.change(function () {
					if (channel.children?.length) {
						const checked = $(this).is(':checked');
						if (checked) {
							selectedPlayAreaList = [
								...selectedPlayAreaList,
								...channel.children,
							];
							selectedPlayAreaList = _.uniqBy(selectedPlayAreaList, 'id');
						} else {
							selectedPlayAreaList = selectedPlayAreaList.filter(itemA => 
								!channel.children.some(itemB => itemB.id === itemA.id)
							);
						}
						updatePlayAreaSelectBtnStatus();
						createPlayareaChannelsDom();
					}
				});
				channelCheckbox.prop("indeterminate", false);
				channelCheckbox.prop("checked", false);
				if (channel.children?.length) {
					channelCheckbox.prop("disabled", false);
					if (selectedThingsInChannel.length) {
						if (selectedThingsInChannel.length === channel.children?.length) {
							channelCheckbox.prop("indeterminate", false);
							channelCheckbox.prop("checked", true);
						} else {
							channelCheckbox.prop("indeterminate", true);
							channelCheckbox.prop("checked", false);
						}
					}
				} else {
					channelCheckbox.prop("disabled", true);
				}
			});
		}

		//打开播放区域选择弹窗
		function openPlayareaSelectModal (channel) {
			$playAreasModalTable.bootstrapTable('load', []);
			if (channel.children?.length) {
				playAreasModal.show();
				$playAreasModalTable.bootstrapTable('load', channel.children);
				//选中已选择的设备
				const selectedThingsInChannel = selectedPlayAreaList.filter(item1 => 
					channel.children?.some(item2 => item2.id === item1.id)
				);
				if (selectedThingsInChannel.length) {
					if (selectedThingsInChannel.length === channel.children?.length) {
						$playAreasModalTable.bootstrapTable('checkAll');
					} else {
						selectedThingsInChannel.forEach(thing => {
							const index = channel.children.findIndex(item => item.id === thing.id);
							$playAreasModalTable.bootstrapTable('check', index);
						});
					}
				} else {
					$playAreasModalTable.bootstrapTable('uncheckAll');
				}
			} else {
				showAlert('warning', `此分区没有设备`);
			}
		}

		//关闭播放区域选择弹窗
		function closePlayareaSelectModal () {
			playAreasModal.hide();
			createPlayareaChannelsDom();
			updatePlayAreaSelectBtnStatus();
		}

		//更新播放区域全选、反选按钮的状态
		function updatePlayAreaSelectBtnStatus () {
			const $btn = $('#play-area-select-unselect-all-btn');
			$btn.empty();
			if (selectedPlayAreaList.length) {
				$btn.attr('title', '清空选择');
				const $unselectIcon = $(`<i class="fa-solid fa-list"></i>`);
				$btn.append($unselectIcon);
			} else {
				$btn.attr('title', '全选');
				const $selectIcon = $(`<i class="fa-solid fa-list-check"></i>`);
				$btn.append($selectIcon);
			}
			createPlayareaChannelsDom();
		}

		// 通道名称-播放弹框
		function channelNameTableFormatter (value, row, index) {
			let imageSrc = '/images/icon_channel_offline.png';
			if (row.metadata.is_online === "1") {
				imageSrc = '/images/icon_channel.png';
			}
			return `<div>
						<img loading="lazy" src="${imageSrc}" style="width: 16px; margin-bottom: 3px;" />
						<span>${row.metadata.aliase}</span>
					</div>`;
		}

		//生成场景下拉框
		function createSceneSelectOptions () {
			$('#sceneSelect').empty();
			for (let i = 1; i <= 6; i++) {
				const $option = $(`<option value="${i}">场景${i}</option>`);
				$('#sceneSelect').append($option);
			}
		}

		//生成调音设备下拉框
		function createThingsSelectOptions () {
			$('#thingsSelect').empty();
			fetch(`/ui/things/thingsInJSON?page=1&limit=1000&onlineStatus=1`, {
				method: "GET",
			})
				.then(response => {
					if (!response.ok) {
						throw new Error('Network response was not ok');
					}
					return response.json(); // 直接将流转换为JSON对象
				})
				.then(json => {
					const data = json.data;
					const thingsData = JSON.parse(data).thingsData;
					const onlineThingsList = thingsData.things && thingsData.things.length ? 
						_.cloneDeep(thingsData.things) : [];
					onlineThingsList.forEach(thing => {
						$option = $(`<option value="${thing.id}">${thing.name}</option>`);
						$('#thingsSelect').append($option);
					});
				});
		}

		// 页面初始化
		function initPage () {
			if (domainID) {
				fetch(`/ui/domains/${domainID}/domainInJSON`, {
					method: "GET",
				})
					.then(response => {
						if (!response.ok) {
						throw new Error('Network response was not ok');
						}
						return response.json(); // 直接将流转换为JSON对象
					})
					.then(json => {
						const data = json.data;
						const domainData = JSON.parse(data).domainData;
						comID = domainData.metadata["comID"];
					});
			} else {
				redirectToLogin();
			}
		}

		//生成播放列表dom
		function createPlaylistDom () {
			$('#playlist-container').empty();
			$('#playlist-delete-all-btn').prop('disabled', true);
			if (curPlaylist.length) {
				curPlaylist.forEach((item, index) => {
					const $item = (`
						<li 
							class="list-group-item" 
							style="
								display: flex; 
								justify-content: space-between;
								background: whitesmoke;
							"
							id="playlist-item-${index}-container"
						>
							<div style="line-height: 38px; width: 100%; display: flex;">
								<img 
									loading="lazy" 
									src="/images/icon_mp3.png" 
									style="
										width: 20px;
										height: 20px;
										margin-top: 8px;
										margin-right: 5px;
									"
								/>
								<div 
									class="text-truncate" 
									style="width: 240px;"
									title="${item.fileName}"
									id="playlist-item-${index}-label" 
								>
									${item.fileName}
								</div>
							</div>
							<button 
								id="playlist-item-${index}-delete-btn" 
								type="button" 
								class="btn btn-light" 
								title="删除"
								style="display: none; color: orangered;"
								onclick="deletePlaylistItem(${index})"
							>
								<i class="fa-solid fa-trash-can"></i>
							</button>
						</li>
					`);
					$('#playlist-container').append($item);
					$(`#playlist-item-${index}-container`).mouseenter(() => {
						$(`#playlist-item-${index}-delete-btn`).show();
						$(`#playlist-item-${index}-label`).css('width', '200px');
					});
					$(`#playlist-item-${index}-container`).mouseleave(() => {
						$(`#playlist-item-${index}-delete-btn`).hide();
						$(`#playlist-item-${index}-label`).css('width', '240px');
					});
				});
				$('#playlist-delete-all-btn').prop('disabled', false);
			}
		}

		//删除播放列表项
		function deletePlaylistItem (index) {
			curPlaylist.splice(index, 1);
			createPlaylistDom();
		}

		//删除播放列表中的所有项
		function deleteAllPlaylistItems () {
			curPlaylist = [];
			createPlaylistDom();
		}

		// 初始化加载文件列表-文件弹框
		function loadFilesTable(folder) {
			$filesModalTable.bootstrapTable('load', []);
			if (!folder) {
				breadCrumbFolderList = [];
				breadCrumbFolderList.push({fileName: "文件列表", key: ""});
				currentFolderKey = "";
				generateBreadCrumb(breadCrumbFolderList);
			}
			const queryData = { path: folder, comID: comID };
			fetch(`${protocol}//${hostname}:${minioBridgePort}/resourceList`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					"Authorization": getCookie('session'),
				},
				body: JSON.stringify(queryData)
			})
				.then(response => {
					if (!response.ok) {
						throw new Error("Network response was not ok");
					}
					return response.json(); // 直接将流转换为JSON对象
				}).then(data => {
					$filesModalTable.bootstrapTable('load', data || []);
				}).catch(error => {
					console.error('Error:', error);
				});
		}

		// 禁用文件夹勾选框-文件弹框
		function fileNameTableStateFormatter(value, row, index) {
			if (row.isDir) {
				return { disabled: true };
			}
			return value;
		}

		// 文件名称-文件弹框
		function fileNameTableFormatter(value, row, index) {
			if (row.isDir) {
				return `<div style="cursor: pointer" data-key="${row.key}" data-filename="${row.fileName}" onclick="onClickFolder(event)">
							<img loading="lazy" src="/images/icon_folder.png" style="width: 16px; margin-bottom: 3px;" />
							<span>${value}</span>
						</div>`;
			} else {
				return `<div>
							<img loading="lazy" src="/images/icon_mp3.png" style="width: 16px; margin-bottom: 3px;" />
							<span>${value}</span>
						</div>`;
			}
		}

		//生成面包屑导航-文件弹框
		function generateBreadCrumb(folderList) {
			//监听breadCrumbFolderList变化，更新面包屑导航
			const breadcrumbNavigator = $("#breadcrumbNavigator");
			breadcrumbNavigator.empty();
			folderList.forEach((folder, index) => {
				let activeClass = "";
				if (index === folderList.length - 1) {
					activeClass = "active";
				}
				const li = $(`
					<li 
						class="breadcrumb-item ${activeClass}" 
						data-key="${folder.key}" 
						data-filename="${folder.fileName}" 
						onclick="onClickBreadcrumbItem(event)"
					>
						${folder.fileName}
					</li>
				`);
				breadcrumbNavigator.append(li);
			});
		}

		//点击breadCrumb-文件弹框
		function onClickBreadcrumbItem(e) {
			const key = e.currentTarget.dataset.key;
			currentFolderKey = key;
			//删除后面的所有文件夹
			const rowIndex = breadCrumbFolderList.findIndex(item => item.key === key);
			breadCrumbFolderList.splice(rowIndex + 1, breadCrumbFolderList.length - rowIndex);

			generateBreadCrumb(breadCrumbFolderList);
			loadFilesTable(key);
		}

		//点击文件夹-文件弹框
		function onClickFolder(e) {
			// Use event.currentTarget to get the element that the event listener is attached to
			// event.currentTarget：指向事件监听器所附加的元素，即 <div> 元素。
			// event.target：指向触发事件的实际元素，即 <span> 或 <img> 元素。
			const key = e.currentTarget.dataset.key;
			const fileName = e.currentTarget.dataset.filename;
			currentFolderKey = key;
			breadCrumbFolderList.push({fileName: fileName, key: key});
			generateBreadCrumb(breadCrumbFolderList);
			loadFilesTable(key);
		}
	</script>
</body>
</html>
{{ end }}
