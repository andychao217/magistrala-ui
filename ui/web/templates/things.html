<!-- Copyright (c) Abstract Machines
SPDX-License-Identifier: Apache-2.0 -->

{{ define "things" }}
    <!doctype html>
    <html lang="en">
        <head>
            <title>设备</title>
            {{ template "header" }}
        </head>

        <body>
            {{ template "navbar" . }}
            <div class="main-content pt-3">
                <div class="container-fluid">
                    <div class="row-mb-3 p-3">
                        <div class="col-lg-12 mx-auto">
                            <div class="row">
                                <div class="buttons">
                                    <!-- edit thing modal -->
                                    <div 
										class="modal fade" 
										id="editThingModal" 
										tabindex="-1" 
										role="dialog" 
										aria-labelledby="editThingModalLabel" 
										data-bs-backdrop="static" 
										data-bs-keyboard="false" 
										aria-hidden="true"
                                    >
										<div class="modal-dialog" role="document">
											<div class="modal-content">
												<div class="modal-header">
													<h1 class="modal-title" id="editThingModalLabel">修改设备</h1>
													<button 
														type="button" 
														class="btn-close" 
														data-bs-dismiss="modal" 
														aria-label="Close" 
														onclick="
															$('#deviceNameEditThingModal').attr('data-id', '');
															$('#deviceNameEditThingModal').attr('data-name', '');
														"
													></button>
												</div>
												<form id="editThingform">
													<div class="modal-body" style="padding: 35px;">
														<div class="mb-3 row">
															<label for="name" class="col-sm-3 col-form-label">名称</label>
															<div class="col-sm-9">
																<input 
																	type="text" 
																	class="form-control name-field" 
																	name="name" 
																	id="deviceNameEditThingModal" 
																	placeholder="设备名称" 
																	maxlength="20" 
																/>
																<div 
																	id="deviceNameErrorEditThingModal" 
																	class="text-danger" 
																	style="margin-top: 10px; color: orangered;"
																></div>
															</div>
														</div>
														<div id="out_channels_container_EditThingModal"></div>
														<div class="mb-3 row" style="margin-bottom: 0px !important;">
															<div class="col-sm-12" style="text-align: center;">
																<div id="moreSettingEditThingModal" class="moreSettingBtn">
																	<i class="fa-solid fa-chevron-down"></i>
																</div>
															</div>
														</div>
													</div>
												</form>
											</div>
										</div>
                                    </div>

									<!-- 设备配置弹框 -->
									<div 
										class="modal fade" 
										id="moreEditThingModal" 
										tabindex="-1" 
										role="dialog" 
										aria-labelledby="moreEditThingModalLabel" 
										data-bs-backdrop="static" 
										data-bs-keyboard="false" 
										aria-hidden="true"
									>
										<div class="modal-dialog" role="document">
											<div class="modal-content">
												<div class="modal-header">
													<h1 class="modal-title" id="moreEditThingModalLabel">
														<span>设备配置</span>
														(<span id="deviceNameTitleMoreEditThingModal"></span>)
													</h1>
													<button 
														type="button" 
														class="btn-close" 
														data-bs-dismiss="modal" 
														aria-label="Close"
														onclick="editThingModal.show()"
													></button>
												</div>
												<div class="modal-body" style="padding: 0px;">
													<div class="d-flex align-items-start">
														<div 
															class="nav flex-column nav-pills" 
															id="v-pills-tab" 
															role="tablist" 
															aria-orientation="vertical"
														>
															<button 
																class="nav-link active" 
																id="v-pills-home-tab" 
																data-bs-toggle="pill" 
																data-bs-target="#v-pills-home" 
																type="button" 
																role="tab" 
																aria-controls="v-pills-home" 
																aria-selected="true"
															>
																Home
															</button>
															<button 
																class="nav-link" 
																id="v-pills-profile-tab" 
																data-bs-toggle="pill" 
																data-bs-target="#v-pills-profile" 
																type="button" 
																role="tab" 
																aria-controls="v-pills-profile" 
																aria-selected="false"
															>
																Profile
															</button>
															<button 
																class="nav-link" 
																id="v-pills-messages-tab" 
																data-bs-toggle="pill" 
																data-bs-target="#v-pills-messages" 
																type="button" 
																role="tab" 
																aria-controls="v-pills-messages" 
																aria-selected="false"
															>
																Messages
															</button>
															<button 
																class="nav-link" 
																id="v-pills-settings-tab" 
																data-bs-toggle="pill" 
																data-bs-target="#v-pills-settings" 
																type="button" 
																role="tab" 
																aria-controls="v-pills-settings" 
																aria-selected="false"
															>
																Settings
															</button>
														</div>
														<div class="tab-content" id="v-pills-tabContent" style="border-left: thin solid lightgray; padding: 0px 20px;">
															<div 
																class="tab-pane fade show active" 
																id="v-pills-home" 
																role="tabpanel" 
																aria-labelledby="v-pills-home-tab" 
																tabindex="0"
															>
																...
															</div>
															<div 
																class="tab-pane fade" 
																id="v-pills-profile" 
																role="tabpanel" 
																aria-labelledby="v-pills-profile-tab" 
																tabindex="0"
															>
																...
															</div>
															<div 
																class="tab-pane fade" 
																id="v-pills-messages" 
																role="tabpanel" 
																aria-labelledby="v-pills-messages-tab" 
																tabindex="0"
															>
																...
															</div>
															<div 
																class="tab-pane fade" 
																id="v-pills-settings" 
																role="tabpanel" 
																aria-labelledby="v-pills-settings-tab" 
																tabindex="0"
															>
																...
															</div>
														</div>
													  </div>
												</div>
											</div>
										</div>
									</div>

                                    <!-- 扫描添加设备弹框 -->
                                    <div 
										class="modal fade" 
										id="scanThingsModal" 
										tabindex="-1" 
										role="dialog" 
										aria-labelledby="scanThingsModalLabel" 
										data-bs-backdrop="static" 
										data-bs-keyboard="false" 
										aria-hidden="true"
                                    >
										<div class="modal-dialog" role="document">
											<div class="modal-content">
												<div class="modal-header">
													<h1 class="modal-title" id="scanThingsModalLabel">添加设备</h1>
													<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
												</div>
												<div class="modal-body">
													<div class="row">
													<ul class="list-group" id="scanThingsGrid" style="padding-left: 10px; max-height: 400px; overflow-y: auto;">
													</ul>
													</div>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
													<button type="button" class="btn body-button" id="scan-add-thing-button" disabled>添加设备</button>
												</div>
											</div>
										</div>
                                    </div>

                                    <div 
										class="modal fade" 
										id="deviceNetCfgModal" 
										tabindex="-1" 
										role="dialog" 
										aria-labelledby="deviceNetCfgModalLabel" 
										data-bs-backdrop="static" 
										data-bs-keyboard="false" 
										aria-hidden="true"
                                    >
										<div class="modal-dialog" role="document">
											<div class="modal-content">
												<div class="modal-header">
													<h1 class="modal-title" id="scanThingsModalLabel">设备设置</h1>
													<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
												</div>
												<div class="modal-body">
												<div class="mb-3">
													<label for="alias" class="form-label">设备名称</label>
													<input type="text" class="form-control" name="alias" id="alias-deviceNetCfg" placeholder="设备名称" maxlength="20" />
													<div id="aliasError" class="text-danger"></div>
												</div>
												<div class="mb-3">
													<label for="dhcp_enable" class="form-label">设置IP</label>
													<select class="form-control" name="dhcp_enable" id="dhcp_enable-deviceNetCfg">
														<option value="0">手动</option>
														<option value="1">自动</option>
													</select>
												</div>
												<div class="mb-3">
													<label for="ip" class="form-label">IP地址</label>
													<input type="text" class="form-control" name="ip" id="ip-deviceNetCfg" placeholder="IP地址" />
													<div id="ipError" class="text-danger"></div>
												</div>
												<div class="mb-3">
													<label for="gateway" class="form-label">网关</label>
													<input type="text" class="form-control" name="gateway" id="gateway-deviceNetCfg" placeholder="网关" />
													<div id="gatewayError" class="text-danger"></div>
												</div>
												<div class="mb-3">
													<label for="netmask" class="form-label">子网掩码</label>
													<input type="text" class="form-control" name="netmask" id="netmask-deviceNetCfg" placeholder="子网掩码" />
													<div id="netmaskError" class="text-danger"></div>
												</div>
												<div class="mb-3">
													<label for="dns1" class="form-label">主DNS</label>
													<input type="text" class="form-control" name="dns1" id="dns1-deviceNetCfg" placeholder="主DNS" />
													<div id="dns1Error" class="text-danger"></div>
												</div>
												<div class="mb-3">
													<label for="dns2" class="form-label">从DNS</label>
													<input type="text" class="form-control" name="dns2" id="dns2-deviceNetCfg" placeholder="从DNS" />
													<div id="dns2Error" class="text-danger"></div>
												</div>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
													<button type="button" class="btn body-button" id="deviceNetCfgModal-confirm-button">
														确定
													</button>
												</div>
											</div>
										</div>
                                    </div>
                                </div>
                                <div class="table-responsive table-container">
									<div class="row buttons mb-3">
										<div class="col-4" role="group">
											<button type="button" class="btn body-button" onclick="openModal('scan')">
												<i class="fa-solid fa-plus"></i> 添加设备
											</button>
										</div>
										<div class="btn-group col-4" role="group">
											<input type="radio" class="btn-check" name="btnOnlineStatus" id="btnAll" autocomplete="off" />
											<label class="btn btn-outline-primary" for="btnAll">全部</label>
											
											<input type="radio" class="btn-check" name="btnOnlineStatus" id="btnOnline" autocomplete="off" />
											<label class="btn btn-outline-primary" for="btnOnline">在线</label>
											
											<input type="radio" class="btn-check" name="btnOnlineStatus" id="btnOffline" autocomplete="off" />
											<label class="btn btn-outline-primary" for="btnOffline">离线</label>
										</div>
									</div>
									<div class="row" id="thingsGrid">
										{{ range $i, $t := .Things }}
										<div class="col-sm-3 mb-3 mb-sm-0" id="{{ $t.ID }}-thingCard">
											<div 
												class="hoverCard card"  
												id="{{ $t.ID }}-thingCardContent"
												{{ if $t.Metadata.is_online }}
													{{ if eq $t.Metadata.is_online "1" }}
													style="background: white;"
													{{ else }}
													style="background: lightgray;"
													{{ end }}
												{{ end }}
											>
											<div class="card-body">
												<div class="row">
												<div class="col">
													{{ if $t.Metadata.product_name }}
														{{ if stringContains $t.Metadata.product_name "2204" }}
															<img id="{{ $t.ID }}-thingIcon" src="/images/icon_device1.svg" class="hoverCardIcon">
														{{ else if stringContains $t.Metadata.product_name "2200" }}
															<img id="{{ $t.ID }}-thingIcon" src="/images/icon_device1.svg" class="hoverCardIcon">
														{{ else if stringContains $t.Metadata.product_name "2201" }}
															<img id="{{ $t.ID }}-thingIcon" src="/images/icon_device1.svg" class="hoverCardIcon">
														{{ else if stringContains $t.Metadata.product_name "2102" }}
															<img id="{{ $t.ID }}-thingIcon" src="/images/icon_device2.svg" class="hoverCardIcon">
														{{ else if stringContains $t.Metadata.product_name "2110" }}
															<img id="{{ $t.ID }}-thingIcon" src="/images/icon_device2.svg" class="hoverCardIcon">
														{{ else if stringContains $t.Metadata.product_name "2112" }}
															<img id="{{ $t.ID }}-thingIcon" src="/images/icon_device2.svg" class="hoverCardIcon">
														{{ else if stringContains $t.Metadata.product_name "3302" }}
															<img id="{{ $t.ID }}-thingIcon" src="/images/icon_device3.svg" class="hoverCardIcon">
														{{ else if stringContains $t.Metadata.product_name "2001" }}
															<img id="{{ $t.ID }}-thingIcon" src="/images/icon_device4.svg" class="hoverCardIcon">
														{{ else if stringContains $t.Metadata.product_name "2011" }}
															<img id="{{ $t.ID }}-thingIcon" src="/images/icon_device4.svg" class="hoverCardIcon">
														{{ else if stringContains $t.Metadata.product_name "3401" }}
															<img id="{{ $t.ID }}-thingIcon" src="/images/icon_device5.svg" class="hoverCardIcon">
														{{ else if stringContains $t.Metadata.product_name "2401" }}
															<img id="{{ $t.ID }}-thingIcon" src="/images/icon_device5.svg" class="hoverCardIcon">
														{{ else if stringContains $t.Metadata.product_name "3602" }}
															<img id="{{ $t.ID }}-thingIcon" src="/images/icon_device8.svg" class="hoverCardIcon">
														{{ else }}
															<img id="{{ $t.ID }}-thingIcon" src="/images/icon_device0.svg" class="hoverCardIcon">
														{{ end }}
													{{ end }}
												</div>
												<div class="col">
													<div class="dropdown" style="float: right;">
													<button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
														<i class="fa-solid fa-ellipsis"></i>
													</button>
													<ul class="dropdown-menu">
														<li style="display: none;">
															<a class="dropdown-item" onclick="viewThing('{{ $t.ID }}', '{{ $t.Credentials.Identity }}')">
																<i class="fa-solid fa-info" style="width: 16px;"></i> 查看
															</a>
														</li>
														<li
															id="{{ $t.ID }}-rebootBtn"
															{{ if $t.Metadata.is_online }}
																{{ if eq $t.Metadata.is_online "1" }}
																style="display: block;"
																{{ else }}
																style="display: none;"
																{{ end }}
															{{ end }}
														>
															<a class="dropdown-item" onclick="rebootThing('{{ $t.Credentials.Identity }}')">
																<i class="fa-solid fa-arrows-rotate" style="width: 16px;"></i> 重启
															</a>
														</li>
														<li 
															id="{{ $t.ID }}-editBtn"
															{{ if $t.Metadata.is_online }}
																{{ if eq $t.Metadata.is_online "1" }}
																style="display: block;"
																{{ else }}
																style="display: none;"
																{{ end }}
															{{ end }}
														>
															<a class="dropdown-item" onclick="editThing('{{ $t.ID }}')">
																<i class="fa-solid fa-pencil-alt" style="width: 16px;"></i> 修改
															</a>
														</li>
														<li id="{{ $t.ID }}-deleteBtn">
															<a class="dropdown-item" onclick="deleteThing('{{ $t.ID }}')" >
																<i class="fa-solid fa-trash-can" style="width: 16px;"></i> 删除
															</a>
														</li>
													</ul>
													</div>
												</div>
												</div>
												<div class="row">
												{{ if $t.Metadata.out_channel_array }}
													{{ $length := len $t.Metadata.out_channel_array }}
													{{if bigger $length 1}}
													<div class="row" style="position: absolute; bottom: 40px; padding-left: 24px;">
														{{ range $i, $o := $t.Metadata.out_channel_array }}
														<i 
															class="fa-solid fa-{{ add $i 1 }} channelIcon" 
															data-bs-toggle="tooltip" 
															data-bs-placement="bottom" 
															data-bs-title="{{ $o.aliase }}" 
															title="{{ $o.aliase }}"
														></i>
														{{ end }}
													</div>
													{{ end }}
												{{ end }}
												<h5 
													id="{{ $t.ID }}-deviceName"
													class="card-title truncate-text" 
													data-bs-toggle="tooltip" 
													data-bs-placement="bottom" 
													data-bs-title="{{ $t.Name }}" 
													title="{{ $t.Name }}"
												>
													{{ $t.Name }}
												</h5>
												</div>
											</div>
											</div>
										</div>
										{{ end }}
									</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
				let currentDevices = {}, 
                  	newDevices = {},
                  	scanNewThingsList = [],
                  	selectedNewThingNames = [],
					intervalRefreshDataThings = null,
					currentThingsList = [];
				const deviceNetCfgModal = new bootstrap.Modal(document.getElementById("deviceNetCfgModal")),
					  editThingModal = new bootstrap.Modal(document.getElementById("editThingModal")),
					  moreEditThingModal= new bootstrap.Modal(document.getElementById("moreEditThingModal")),
					  requiredMsg = '不能为空',
					  url = window.location.href, // 获取当前页面的URL
					  onlineStatusValue = (url.match(/onlineStatus=(\d+)/) || [])[1] || 
					  	sessionStorage.getItem("onlineStatus") || '1'; // 从URL获取onlineStatus的值
				
				$(document).ready(function() {
					sessionStorage.setItem("onlineStatus", onlineStatusValue);
					getThingsList(onlineStatusValue, false);

					intervalRefreshDataThings = setInterval(refreshThingsData, 2000);

					// 根据路径参数配置设备状态选中标签
					if (onlineStatusValue === '1') {
						$('#btnAll').prop('checked', false);
						$('#btnOnline').prop('checked', true);
						$('#btnOffline').prop('checked', false);
					} else if (onlineStatusValue === '0') {
						$('#btnAll').prop('checked', false);
						$('#btnOnline').prop('checked', false);
						$('#btnOffline').prop('checked', true);
					} else {
						$('#btnAll').prop('checked', true);
						$('#btnOnline').prop('checked', false);
						$('#btnOffline').prop('checked', false);
					}

					// 切换要查看的设备状态
					$('input[name="btnOnlineStatus"]').change(function() {
						currentDevices = {}, newDevices = {};
						$(`#thingsGrid`).empty();

						let reqOnlineStatus = '2'; //all
						if (this.id === 'btnOnline') {
							reqOnlineStatus = '1'; //online
						} else if (this.id === 'btnOffline') {
							reqOnlineStatus = '0'; //offline
						}
						sessionStorage.setItem("onlineStatus", reqOnlineStatus);
						stopFetchingDataThings();
						getThingsList(reqOnlineStatus, true);
					});

					//搜索添加设备确认添加按钮事件
					$('#scan-add-thing-button').on('click', addScanNewThings);

					//搜索添加设备-网络配置-手动、自动下拉选项
					$('#dhcp_enable-deviceNetCfg').change(function() {
						const deviceName = $(this).data('device_name');
						const deviceInfo = scanNewThingsList.find((item)=>item.device_name === deviceName); 
						const dhcp_enable = $(this).val();
						let ip = deviceInfo.netcfg.static_ip, 
							gateway = deviceInfo.netcfg.static_gateway,
							netmask = deviceInfo.netcfg.static_netmask, 
							dns1 = deviceInfo.netcfg.static_dns1, 
							dns2 = deviceInfo.netcfg.static_dns2,
							readOnly = false;
							if (dhcp_enable === "1") {
								//自动
								ip = deviceInfo.netcfg.dhcp_ip;
								gateway = deviceInfo.netcfg.dhcp_gateway;
								netmask = deviceInfo.netcfg.dhcp_netmask;
								dns1 = deviceInfo.netcfg.dhcp_dns1;
								dns2 = deviceInfo.netcfg.dhcp_dns2;
								readOnly = true;

								$('#ipError').empty();
								$('#gatewayError').empty();
								$('#netmaskError').empty();
								$('#dns1Error').empty();
								$('#dns2Error').empty();
							}

							$('#ip-deviceNetCfg').val(ip);
							$('#gateway-deviceNetCfg').val(gateway);
							$('#netmask-deviceNetCfg').val(netmask);
							$('#dns1-deviceNetCfg').val(dns1);
							$('#dns2-deviceNetCfg').val(dns2);

							$('#ip-deviceNetCfg').prop('readOnly', readOnly);
							$('#gateway-deviceNetCfg').prop('readOnly', readOnly);
							$('#netmask-deviceNetCfg').prop('readOnly', readOnly);
							$('#dns1-deviceNetCfg').prop('readOnly', readOnly);
							$('#dns2-deviceNetCfg').prop('readOnly', readOnly);

							scanNewThingsList = scanNewThingsList.map((item)=>{
							if(item.device_name === deviceName) {
								item.netcfg.dhcp_enable = dhcp_enable === "1";
							}
							return item;
						});
					});

					//搜索添加设备-网络配置-手动-注册所有输入框的验证和保存逻辑
					const netConfigArray = ['alias', 'ip', 'gateway', 'netmask', 'dns1', 'dns2'];
					netConfigArray.forEach((config) => {
						validateAndSave(config);
					});

					//搜索添加设备-网络配置-确认按钮
					$('#deviceNetCfgModal-confirm-button').on('click', function() {
						const deviceName = $(this).data('device_name');
						const deviceInfo = scanNewThingsList.find(item => item.device_name === deviceName);
						const dhcp_enable = deviceInfo.netcfg.dhcp_enable;
						let canCloseModal = true;

						function validateAndUpdateError(inputId) {
							const value =  $(`#${inputId}-deviceNetCfg`).val();
							if (inputId === 'alias') {
								if (!value) {
									$(`#${inputId}Error`).html('请输入设备名称');
									canCloseModal = false;
								} else {
									$(`#${inputId}Error`).empty();
								}
							} else {
								if (!IPV4REGX.test(value)) {
									$(`#${inputId}Error`).html(IPERRORMSG);
									canCloseModal = false;
								} else {
									$(`#${inputId}Error`).empty();
								}
							}
						}

						validateAndUpdateError('alias');

						if (!dhcp_enable) {
							validateAndUpdateError('ip');
							validateAndUpdateError('gateway');
							validateAndUpdateError('netmask');
							validateAndUpdateError('dns1');
							validateAndUpdateError('dns2');
						}

						if (canCloseModal) {
							if (!selectedNewThingNames.includes(deviceName)) {
								selectedNewThingNames.push(deviceName);
							}
							showNewThingsGrid(scanNewThingsList, selectedNewThingNames);
							deviceNetCfgModal.hide();
						}
					});

					//关闭弹框遮罩残余
					const scanThingsModalDiv = document.getElementById("scanThingsModal");
					scanThingsModalDiv.addEventListener('hidden.bs.modal', function (event) {
						$('.modal-backdrop.fade.show').remove();
					});

					// 点击更多设置按钮时，切换显示更多设置-设备设置弹框
					$('#moreSettingEditThingModal').click(function() {
						const thingID = $('#editThingModal').data('id');
						const originalDevice = currentThingsList.find(thing => thing.id === thingID);
						editThingModal.hide();
						moreEditThingModal.show();
						$("#deviceNameTitleMoreEditThingModal").html(originalDevice.name);
					});

					$('#deviceNameEditThingModal').on('change blur keyup', function(event) {
						const newDeviceName = $(this).val();
						if (newDeviceName) {
							$(`#deviceNameErrorEditThingModal`).empty();
							$('#deviceNameErrorEditThingModal').hide();
							const thingID = $("#editThingModal").data('id');
							const originalDevice = currentThingsList.find(thing => thing.id === thingID);
							const originalDeviceAliase = originalDevice.metadata["aliase"] || "";
                    		const originalDeviceName = originalDevice.name;
							if (originalDeviceName !== newDeviceName && event.type === 'blur') {
								let queryData = {...originalDevice};
								queryData.name = newDeviceName;
								queryData.metadata.info.device_aliase = newDeviceName;
								queryData.metadata.aliase = newDeviceName + '_' + splitStringByLastUnderscore(originalDeviceAliase)[1];
								console.log('queryData123: ', queryData);
							}
						} else {
							$(`#deviceNameErrorEditThingModal`).html(requiredMsg);
							$('#deviceNameErrorEditThingModal').show();
						}
					});
				});
				
				// 在组件卸载时停止调用
				window.addEventListener('beforeunload', stopFetchingDataThings);

				// 停止轮询刷新数据
				function stopFetchingDataThings() {
					if (intervalRefreshDataThings) {
						clearInterval(intervalRefreshDataThings);
						intervalRefreshDataThings = null;
					}
				}

				//打开弹框
				function openModal(modal) {
					if (modal === "scan") {
						scanNewThings();
					}
				}

				//生成输出通道配置项-修改设备弹框
				function createOutChannelConfig (channel) {
					const $channelConfig = $(`
						<div class="mb-3 row">
							<label for="out_channel_aliase_${channel.id}" class="col-sm-3 col-form-label">输出名称</label>
							<div class="col-sm-9">
								<div>
									<input 
										type="text" 
										class="form-control name-field" 
										name="out_channel_aliase_${channel.id}" 
										id="out_channel_aliase_${channel.id}"
										placeholder="输出名称" 
										maxlength="20"
										value="${channel.aliase}" 
									/>
								</div>
								<div style="display: flex; margin-top: 7px;">
									<input 
										type="range" 
										class="form-conrtol form-range" 
										min="0" 
										max="15" 
										step="1" 
										value="${channel.volume}" 
										id="out_channel_volume_${channel.id}"
									/>
									<div id="out_channel_volumeLabel_${channel.id}" style="text-align: right; width: 30px; line-height: 25px;">
										${channel.volume}
									</div>
								</div>
							</div>
						</div>
					`);
					$(`#out_channels_container_EditThingModal`).append($channelConfig);
				}

				//修改设备
				function editThing(id) {
					const originalDevice = currentThingsList.find(thing => thing.id === id);
					$("#editThingModal").attr("data-id", id);
					$("#deviceNameEditThingModal").val(originalDevice.name);
					$('#out_channels_container_EditThingModal').empty();
					if (
						originalDevice.metadata && 
						originalDevice.metadata["info"] && 
						originalDevice.metadata["info"].out_channel &&
						originalDevice.metadata["info"].out_channel.channel && 
						originalDevice.metadata["info"].out_channel.channel.length
					) {
						originalDevice.metadata["info"].out_channel.channel.forEach((channel)=>{
							createOutChannelConfig(channel);
						});
					}
					editThingModal.show();
				}

				//查看设备详情
				function viewThing(id, thingIdentity) {
					window.location.href = '{{printf "%s/things/" pathPrefix}}' + id;
				}

				//删除确认，接触通道关联
				function deleteThing(thingID) {
					showConfirmModal("确定要删除所选数据吗？", () => {
					fetch(`/ui/things/${thingID}/channelsInJSON?page=1&limit=1000`, {
						method: "GET",
					})
						.then(response => {
							if (!response.ok) {
								throw new Error('Network response was not ok');
							}
							return response.json(); // 直接将流转换为JSON对象
						})
						.then(json => {
							const data = json.data;
							const channelsData = JSON.parse(data).channelsData;
							const channels = channelsData.groups;
							const fetchPromises = channels.map((channel) => disconnectThingsAndChannels(thingID, channel.id));
							Promise.all(fetchPromises).then(responses => {})
								.then(jsonData => { handleDelete(thingID) })
								.catch(error => {
									// 如果有任何错误发生，这里会捕获到
									console.error('An error occurred:', error);
								});
						});
					});
				}

				//删除设备
				function handleDelete(thingID) {
					fetch(`/ui/things/${thingID}`, {
						method: "DELETE",
					})
						.then(function (response) {
							if (!response.ok) {
								const errorMessage = response.headers.get("X-Error-Message");
								if (errorMessage) {
									console.log(errorMessage);
								} else {
									console.log(`Error: ${response.status}`);
								}
							} else {
								const reqOnlineStatus = sessionStorage.getItem("onlineStatus");
								window.location.href = `/ui/things?limit=1000&onlineStatus=${reqOnlineStatus}`;
							}
						})
						.catch((error) => {
							const reqOnlineStatus = sessionStorage.getItem("onlineStatus");
							window.location.href = `/ui/things?limit=1000&onlineStatus=${reqOnlineStatus}`;
							console.error("error submitting form: ", error);
						});
				}

				//重启设备
				function rebootThing(thingIdentity) {
					showConfirmModal("确定要重启所选设备吗？", () => {
						conntrolThing(thingIdentity, "deviceReboot");
					});
				}

				//控制设备
				function conntrolThing(thingIdentity, controlType) {
					const domainID = sessionStorage.getItem("domainID");
					if (domainID) {
						fetch(`/ui/domains/${domainID}/domainInJSON`, {
							method: "GET",
						})
							.then(response => {
								if (!response.ok) {
									throw new Error('Network response was not ok');
								}
								return response.json(); // 直接将流转换为JSON对象
							})
							.then(json => {
								const data = json.data;
								const domainData = JSON.parse(data).domainData;
								const comID = domainData.metadata["comID"];
								if (comID) {
									postMessage(comID, controlType, thingIdentity);
								}
							});
					}
				}

				//更改设备在线状态
				function changeOnlineStatus(thing){
					const onlineStatus = thing.metadata && thing.metadata.is_online === "1";
					if (onlineStatus) {
						$(`#${thing.id}-thingCardContent`).css('background', 'white');
						$(`#${thing.id}-rebootBtn`).css('display', 'block');
					} else {
						$(`#${thing.id}-thingCardContent`).css('background', 'lightgray');
						$(`#${thing.id}-rebootBtn`).css('display', 'none');
					}
					$(`#${thing.id}-deviceName`).html(thing.name);
					$(`#${thing.id}-deviceName`).prop("title", thing.name);
				}

				//轮询刷新thingslist，以实现监听things在线状态的
				function refreshThingsData() {
					// 获取当前页面的完整URL
					const currentUrl = window.location.href;
					// 创建URL对象
					const urlObj = new URL(currentUrl);
					// 使用URL对象的searchParams属性获取URLSearchParams对象
					const searchParams = urlObj.searchParams;
					// 使用get方法从URLSearchParams对象中获取page和limit的值
					const page = searchParams.get('page') || 1;
					const limit = searchParams.get('limit') || 1000;
					const reqOnlineStatus = sessionStorage.getItem("onlineStatus") || 1;
					fetch(`/ui/things/thingsInJSON?page=${page}&limit=${limit}&onlineStatus=${reqOnlineStatus}`, {
						method: "GET",
					})
						.then(response => {
							if (!response.ok) {
								throw new Error('Network response was not ok');
							}
							return response.json(); // 直接将流转换为JSON对象
						})
						.then(json => {
							const data = json.data;
							const thingsData = JSON.parse(data).thingsData;
							const things = thingsData && typeof thingsData === 'object' && thingsData.things && typeof thingsData.things === 'object' ?  
								thingsData.things.filter((thing)=>{
									//identity 中有下划线则表示为多通道，默认在设备页面隐藏
									return thing.credentials.identity && !thing.credentials.identity.includes("_");
								}) || [] : [];
							newDevices = {};
							// 所有在线\离线
							if (things.length) {
								things.forEach(device => {
									newDevices[device.id] = {
									id: device.id,
									name: device.name,
									credentials: device.credentials,
									metadata: device.metadata,
									status: device.status,
									created_at: device.created_at,
									updated_at: device.updated_at,
									};
								});
								updateThingsGrid(things);
								currentThingsList = [...things];
							} else {
								currentDevices = {};
								$(`#thingsGrid`).empty();
								currentThingsList = [];
							};
						})
						.catch(error => {
							currentDevices = {};
							$(`#thingsGrid`).empty();
							currentThingsList = [];
						});
				}
				
				//更新设备显示表格
				function updateThingsGrid(devices) {
					const $thingsGrid = $('#thingsGrid');
					const currentDevicesLength = Object.keys(currentDevices).length;
					const newDevicesLength = Object.keys(newDevices).length;

					if (currentDevicesLength > newDevicesLength) {
						// 移除不在(查询在线时刚离线的，查询离线时刚上线的)的设备\
						Object.keys(currentDevices).forEach((curId)=>{
							if (
								(typeof newDevices === 'object' && Object.entries(newDevices).length === 0) || 
								(newDevices[curId] === null || newDevices[curId] === undefined) ||
								(typeof newDevices[curId] === 'object' && Object.entries(newDevices[curId]).length === 0)
							) {
								// 移除不在(查询在线时离线的，查询离线时上线的)的设备
								$(`#${curId}-thingCard`).remove();
							}
						});
					} else if (currentDevicesLength < newDevicesLength) {
						// 新增(查询在线时刚上线的，查询离线时刚离线的)的设备]
						Object.keys(newDevices).forEach((newId)=>{
							if (
								(typeof currentDevices === 'object' && Object.entries(currentDevices).length === 0) || 
								(currentDevices[newId] === null || currentDevices[newId] === undefined) ||
								(typeof currentDevices[newId] === 'object' && Object.entries(currentDevices[newId]).length === 0)
							) {
								const device = newDevices[newId];
								updateThingsGridDom(device);
							}
						});
					} else if (currentDevicesLength === newDevicesLength) {
						Object.keys(newDevices).forEach((newId)=>{
							const device = newDevices[newId];
							changeOnlineStatus(device);
						});
					}

					currentDevices = {};
					currentDevices = newDevices;
				}

				function updateThingsGridDom(device) {
					const deviceIcon = getDeviceIcon(device);
					const imgSpan = `<img id="${device.id}-thingIcon" src="/images/${deviceIcon}" class="hoverCardIcon">`;
					const btnSpan = `
						<div class="dropdown" style="float: right;">
							<button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
								<i class="fa-solid fa-ellipsis"></i>
							</button>
							<ul class="dropdown-menu">
								<li style="display: none;">
									<a class="dropdown-item" onclick="viewThing('${device.id}')">
										<i class="fa-solid fa-info" style="width: 16px;"></i> 查看
									</a>
								</li>
								<li 
									id="${device.id}-rebootBtn" 
									style="display: ${device.metadata && Number(device.metadata.is_online) === 1 ? 'block':'none'}"
								>
									<a class="dropdown-item" onclick="rebootThing('${device.credentials.identity}')">
										<i class="fa-solid fa-arrows-rotate" style="width: 16px;"></i> 重启
									</a>
								</li>
								<li 
									id="${device.id}-editBtn"
									style="display: ${device.metadata && Number(device.metadata.is_online) === 1 ? 'block':'none'}"
								>
									<a class="dropdown-item" onclick="editThing('${device.id}')">
										<i class="fa-solid fa-pencil-alt" style="width: 16px;"></i> 修改
									</a>
								</li>
								<li id="${device.id}-deleteBtn">
									<a class="dropdown-item" onclick="deleteThing('${device.id}')">
										<i class="fa-solid fa-trash-can" style="width: 16px;"></i> 删除
									</a>
								</li>
							</ul>
						</div>
					`;
					const channelIconDiv = device.metadata && 
						device.metadata.out_channel_array && 
						device.metadata.out_channel_array.length > 1 ? 
						`
							<div class="row" style="position: absolute; bottom: 40px; padding-left: 24px;">
								${device.metadata.out_channel_array.map(($o, $i) => {
									return `<i 
												class="fa-solid fa-${$i+1} channelIcon" 
												data-bs-toggle="tooltip" 
												data-bs-placement="bottom" 
												data-bs-title="${$o.aliase}" 
												title="${$o.aliase}">
											</i>`
								}).join('')}
							</div>
						` : ``;
					const $thingCard = $(`
						<div class="col-sm-3 mb-3 mb-sm-0" id="${device.id}-thingCard">
							<div class="hoverCard card" id="${device.id}-thingCardContent" >
								<div class="card-body">
									<div class="row">
										<div class="col">
											${imgSpan}
										</div>
										<div class="col">
											${btnSpan}
										</div>
									</div>
									<div class="row" style="margin-top:50px">
										${channelIconDiv}
										<h5 
											class="card-title truncate-text" 
											data-bs-toggle="tooltip" 
											data-bs-placement="bottom" 
											data-bs-title="${device.name}"
											title="${device.name}"
										>
											${device.name}
										</h5>
									</div>
								</div>
							</div>
						</div>
					`);
					$(`#thingsGrid`).append($thingCard);
				}

				//根据在线类型获取设备列表
				function getThingsList(onlineStatus, isRender) {
					fetch(`/ui/things/thingsInJSON?limit=1000&onlineStatus=${onlineStatus}`, {
						method: "GET",
					})
						.then(response => {
							if (!response.ok) {
								throw new Error('Network response was not ok');
							}
							return response.json(); // 直接将流转换为JSON对象
						})
						.then(json => {
							const data = json.data;
							const thingsData = JSON.parse(data).thingsData;
							const things = thingsData.things.filter((thing)=>{
								//identity 中有下划线则表示为多通道，默认在设备页面隐藏
								return thing.credentials && !thing.credentials.identity.includes("_");
							}) || [];

							if (things.length) {
								things.forEach(device => {
									currentDevices[device.id] = {
										id: device.id,
										name: device.name,
										credentials: device.credentials,
										metadata: device.metadata,
										status: device.status,
										created_at: device.created_at,
										updated_at: device.updated_at,
									};
								});
								if (isRender) {
									updateThingsGrid(things);
								}
							}
							intervalRefreshDataThings = setInterval(refreshThingsData, 2000);
						})
						.catch(error => {
							//
						});
				}

				//给设备发信息
				function postMessage(channelID, controlType, thingIdentity) {
					const url = window.location.href; // 获取当前页面的URL
					const address = new URL(url);
					const port =  sessionStorage.getItem("socketBridgePort") || "63001";
					const userInfoStr = sessionStorage.getItem("userInfo");
					userInfo = JSON.parse(userInfoStr);
					const data = {
						channelID: channelID,
						thingIdentity: thingIdentity,
						host: address.hostname,
						comID: channelID,
						controlType: controlType,
						username: userInfo.credentials.identity,
					}
					fetch(`http://${address.hostname}:${port}/controlDevice`, {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify(data),
					})
						.then(response => {
							console.log("postMessage: ", response)
						})
						.catch((error) => {
							console.error("error postMessage: ", error);
						});
				}
				
				//扫描添加设备弹框中手动设置网络信息验证
				function validateAndSave(property) {
					const $inputElement = $(`#${property}-deviceNetCfg`);
					$inputElement.on('change blur keyup', function(event) {
						const deviceName = $(this).data('device_name');
						const deviceInfo = scanNewThingsList.find(item => item.device_name === deviceName);
						const dhcp_enable = deviceInfo.netcfg.dhcp_enable;
						const value = $(this).val();
						
						if (property === 'alias') {
							if (value) {
								$(`#${property}Error`).empty();
								if (event.type === 'blur') {
									scanNewThingsList = scanNewThingsList.map(item => {
										if (item.device_name === deviceName) {
											item[`device_aliase`] = value;
										}
										return item;
									});
								}
							} else {
								$(`#${property}Error`).html('请输入设备名称');
							}
						} else {
							if (!dhcp_enable) {
								if (IPV4REGX.test(value)) {
									$(`#${property}Error`).empty();
									if (event.type === 'blur') {
										scanNewThingsList = scanNewThingsList.map(item => {
											if (item.device_name === deviceName) {
												item.netcfg[`static_${property}`] = value;
											}
											return item;
										});
									}
								} else {
									$(`#${property}Error`).html(IPERRORMSG);
								}
							}
						}
					});
				}

				//扫描设备添加弹框设备列表-配置网络
				function deviceNetCfg(e) {
					if (event.target.classList.contains('form-check-input')) {
						// 阻止事件冒泡或默认行为
						e.stopPropagation();
					} else {
						deviceNetCfgModal.show();

						$('#aliasError').empty();
						$('#ipError').empty();
						$('#gatewayError').empty();
						$('#netmaskError').empty();
						$('#dns1Error').empty();
						$('#dns2Error').empty();

						// event.currentTarget：指向事件监听器所附加的元素，即 <div> 元素。
						// event.target：指向触发事件的实际元素，即 <span> 或 <img> 元素。
						const deviceName = e.currentTarget.dataset.device_name;
						const deviceInfo = scanNewThingsList.find((item)=>item.device_name === deviceName); 
						let ip = deviceInfo.netcfg.static_ip, 
							gateway = deviceInfo.netcfg.static_gateway,
							netmask = deviceInfo.netcfg.static_netmask, 
							dns1 = deviceInfo.netcfg.static_dns1, 
							dns2 = deviceInfo.netcfg.static_dns2;
							dhcp_enable = "0",
							readOnly = false;
						if (deviceInfo.netcfg.dhcp_enable) {
							ip = deviceInfo.netcfg.dhcp_ip;
							gateway = deviceInfo.netcfg.dhcp_gateway;
							netmask = deviceInfo.netcfg.dhcp_netmask;
							dns1 = deviceInfo.netcfg.dhcp_dns1;
							dns2 = deviceInfo.netcfg.dhcp_dns2;
							dhcp_enable = "1";
							readOnly = true;
						}

						$('#dhcp_enable-deviceNetCfg').val(dhcp_enable);
						$('#alias-deviceNetCfg').attr('data-device_name', deviceName);
						$('#ip-deviceNetCfg').attr('data-device_name', deviceName);
						$('#gateway-deviceNetCfg').attr('data-device_name', deviceName);
						$('#netmask-deviceNetCfg').attr('data-device_name', deviceName);
						$('#dns1-deviceNetCfg').attr('data-device_name', deviceName);
						$('#dns2-deviceNetCfg').attr('data-device_name', deviceName);
						$('#dhcp_enable-deviceNetCfg').attr('data-device_name', deviceName);
						$('#deviceNetCfgModal-confirm-button').attr('data-device_name', deviceName);

						$('#alias-deviceNetCfg').val(deviceInfo.device_aliase);
						$('#ip-deviceNetCfg').val(ip);
						$('#gateway-deviceNetCfg').val(gateway);
						$('#netmask-deviceNetCfg').val(netmask);
						$('#dns1-deviceNetCfg').val(dns1);
						$('#dns2-deviceNetCfg').val(dns2);

						$('#ip-deviceNetCfg').prop('readOnly', readOnly);
						$('#gateway-deviceNetCfg').prop('readOnly', readOnly);
						$('#netmask-deviceNetCfg').prop('readOnly', readOnly);
						$('#dns1-deviceNetCfg').prop('readOnly', readOnly);
					}
				}

				//扫描添加设备弹框设备列表-勾选设备
				function onSelectNewThing(e) {
					e.stopPropagation();
					const checkbox = e.target;
					const isChecked = checkbox.checked;
					const value = e.target.value;
					//判断是否全选，全反选
					if (value === 'selectAll') {
						if (isChecked) {
							selectedNewThingNames = scanNewThingsList.map((item)=>{
								return item.device_name;
							});
							scanNewThingsList.forEach((item)=>{
								$(`#checkbox_${item.device_name}`).prop("checked", true);
							});
						} else {
							selectedNewThingNames = [];
							scanNewThingsList.forEach((item)=>{
								$(`#checkbox_${item.device_name}`).prop("checked", false);
							});
						}
					} else {
						if (isChecked) {
							if (!selectedNewThingNames.includes(value)) {
								selectedNewThingNames.push(value);
							}
						} else {
							selectedNewThingNames = selectedNewThingNames.filter((name)=> name !== value)
						}
					}
					
					if (selectedNewThingNames.length) {
						$("#scan-add-thing-button").removeAttr("disabled");
						//判断全选框是否半勾选
						if (selectedNewThingNames.length === scanNewThingsList.length) {
							$(`#checkbox_selectAll`).prop("checked", true);
							$(`#checkbox_selectAll`).prop("indeterminate", false);
						} else {
							$(`#checkbox_selectAll`).prop("indeterminate", true);
							$(`#checkbox_selectAll`).prop("checked", false);
						}
					} else {
						$("#scan-add-thing-button").attr("disabled", true);
						$(`#checkbox_selectAll`).prop("indeterminate", false);
						$(`#checkbox_selectAll`).prop("checked", false);
					}
				}

				//显示扫描添加设备弹框设备列表
				function showNewThingsGrid (thingsList, selectedThingsIds) {
					const scanThingsModal = new bootstrap.Modal(document.getElementById("scanThingsModal"));
					scanThingsModal.show();
					$(`#scanThingsGrid`).empty();

					//全选按钮
					const $selectAll = $(`
						<li class="list-group-item newThingItemList">
						<input 
							class="form-check-input" 
							type="checkbox" 
							value="selectAll" 
							id="checkbox_selectAll"
							onchange="onSelectNewThing(event)"
						/>
						<label class="form-check-label" for="checkbox_selectAll" style="margin-left:5px">
							全选
						</label>
						</li>
					`);
					$(`#scanThingsGrid`).append($selectAll);

					//设备列表
					thingsList.forEach((thing, index)=>{
						const deviceIcon = getDeviceIcon(thing);
						const $thingList = $(`
							<li 
								class="list-group-item newThingItemList" 
								onclick="deviceNetCfg(event)"
								data-device_name="${thing.device_name}" 
							>
								<input 
									class="form-check-input" 
									type="checkbox" 
									value="${thing.device_name}" 
									id="checkbox_${thing.device_name}"
									onchange="onSelectNewThing(event)"
									data-device_name="${thing.device_name}" 
									${selectedThingsIds.includes(thing.device_name) ? `checked` : ``}
								/>
								<label class="form-check-label" data-device_name="${thing.device_name}" >
									<img 
										src="/images/${deviceIcon}" 
										style="height: 24px; margin-top: -3px;"
										data-device_name="${thing.device_name}" 
									>
									<span data-device_name="${thing.device_name}" >${thing.device_aliase}</span>
								</label>
							</li>
						`);
						$(`#scanThingsGrid`).append($thingList);
					});

					if (selectedThingsIds.length) {
						$("#scan-add-thing-button").removeAttr("disabled");
						//判断全选框是否半勾选
						if (selectedThingsIds.length === thingsList.length) {
							$(`#checkbox_selectAll`).prop("checked", true);
							$(`#checkbox_selectAll`).prop("indeterminate", false);
						} else {
							$(`#checkbox_selectAll`).prop("indeterminate", true);
							$(`#checkbox_selectAll`).prop("checked", false);
						}
					} else {
						$("#scan-add-thing-button").attr("disabled", true);
						$(`#checkbox_selectAll`).prop("indeterminate", false);
						$(`#checkbox_selectAll`).prop("checked", false);
					}
				}

				//获取udp组播扫描到的新设备
				function scanNewThings(){
					const url = window.location.href; // 获取当前页面的URL
					const address = new URL(url);
					const port =  sessionStorage.getItem("socketBridgePort") || "63001";
					scanNewThingsList = []; selectedNewThingNames = [];
					fetch(`http://${address.hostname}:${port}/devices`, {
						method: "GET",
					})
						.then(response => {
							// 检查响应的内容类型是否为JSON
							if (
								response.headers.get('Content-Type') && 
								response.headers.get('Content-Type').includes('application/json')
							) {
								// 检查响应的内容长度
								if (response.headers.get('Content-Length') === '0') {
									// 如果内容长度为0，返回一个空对象或执行其他逻辑
									return {};
								}
								// 返回响应的JSON解析结果
								return response.json();
							} else {
								// 如果内容类型不是JSON，抛出错误或执行其他逻辑
								throw new Error('Response content type is not JSON');
							}
						})
						.then(json => {
							if (json && JSON.stringify(json) !== '{}' && json.length) {
								scanNewThingsList = json.map((item)=>{
									return JSON.parse(item.message)
								})
								showNewThingsGrid(scanNewThingsList, selectedNewThingNames)
							} else {
								showAlert("info", "没有可添加设备");
							}
						})
				}

				//添加扫描设备
				function addScanNewThings() {
					const selectedNewThings = scanNewThingsList.filter(item => selectedNewThingNames.includes(item.device_name));
					const oriQuery = selectedNewThings.map((thing)=>{
						return {
							name: thing.device_aliase,
							credentials: {
								identity: thing.device_name,
								secret: thing.device_name,
							},
							tags: [],
							metadata: {
								product_name: thing.product_name,
								is_online: "0",
								out_channel: thing.out_channel && thing.out_channel.channel ? `${thing.out_channel.channel.length}` : "0",
								out_channel_array: thing.out_channel && thing.out_channel.channel ? thing.out_channel.channel : [],
								is_channel: "0",
								aliase: thing.out_channel && thing.out_channel.channel && thing.out_channel.channel.length ? 
									thing.device_aliase + "_" + thing.out_channel.channel[0].aliase : thing.device_aliase
							}
						}
					});

					let query = [];
					for(let i = 0; i < oriQuery.length; i++) {
						if (Number(oriQuery[i].metadata.out_channel) > 1) {
							//当out_channel存在且大于1时，说明有是多通道设备，则要保存为多个设备
							// 1、先保存一个原样的
							query.push(oriQuery[i])
							// 2、根据out_channel的大小从下标2开始，生成多个通道设备
							for (let j = 2; j <= oriQuery[i].metadata.out_channel_array.length; j++) {
								let newThing = JSON.parse(JSON.stringify(oriQuery[i])); //深拷贝
								newThing.name = `${oriQuery[i].name}_${oriQuery[i].metadata.out_channel_array[j-1].aliase}`;
								newThing.credentials.identity = `${oriQuery[i].credentials.identity}_${j}`;
								newThing.credentials.secret = `${oriQuery[i].credentials.secret}_${j}`;
								newThing.metadata.aliase = `${oriQuery[i].name}_${oriQuery[i].metadata.out_channel_array[j-1].aliase}`;
								newThing.metadata.is_channel = "1";
								query.push(newThing);
							}
						} else {
							//当out_channel不存在 或者 等于1时，说明不是多通道设备，保留原样
							query.push(oriQuery[i]);
						}
					}
					
					//获取当前domain的ID号
					const domainID = sessionStorage.getItem("domainID");
						fetch(`/ui/domains/${domainID}/domainInJSON`, {
						method: "GET",
					})
					.then(response => {
						if (!response.ok) {
							throw new Error('Network response was not ok');
						}
						return response.json(); // 直接将流转换为JSON对象
					})
						.then(json => {
							const data = json.data;
							const domainData = JSON.parse(data).domainData;
							const defaultChannelId = domainData.metadata["comID"];
							fetch(`/ui/things/batch`, {
								method: "POST",
								headers: {
									"Content-Type": "application/json",
								},
								body: JSON.stringify(query),
							})
								.then(response => {
									const url = window.location.href; // 获取当前页面的URL
									const address = new URL(url);
									const port =  sessionStorage.getItem("socketBridgePort") || "63001";
									// 添加成功后需要向UDP发送回执
									fetch(`http://${address.hostname}:${port}/addDeviceReply`, {
										method: "POST",
										headers: {
											"Content-Type": "application/json",
										},
										body: JSON.stringify(selectedNewThings.map((item)=>{
											item.tenant_id = defaultChannelId;
											item.netcfg.mqtt_server = "nxt-gateway.local" || address.hostname;
											return item;
										})),
									})
										.then(response => {
											// 获取当前 URL
											const currentUrl = new URL(window.location.href);
											const reqOnlineStatus = sessionStorage.getItem("onlineStatus");
											// 修改查询参数
											currentUrl.searchParams.set('onlineStatus', reqOnlineStatus);
											// 跳转到新的 URL
											window.location.href = currentUrl.toString();
										})
								});
						})
				}	
		   	</script>
        </body>
    </html>
{{ end }}
