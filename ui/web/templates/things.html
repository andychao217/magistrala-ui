<!-- Copyright (c) Abstract Machines
SPDX-License-Identifier: Apache-2.0 -->

{{ define "things" }}
    <!doctype html>
    <html lang="en">
        <head>
            <title>设备</title>
            {{ template "header" }}
        </head>

        <body>
            {{ template "navbar" . }}
            <div class="main-content pt-3">
                <div class="container-fluid">
                    <div class="row-mb-3 p-3">
                        <div class="col-12 mx-auto">
                            <div>
                                <div class="buttons">
                                    <!-- edit thing modal -->
                                    <div 
										class="modal fade" 
										id="editThingModal" 
										tabindex="-1" 
										role="dialog" 
										aria-labelledby="editThingModalLabel" 
										data-bs-backdrop="static" 
										data-bs-keyboard="false" 
										aria-hidden="true"
                                    >
										<div class="modal-dialog" role="document">
											<div class="modal-content" style="width: 580px;">
												<div class="modal-header">
													<h1 class="modal-title" id="editThingModalLabel">设备设置</h1>
													<button 
														type="button" 
														class="btn-close" 
														data-bs-dismiss="modal" 
														aria-label="Close" 
														onclick="
															$('#deviceNameEditThingModal').attr('data-device_id', '');
															$('#deviceNameEditThingModal').attr('data-name', '');
														"
													></button>
												</div>
												<form id="editThingform">
													<div class="modal-body" style="padding: 35px;">
														<div class="mb-3 row">
															<label for="name" class="col-sm-3 col-form-label">名称</label>
															<div class="col-sm-9">
																<input 
																	type="text" 
																	class="form-control name-field" 
																	name="name" 
																	id="deviceNameEditThingModal" 
																	placeholder="设备名称" 
																	maxlength="20" 
																/>
																<div id="deviceNameErrorEditThingModal" class="text-danger inputError"></div>
															</div>
														</div>
														<div id="out_channels_container_EditThingModal"></div>
														<div class="mb-3 row" style="margin-bottom: 0px !important;">
															<div class="col-sm-12" style="text-align: center;">
																<div id="moreSettingEditThingModal" class="moreSettingBtn">
																	<i class="fa-solid fa-chevron-down"></i>
																</div>
															</div>
														</div>
													</div>
												</form>
											</div>
										</div>
                                    </div>

									<!-- 设备配置弹框 -->
									<div 
										class="modal fade" 
										id="moreEditThingModal" 
										tabindex="-1" 
										role="dialog" 
										aria-labelledby="moreEditThingModalLabel" 
										data-bs-backdrop="static" 
										data-bs-keyboard="false" 
										aria-hidden="true"
									>
										<div class="modal-dialog" role="document">
											<div class="modal-content" style="width: 580px;">
												<div class="modal-header">
													<h1 class="modal-title" id="moreEditThingModalLabel">
														<span>设备配置</span>
														<span id="deviceNameTitleMoreEditThingModal"></span>
													</h1>
													<button 
														type="button" 
														class="btn-close" 
														data-bs-dismiss="modal" 
														aria-label="Close"
														onclick="editThingModal.show()"
													></button>
												</div>
												<div class="modal-body" style="padding: 0px;">
													<div class="d-flex align-items-start">
														<div 
															class="nav flex-column nav-pills" 
															id="v-pills-tab" 
															role="tablist" 
															aria-orientation="vertical"
														>
															<button 
																class="nav-link active" 
																id="moreEditThingModal-netConfig-tab" 
																data-bs-toggle="pill" 
																data-bs-target="#moreEditThingModal-netConfig" 
																type="button" 
																role="tab" 
																aria-controls="moreEditThingModal-netConfig" 
																aria-selected="false"
															>
																网络配置
															</button>
															<button 
																class="nav-link" 
																id="moreEditThingModal-inChannels-tab" 
																data-bs-toggle="pill" 
																data-bs-target="#moreEditThingModal-inChannels" 
																type="button" 
																role="tab" 
																aria-controls="moreEditThingModal-inChannels" 
																aria-selected="false"
															>
																输入通道
															</button>
															<button 
																class="nav-link" 
																id="moreEditThingModal-localSpeech-tab" 
																data-bs-toggle="pill" 
																data-bs-target="#moreEditThingModal-localSpeech" 
																type="button" 
																role="tab" 
																aria-controls="moreEditThingModal-localSpeech" 
																aria-selected="false"
															>
																扩声
															</button>
															<button 
																class="nav-link" 
																id="moreEditThingModal-bluetooth-tab" 
																data-bs-toggle="pill" 
																data-bs-target="#moreEditThingModal-bluetooth" 
																type="button" 
																role="tab" 
																aria-controls="moreEditThingModal-bluetooth" 
																aria-selected="false"
															>
																蓝牙配置
															</button>
															<button 
																class="nav-link" 
																id="moreEditThingModal-deviceLog-tab" 
																data-bs-toggle="pill" 
																data-bs-target="#moreEditThingModal-deviceLog" 
																type="button" 
																role="tab" 
																aria-controls="moreEditThingModal-deviceLog" 
																aria-selected="false"
															>
																设备日志
															</button>
															<button 
																class="nav-link" 
																id="moreEditThingModal-sysInfo-tab" 
																data-bs-toggle="pill" 
																data-bs-target="#moreEditThingModal-sysInfo" 
																type="button" 
																role="tab" 
																aria-controls="moreEditThingModal-sysInfo" 
																aria-selected="true"
															>
																系统信息
															</button>
															<button 
																class="nav-link" 
																id="moreEditThingModal-otherOperation-tab" 
																data-bs-toggle="pill" 
																data-bs-target="#moreEditThingModal-otherOperation" 
																type="button" 
																role="tab" 
																aria-controls="moreEditThingModal-otherOperation" 
																aria-selected="true"
															>
																其他设置
															</button>
															<button 
																class="nav-link" 
																id="moreEditThingModal-deviceOperation-tab" 
																data-bs-toggle="pill" 
																data-bs-target="#moreEditThingModal-deviceOperation" 
																type="button" 
																role="tab" 
																aria-controls="moreEditThingModal-deviceOperation" 
																aria-selected="true"
															>
																设备操作
															</button>
														</div>
														<div 
															class="tab-content" 
															id="v-pills-tabContent" 
															style="border-left: thin solid lightgray; padding: 10px 20px;"
														>
															<div 
																class="tab-pane fade show active device_more_setting_tab" 
																id="moreEditThingModal-netConfig" 
																role="tabpanel" 
																aria-labelledby="moreEditThingModal-netConfig-tab" 
																tabindex="0"
																style="min-height: 400px;"
															>
																<!-- 网络配置 -->
																<div class="mb-3 row">
																	<label for="dhcp_enable-moreEditThingModal" class="col-sm-3 col-form-label">设置IP</label>
																	<div class="col-sm-9">
																		<div class="btn-group form-conrtol" role="group">
																			<input 
																				type="radio" 
																				class="btn-check" 
																				name="dhcp_enable-moreEditThingModal" 
																				id="dhcp_enable-deviceNetCfg-moreEditThingModal-manual" 
																				autocomplete="off" 
																				value="0" 
																				onchange="handleChangeDHCPEnable(this)"
																			/>
																			<label class="btn btn-outline-primary" for="dhcp_enable-deviceNetCfg-moreEditThingModal-manual">手动</label>
																			<input 
																				type="radio" 
																				class="btn-check" 
																				name="dhcp_enable-moreEditThingModal" 
																				id="dhcp_enable-deviceNetCfg-moreEditThingModal-auto" 
																				autocomplete="off" 
																				value="1"
																				onchange="handleChangeDHCPEnable(this)"
																			/>
																			<label class="btn btn-outline-primary" for="dhcp_enable-deviceNetCfg-moreEditThingModal-auto">自动</label>
																		</div>
																	</div>
																</div>
																<div class="mb-3 row">
																	<label for="ip-moreEditThingModal" class="col-sm-3 col-form-label">IP地址</label>
																	<div class="col-sm-9">
																		<input 
																			type="text" 
																			class="form-control" 
																			name="ip-moreEditThingModal" 
																			id="ip-deviceNetCfg-moreEditThingModal" 
																			placeholder="IP地址"
																		/>
																		<div id="ipError-moreEditThingModal" class="text-danger inputError"></div>
																	</div>
																</div>
																<div class="mb-3 row">
																	<label for="gateway-moreEditThingModal" class="col-sm-3 col-form-label">网关</label>
																	<div class="col-sm-9">
																		<input 
																			type="text" 
																			class="form-control" 
																			name="gateway-moreEditThingModal" 
																			id="gateway-deviceNetCfg-moreEditThingModal" 
																			placeholder="网关"
																		/>
																		<div id="gatewayError-moreEditThingModal" class="text-danger inputError"></div>
																	</div>
																</div>
																<div class="mb-3 row">
																	<label for="netmask-moreEditThingModal" class="col-sm-3 col-form-label">子网掩码</label>
																	<div class="col-sm-9">
																		<input 
																			type="text" 
																			class="form-control" 
																			name="netmask-moreEditThingModal" 
																			id="netmask-deviceNetCfg-moreEditThingModal" 
																			placeholder="子网掩码" 
																		/>
																		<div id="netmaskError-moreEditThingModal" class="text-danger inputError"></div>
																	</div>
																</div>
																<div class="mb-3 row">
																	<label for="dns1-moreEditThingModal" class="col-sm-3 col-form-label">主DNS</label>
																	<div class="col-sm-9">
																		<input 
																			type="text" 
																			class="form-control" 
																			name="dns1-moreEditThingModal" 
																			id="dns1-deviceNetCfg-moreEditThingModal" 
																			placeholder="主DNS"
																		/>
																		<div id="dns1Error-moreEditThingModal" class="text-danger inputError"></div>
																	</div>
																</div>
																<div class="mb-3 row">
																	<label for="dns2-moreEditThingModal" class="col-sm-3 col-form-label">从DNS</label>
																	<div class="col-sm-9">
																		<input 
																			type="text" 
																			class="form-control" 
																			name="dns2-moreEditThingModal" 
																			id="dns2-deviceNetCfg-moreEditThingModal" 
																			placeholder="从DNS" 
																		/>
																		<div id="dns2Error-moreEditThingModal" class="text-danger inputError"></div>
																	</div>
																</div>
																<div class="mb-3 row">
																	<div class="col-sm-9 offset-sm-3">
																		<button type="button" class="btn body-button" id="deviceNetCfgModal-confirm-button-moreEditThingModal">
																			<i class="fa-solid fa-floppy-disk"></i> 保存
																		</button>
																	</div>
																</div>
															</div>
															<div 
																class="tab-pane fade device_more_setting_tab" 
																id="moreEditThingModal-inChannels" 
																role="tabpanel" 
																aria-labelledby="moreEditThingModal-inChannels-tab" 
																tabindex="0"
															>
																<!-- 输入通道 -->
																<div id="in_channels_container_EditThingModal" style="min-height:400px;"></div>
															</div>
															<div 
																class="tab-pane fade device_more_setting_tab" 
																id="moreEditThingModal-localSpeech" 
																role="tabpanel" 
																aria-labelledby="moreEditThingModal-localSpeech-tab" 
																tabindex="0"
																style="min-height:400px;"
															>
																<!-- 本地扩声 -->
																<div class="mb-3 row">
																	<label for="localSpeech-moreEditThingModal" class="col-sm-3 col-form-label">扩声开关</label>
																	<div class="col-sm-9">
																		<div class="form-control form-check form-switch" style="border: none;">
																			<input 
																				class="form-check-input" 
																				type="checkbox" 
																				role="switch" 
																				name="localSpeech-moreEditThingModal" 
																				id="localSpeech-moreEditThingModal" 
																			/>
																		</div>
																	</div>
																</div>
																<div class="mb-3 row">
																	<label for="localSpeech-local_speech_area-moreEditThingModal[]" class="col-sm-3 col-form-label">本地扩声</label>
																	<div class="col-sm-9">
																		<select 
																			name="localSpeech-local_speech_area-moreEditThingModal[]" 
																			id="localSpeech-local_speech_area-moreEditThingModal"  
																			multiple="multiple" 
																			class="localSpeech-local_speech_area-moreEditThingModal"
																		>
																		</select>
																	</div>
																</div>
																<div class="mb-3 row">
																	<label 
																		for="localSpeech-volume-moreEditThingModal" 
																		class="col-sm-3 col-form-label" 
																		style="margin-top: -6px;"
																	>
																		音量
																	</label>
																	<div class="col-sm-9">
																		<div style="display: flex;">
																			<input 
																				type="range" 
																				class="form-conrtol form-range" 
																				min="0" 
																				max="15" 
																				step="1" 
																				value="0" 
																				id="localSpeech-volume-moreEditThingModal"
																			/>
																			<div 
																				id="localSpeech-volume-label-moreEditThingModal" 
																				style="text-align: right; width: 30px; line-height: 25px;"
																			>
																			</div>
																		</div>
																	</div>
																</div>
																<div class="mb-3 row">
																	<label 
																		for="localSpeech-trigger_threshold-moreEditThingModal" 
																		class="col-sm-3 col-form-label"
																		style="margin-top: -6px;"
																	>
																		触发灵敏度
																	</label>
																	<div class="col-sm-9">
																		<div style="display: flex;">
																			<input 
																				type="range" 
																				class="form-conrtol form-range" 
																				min="0" 
																				max="15" 
																				step="1" 
																				value="0" 
																				id="localSpeech-trigger_threshold-moreEditThingModal"
																			/>
																			<div 
																				id="localSpeech-trigger_threshold-label-moreEditThingModal" 
																				style="text-align: right; width: 30px; line-height: 25px;"
																			>
																			</div>
																		</div>
																	</div>
																</div>
															</div>
															<div 
																class="tab-pane fade device_more_setting_tab" 
																id="moreEditThingModal-bluetooth" 
																role="tabpanel" 
																aria-labelledby="moreEditThingModal-bluetooth-tab" 
																tabindex="0"
																style="min-height:400px;"
															>
																<!-- 蓝牙配置 -->
																<div class="mb-3 row">
																	<label for="bluetooth-player-moreEditThingModal" class="col-sm-4 col-form-label">蓝牙播放器</label>
																	<div class="col-sm-8">
																		<div class="form-control form-check form-switch" style="border: none;">
																			<input 
																				class="form-check-input" 
																				type="checkbox" 
																				role="switch" 
																				name="bluetooth-player-moreEditThingModal" 
																				id="bluetooth-player-moreEditThingModal" 
																			/>
																		</div>
																	</div>
																</div>
																<div class="mb-3 row">
																	<label for="bluetooth-password-moreEditThingModal" class="col-sm-4 col-form-label">密码</label>
																	<div class="col-sm-8">
																		<input 
																			type="text" 
																			class="form-control name-field" 
																			name="bluetooth-password-moreEditThingModal"
																			id="bluetooth-password-moreEditThingModal"
																			placeholder="请输入6位蓝牙密码"
																			maxlength="6" 
																		/>
																		<div id="bluetooth-password-moreEditThingModalError" class="text-danger inputError"></div>
																	</div>
																</div>
																<div class="mb-3 row">
																	<label for="bluetooth_delay-moreEditThingModal" class="col-sm-4 col-form-label">播放延迟(ms)</label>
																	<div class="col-sm-8">
																		<input 
																			type="number" 
																			class="form-control name-field" 
																			name="bluetooth_delay-moreEditThingModal"
																			id="bluetooth_delay-moreEditThingModal"
																			placeholder="请输入0-1000ms的延迟"
																			min="0" 
																			max="1000"
																			maxlength="4"
																		/>
																		<div class="inputError">配置完成后，下次播放生效</div>
																	</div>
																</div>
																<div class="mb-3 row">
																	<label for="bluetooth-play-area-moreEditThingModal[]" class="col-sm-4 col-form-label">播放区域</label>
																	<div class="col-sm-8">
																		<select 
																			name="bluetooth-play-area-moreEditThingModal[]" 
																			id="bluetooth-play-area-moreEditThingModal"  
																			multiple="multiple" 
																			class="bluetooth-play-area-moreEditThingModal"
																		>
																		</select>
																	</div>
																</div>
															</div>
															<div 
																class="tab-pane fade device_more_setting_tab" 
																id="moreEditThingModal-deviceLog" 
																role="tabpanel" 
																aria-labelledby="moreEditThingModal-deviceLog-tab" 
																tabindex="0"
															>
																<!-- 设备日志 -->
															</div>
															<div 
																class="tab-pane fade device_more_setting_tab" 
																id="moreEditThingModal-sysInfo" 
																role="tabpanel" 
																aria-labelledby="moreEditThingModal-sysInfo-tab" 
																tabindex="0"
																style="font-size: 14px; height: 400px;"
															>
																<!-- 系统信息 -->
																<div class="row mb-2">
																	<div class="col align-self-start moreEditThingModal-sysInfo-label">
																		固件版本
																	</div>
																	<div 
																		class="col align-self-end moreEditThingModal-sysInfo-content"
																		id="moreEditThingModal-sysInfo-firmware"
																	></div>
															  	</div>
																<div class="row mb-2">
																	<div class="col align-self-start moreEditThingModal-sysInfo-label">
																		制造商
																	</div>
																	<div 
																		class="col align-self-end moreEditThingModal-sysInfo-content"
																		id="moreEditThingModal-sysInfo-manufacturer"
																	></div>
															  	</div>
																<div class="row mb-2">
																	<div class="col align-self-start moreEditThingModal-sysInfo-label">
																		产品名称
																	</div>
																	<div 
																		class="col align-self-end moreEditThingModal-sysInfo-content"
																		id="moreEditThingModal-sysInfo-productName"
																	></div>
															  	</div>
																<div class="row mb-2">
																	<div class="col align-self-start moreEditThingModal-sysInfo-label">
																		产品SN
																	</div>
																	<div 
																		class="col align-self-end moreEditThingModal-sysInfo-content"
																		id="moreEditThingModal-sysInfo-productSN"
																	></div>
															  	</div>
																<div class="row mb-2" style="display: none;">
																	<div class="col align-self-start moreEditThingModal-sysInfo-label">
																		功放类型
																	</div>
																	<div 
																		class="col align-self-end moreEditThingModal-sysInfo-content"
																		id="moreEditThingModal-sysInfo-amplifierType"
																	></div>
															  	</div>
																<div class="row mb-2">
																	<div class="col align-self-start moreEditThingModal-sysInfo-label">
																		总容量
																	</div>
																	<div 
																		class="col align-self-end moreEditThingModal-sysInfo-content"
																		id="moreEditThingModal-sysInfo-totalVolumn"
																	></div>
															  	</div>
																<div class="row mb-2">
																	<div class="col align-self-start moreEditThingModal-sysInfo-label">
																		可用容量
																	</div>
																	<div 
																		class="col align-self-end moreEditThingModal-sysInfo-content"
																		id="moreEditThingModal-sysInfo-availableVolumn"
																	></div>
															  	</div>
																<div class="row mb-2">
																	<div class="col align-self-start moreEditThingModal-sysInfo-label">
																		Wifi MAC地址
																	</div>
																	<div 
																		class="col align-self-end moreEditThingModal-sysInfo-content"
																		id="moreEditThingModal-sysInfo-wifiMAC"
																	></div>
															  	</div>
																<div class="row mb-2">
																	<div class="col align-self-start moreEditThingModal-sysInfo-label">
																		以太网 MAC地址
																	</div>
																	<div 
																		class="col align-self-end moreEditThingModal-sysInfo-content"
																		id="moreEditThingModal-sysInfo-lanMAC"
																	></div>
															  	</div>
															</div>
															<div 
																class="tab-pane fade device_more_setting_tab" 
																id="moreEditThingModal-otherOperation" 
																role="tabpanel" 
																aria-labelledby="moreEditThingModal-otherOperation-tab" 
																tabindex="0"
																style="height: 400px;"
															>
																<!-- 其他设置 -->
																<div class="row">
																	<div
																		class="hoverCard card deviceOperation-btn primaryBtn"
																		id="moreEditThingModal-otherOperation-ledBtn"
																	>
																		<div class="card-body deviceOperation-btn-container">
																			<div class="deviceOperation-btn-icon">
																				<i class="fa-solid fa-lightbulb"></i>
																			</div>
																			<div class="row">
																				状态灯
																			</div>
																		</div>
																	</div>
																	<div
																		class="hoverCard card deviceOperation-btn primaryBtn"
																		id="moreEditThingModal-otherOperation-stereoBtn"
																	>
																		<div class="card-body deviceOperation-btn-container">
																			<div class="deviceOperation-btn-icon">
																				<i class="fa-solid fa-volume-high"></i>
																			</div>
																			<div class="row">
																				立体声
																			</div>
																		</div>
																	</div>
																</div>
															</div>
															<div 
																class="tab-pane fade device_more_setting_tab" 
																id="moreEditThingModal-deviceOperation" 
																role="tabpanel" 
																aria-labelledby="moreEditThingModal-deviceOperation-tab" 
																tabindex="0"
																style="height: 400px;"
															>
																<!-- 设备操作 -->
																<div class="row">
																	<div
																		class="hoverCard card deviceOperation-btn dangerBtn"
																		id="moreEditThingModal-deviceOperation-rebootBtn"
																	>
																		<div class="card-body deviceOperation-btn-container">
																			<div class="deviceOperation-btn-icon">
																				<i class="fa-solid fa-power-off"></i>
																			</div>
																			<div class="row">
																				设备重启
																			</div>
																		</div>
																	</div>
																	<div
																		class="hoverCard card deviceOperation-btn dangerBtn"
																		id="moreEditThingModal-deviceOperation-deleteBtn"
																	>
																		<div class="card-body deviceOperation-btn-container">
																			<div class="deviceOperation-btn-icon">
																				<i class="fa-solid fa-trash-can"></i>
																			</div>
																			<div class="row">
																				设备删除
																			</div>
																		</div>
																	</div>
																	<div
																		class="hoverCard card deviceOperation-btn dangerBtn"
																		id="moreEditThingModal-deviceOperation-resetBtn"
																	>
																		<div class="card-body deviceOperation-btn-container">
																			<div class="deviceOperation-btn-icon">
																				<i class="fa-solid fa-arrows-rotate"></i>
																			</div>
																			<div class="row">
																				恢复出厂
																			</div>
																		</div>
																	</div>
																</div>
															</div>
														</div>
													  </div>
												</div>
											</div>
										</div>
									</div>

                                    <!-- 扫描添加设备弹框 -->
                                    <div 
										class="modal fade" 
										id="scanThingsModal" 
										tabindex="-1" 
										role="dialog" 
										aria-labelledby="scanThingsModalLabel" 
										data-bs-backdrop="static" 
										data-bs-keyboard="false" 
										aria-hidden="true"
                                    >
										<div class="modal-dialog" role="document">
											<div class="modal-content">
												<div class="modal-header">
													<h1 class="modal-title" id="scanThingsModalLabel">添加设备</h1>
													<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
												</div>
												<div class="modal-body">
													<div class="row">
													<ul class="list-group" id="scanThingsGrid" style="padding-left: 10px; max-height: 400px; overflow-y: auto;">
													</ul>
													</div>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
														<i class="fa-solid fa-xmark"></i> 取消
													</button>
													<button type="button" class="btn body-button" id="scan-add-thing-button" disabled>
														<i class="fa-solid fa-plus"></i> 添加设备
													</button>
												</div>
											</div>
										</div>
                                    </div>

									<!-- 扫描添加-网络配置弹框 -->
                                    <div 
										class="modal fade" 
										id="deviceNetCfgModal" 
										tabindex="-1" 
										role="dialog" 
										aria-labelledby="deviceNetCfgModalLabel" 
										data-bs-backdrop="static" 
										data-bs-keyboard="false" 
										aria-hidden="true"
                                    >
										<div class="modal-dialog" role="document">
											<div class="modal-content">
												<div class="modal-header">
													<h1 class="modal-title" id="scanThingsModalLabel">设备设置</h1>
													<button 
														type="button" 
														class="btn-close" 
														data-bs-dismiss="modal" 
														aria-label="Close" 
														onclick="scanThingsModal.show();"
													></button>
												</div>
												<div class="modal-body">
													<div class="mb-3 row">
														<label for="alias" class="col-sm-3 col-form-label">设备名称</label>
														<div class="col-sm-9">
															<input 
																type="text" 
																class="form-control" 
																name="alias" 
																id="alias-deviceNetCfg" 
																placeholder="设备名称" 
																maxlength="20" 
															/>
															<div id="aliasError" class="text-danger inputError"></div>
														</div>
													</div>
													<div class="mb-3 row">
														<label for="dhcp_enable" class="col-sm-3 col-form-label">设置IP</label>
														<div class="col-sm-9">
															<select class="form-control" name="dhcp_enable" id="dhcp_enable-deviceNetCfg">
																<option value="0">手动</option>
																<option value="1">自动</option>
															</select>
														</div>
													</div>
													<div class="mb-3 row">
														<label for="ip" class="col-sm-3 col-form-label">IP地址</label>
														<div class="col-sm-9">
															<input type="text" class="form-control" name="ip" id="ip-deviceNetCfg" placeholder="IP地址" />
															<div id="ipError" class="text-danger inputError"></div>
														</div>
													</div>
													<div class="mb-3 row">
														<label for="gateway" class="col-sm-3 col-form-label">网关</label>
														<div class="col-sm-9">
															<input type="text" class="form-control" name="gateway" id="gateway-deviceNetCfg" placeholder="网关" />
															<div id="gatewayError" class="text-danger inputError"></div>
														</div>
													</div>
													<div class="mb-3 row">
														<label for="netmask" class="col-sm-3 col-form-label">子网掩码</label>
														<div class="col-sm-9">
															<input type="text" class="form-control" name="netmask" id="netmask-deviceNetCfg" placeholder="子网掩码" />
															<div id="netmaskError" class="text-danger inputError"></div>
														</div>
													</div>
													<div class="mb-3 row">
														<label for="dns1" class="col-sm-3 col-form-label">主DNS</label>
														<div class="col-sm-9">
															<input type="text" class="form-control" name="dns1" id="dns1-deviceNetCfg" placeholder="主DNS" />
															<div id="dns1Error" class="text-danger inputError"></div>
														</div>
													</div>
													<div class="mb-3 row">
														<label for="dns2" class="col-sm-3 col-form-label">从DNS</label>
														<div class="col-sm-9">
															<input type="text" class="form-control" name="dns2" id="dns2-deviceNetCfg" placeholder="从DNS" />
															<div id="dns2Error" class="text-danger inputError"></div>
														</div>
													</div>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="scanThingsModal.show();">
														<i class="fa-solid fa-xmark"></i> 取消
													</button>
													<button type="button" class="btn body-button" id="deviceNetCfgModal-confirm-button">
														<i class="fa-solid fa-floppy-disk"></i> 确定
													</button>
												</div>
											</div>
										</div>
                                    </div>
                                </div>
                                <div class="table-responsive table-container">
									<div class="row buttons mb-3">
										<div class="col-4" role="group">
											<button type="button" class="btn body-button" onclick="openModal('scan')">
												<i class="fa-solid fa-plus"></i> 添加设备
											</button>
										</div>
										<div class="btn-group col-4" role="group">
											<input type="radio" class="btn-check" name="btnOnlineStatus" id="btnAll" autocomplete="off" />
											<label class="btn btn-outline-primary" for="btnAll">全部</label>
											
											<input type="radio" class="btn-check" name="btnOnlineStatus" id="btnOnline" autocomplete="off" />
											<label class="btn btn-outline-primary" for="btnOnline">在线</label>
											
											<input type="radio" class="btn-check" name="btnOnlineStatus" id="btnOffline" autocomplete="off" />
											<label class="btn btn-outline-primary" for="btnOffline">离线</label>
										</div>
									</div>
									<div class="row" id="thingsGrid">
										{{ range $i, $t := .Things }}
										<div class="mb-3" id="{{ $t.ID }}-thingCard" style="width: 20%;">
											<div 
												class="hoverCard card"  
												id="{{ $t.ID }}-thingCardContent"
												{{ if $t.Metadata.is_online }}
													{{ if eq $t.Metadata.is_online "1" }}
													style="background: white;"
													{{ else }}
													style="background: lightgray;"
													{{ end }}
												{{ end }}
											>
												<div class="card-body">
													<div class="row">
														<div class="col">
															{{ if $t.Metadata.product_name }}
																{{ if or (stringContains $t.Metadata.product_name "2204") 
																	(stringContains $t.Metadata.product_name "2200") 
																	(stringContains $t.Metadata.product_name "2201") }}
																	<img loading="lazy" id="{{ $t.ID }}-thingIcon" src="/images/icon_device1.svg" class="hoverCardIcon" />
																{{ else if or (stringContains $t.Metadata.product_name "2102") 
																	(stringContains $t.Metadata.product_name "2110")
																	(stringContains $t.Metadata.product_name "2112") }}
																	<img loading="lazy" id="{{ $t.ID }}-thingIcon" src="/images/icon_device2.svg" class="hoverCardIcon" />
																{{ else if stringContains $t.Metadata.product_name "3302" }}
																	<img loading="lazy" id="{{ $t.ID }}-thingIcon" src="/images/icon_device3.svg" class="hoverCardIcon" />
																{{ else if or (stringContains $t.Metadata.product_name "2001")
																	(stringContains $t.Metadata.product_name "2011") }}
																	<img loading="lazy" id="{{ $t.ID }}-thingIcon" src="/images/icon_device4.svg" class="hoverCardIcon" />
																{{ else if or (stringContains $t.Metadata.product_name "3401")
																	(stringContains $t.Metadata.product_name "2401") }}
																	<img loading="lazy" id="{{ $t.ID }}-thingIcon" src="/images/icon_device5.svg" class="hoverCardIcon" />
																{{ else if stringContains $t.Metadata.product_name "3602" }}
																	<img loading="lazy" id="{{ $t.ID }}-thingIcon" src="/images/icon_device8.svg" class="hoverCardIcon" />
																{{ else }}
																	<img loading="lazy" id="{{ $t.ID }}-thingIcon" src="/images/icon_device0.svg" class="hoverCardIcon" />
																{{ end }}
															{{ end }}
														</div>
														<div class="col">
															<div class="dropdown" style="float: right;">
															<button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
																<i class="fa-solid fa-ellipsis"></i>
															</button>
															<ul class="dropdown-menu">
																<li style="display: none;">
																	<a class="dropdown-item" onclick="viewThing('{{ $t.ID }}', '{{ $t.Credentials.Identity }}')">
																		<i class="fa-solid fa-info" style="width: 16px;"></i> 查看
																	</a>
																</li>
																<li
																	id="{{ $t.ID }}-rebootBtn"
																	{{ if $t.Metadata.is_online }}
																		{{ if eq $t.Metadata.is_online "1" }}
																		style="display: block;"
																		{{ else }}
																		style="display: none;"
																		{{ end }}
																	{{ end }}
																>
																	<a class="dropdown-item" onclick="rebootThing('{{ $t.Credentials.Identity }}')">
																		<i class="fa-solid fa-power-off" style="width: 16px;"></i> 设备重启
																	</a>
																</li>
																<li 
																	id="{{ $t.ID }}-editBtn"
																	{{ if $t.Metadata.is_online }}
																		{{ if eq $t.Metadata.is_online "1" }}
																		style="display: block;"
																		{{ else }}
																		style="display: none;"
																		{{ end }}
																	{{ end }}
																>
																	<a class="dropdown-item" onclick="editThing('{{ $t.ID }}')">
																		<i class="fa-solid fa-gear" style="width: 16px;"></i> 设备设置
																	</a>
																</li>
																<li id="{{ $t.ID }}-deleteBtn">
																	<a class="dropdown-item" onclick="deleteThing('{{ $t.ID }}', true)" >
																		<i class="fa-solid fa-trash-can" style="width: 16px;"></i> 设备删除
																	</a>
																</li>
															</ul>
															</div>
														</div>
													</div>
													<div class="row">
														{{ if $t.Metadata.out_channel_array }}
															{{ $length := len $t.Metadata.out_channel_array }}
															{{if bigger $length 1}}
															<div class="row" style="position: absolute; bottom: 40px; padding-left: 24px;">
																{{ range $i, $o := $t.Metadata.out_channel_array }}
																<i 
																	class="fa-solid fa-{{ add $i 1 }} deviceChannelIcon" 
																	data-bs-toggle="tooltip" 
																	data-bs-placement="bottom" 
																	data-bs-title="{{ $o.aliase }}" 
																	title="{{ $o.aliase }}"
																></i>
																{{ end }}
															</div>
															{{ end }}
														{{ end }}
														<h5 
															id="{{ $t.ID }}-deviceName"
															class="card-title truncate-text" 
															data-bs-toggle="tooltip" 
															data-bs-placement="bottom" 
															data-bs-title="{{ $t.Name }}" 
															title="{{ $t.Name }}"
														>
															{{ $t.Name }}
														</h5>
													</div>
												</div>
											</div>
										</div>
										{{ end }}
									</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
				let currentDevices = {}, 
                  	newDevices = {},
                  	scanNewThingsList = [],
                  	selectedNewThingNames = [],
					allThingsList = [];
				const deviceNetCfgModal = new bootstrap.Modal(document.getElementById("deviceNetCfgModal")),
					  editThingModal = new bootstrap.Modal(document.getElementById("editThingModal")),
					  moreEditThingModal= new bootstrap.Modal(document.getElementById("moreEditThingModal")),
					  scanThingsModal = new bootstrap.Modal(document.getElementById("scanThingsModal"));
					  requiredMsg = '不能为空',
					  url = window.location.href, // 获取当前页面的URL
					  onlineStatusValue = (url.match(/onlineStatus=(\d+)/) || [])[1] || 
					  	sessionStorage.getItem("onlineStatus") || '1'; // 从URL获取onlineStatus的值
				
				$(document).ready(function() {
					sessionStorage.setItem("onlineStatus", onlineStatusValue);
					getThingsList(onlineStatusValue, false);
					getAllThingsList();

					// 根据路径参数配置设备状态选中标签
					if (onlineStatusValue === '1') {
						$('#btnAll').prop('checked', false);
						$('#btnOnline').prop('checked', true);
						$('#btnOffline').prop('checked', false);
					} else if (onlineStatusValue === '0') {
						$('#btnAll').prop('checked', false);
						$('#btnOnline').prop('checked', false);
						$('#btnOffline').prop('checked', true);
					} else {
						$('#btnAll').prop('checked', true);
						$('#btnOnline').prop('checked', false);
						$('#btnOffline').prop('checked', false);
					}

					// 切换要查看的设备状态
					$('input[name="btnOnlineStatus"]').change(function() {
						let reqOnlineStatus = '2'; //all
						if (this.id === 'btnOnline') {
							reqOnlineStatus = '1'; //online
						} else if (this.id === 'btnOffline') {
							reqOnlineStatus = '0'; //offline
						}
						sessionStorage.setItem("onlineStatus", reqOnlineStatus);
						window.location.href = `/ui/things?limit=1000&onlineStatus=${reqOnlineStatus}`;
						stopPollingThings();
						getThingsList(reqOnlineStatus);
					});

					//搜索添加设备确认添加按钮事件
					$('#scan-add-thing-button').on('click', addScanNewThings);

					//搜索添加设备-网络配置-手动、自动下拉选项
					$('#dhcp_enable-deviceNetCfg').change(function() {
						const deviceName = $(this).attr('data-device_name');
						const deviceInfo = scanNewThingsList.find((item)=>item.device_name === deviceName); 
						const dhcp_enable = $(this).val();
						let ip = deviceInfo.netcfg.static_ip, 
							gateway = deviceInfo.netcfg.static_gateway,
							netmask = deviceInfo.netcfg.static_netmask, 
							dns1 = deviceInfo.netcfg.static_dns1, 
							dns2 = deviceInfo.netcfg.static_dns2,
							disabled = false;
							if (dhcp_enable === "1") {
								//自动
								ip = deviceInfo.netcfg.dhcp_ip;
								gateway = deviceInfo.netcfg.dhcp_gateway;
								netmask = deviceInfo.netcfg.dhcp_netmask;
								dns1 = deviceInfo.netcfg.dhcp_dns1;
								dns2 = deviceInfo.netcfg.dhcp_dns2;
								disabled = true;

								$('#ipError').empty();
								$('#gatewayError').empty();
								$('#netmaskError').empty();
								$('#dns1Error').empty();
								$('#dns2Error').empty();
							}

							$('#ip-deviceNetCfg').val(ip);
							$('#gateway-deviceNetCfg').val(gateway);
							$('#netmask-deviceNetCfg').val(netmask);
							$('#dns1-deviceNetCfg').val(dns1);
							$('#dns2-deviceNetCfg').val(dns2);

							$('#ip-deviceNetCfg').prop('disabled', disabled);
							$('#gateway-deviceNetCfg').prop('disabled', disabled);
							$('#netmask-deviceNetCfg').prop('disabled', disabled);
							$('#dns1-deviceNetCfg').prop('disabled', disabled);
							$('#dns2-deviceNetCfg').prop('disabled', disabled);

							scanNewThingsList = scanNewThingsList.map((item)=>{
							if(item.device_name === deviceName) {
								item.netcfg.dhcp_enable = dhcp_enable === "1";
							}
							return item;
						});
					});

					//搜索添加设备-网络配置-手动-注册所有输入框的验证和保存逻辑
					const netConfigArray = ['alias', 'ip', 'gateway', 'netmask', 'dns1', 'dns2'];
					netConfigArray.forEach((config) => {
						validateAndSave(config, "");
					});

					//搜索添加设备-网络配置-确认按钮
					$('#deviceNetCfgModal-confirm-button').on('click', function() {
						const deviceName = $(this).attr('data-device_name');
						const deviceInfo = scanNewThingsList.find(item => item.device_name === deviceName);
						const dhcp_enable = deviceInfo.netcfg.dhcp_enable;
						let canCloseModal = true;

						function validateAndUpdateError(inputId) {
							const value =  $(`#${inputId}-deviceNetCfg`).val();
							if (inputId === 'alias') {
								if (!value) {
									$(`#${inputId}Error`).html('请输入设备名称');
									canCloseModal = false;
								} else {
									$(`#${inputId}Error`).empty();
								}
							} else {
								if (!IPV4REGX.test(value)) {
									$(`#${inputId}Error`).html(IPERRORMSG);
									canCloseModal = false;
								} else {
									$(`#${inputId}Error`).empty();
								}
							}
						}

						validateAndUpdateError('alias');

						if (!dhcp_enable) {
							validateAndUpdateError('ip');
							validateAndUpdateError('gateway');
							validateAndUpdateError('netmask');
							validateAndUpdateError('dns1');
							validateAndUpdateError('dns2');
						}

						if (canCloseModal) {
							if (!selectedNewThingNames.includes(deviceName)) {
								selectedNewThingNames.push(deviceName);
							}
							showNewThingsGrid(scanNewThingsList, selectedNewThingNames);
							scanThingsModal.show();
							deviceNetCfgModal.hide();
						}
					});

					//关闭弹框遮罩残余
					const scanThingsModalDiv = document.getElementById("scanThingsModal");
					scanThingsModalDiv.addEventListener('hidden.bs.modal', function (event) {
						$('.modal-backdrop.fade.show').remove();
					});

					// 点击更多设置按钮时，切换显示更多设置-设备设置弹框
					$('#moreSettingEditThingModal').click(function() {
						const callback = function() {
							const thingID = $('#moreEditThingModal').attr('data-device_id');
							const originalDevice = allThingsList.find(thing => thing.id === thingID);
							initMoreEditThingModal(originalDevice);
							editThingModal.hide();
							moreEditThingModal.show();
						}
						getAllThingsList(callback);
					});

					// 输入设备名称时，验证以及调整相关数据
					$('#deviceNameEditThingModal').on('change blur keyup', function(event) {
						const newDeviceName = $(this).val();
						if (newDeviceName) {
							$(`#deviceNameErrorEditThingModal`).empty();
							$('#deviceNameErrorEditThingModal').hide();
							const thingID = $("#editThingModal").attr('data-device_id');
							const originalDevice = allThingsList.find(thing => thing.id === thingID);
							const originalDeviceAliase = originalDevice.metadata["aliase"] || "";
                    		const originalDeviceName = originalDevice.name;
							if (originalDeviceName !== newDeviceName && event.type === 'blur') {
								let queryData = {...originalDevice.metadata.info};
								queryData.device_aliase = newDeviceName;
								const data = {
									controlType:  "deviceAliaseSet", 
									thingIdentity: originalDevice.credentials.identity, 
									deviceInfo: queryData,
								};
								controlThing(data);
							}
						} else {
							$(`#deviceNameErrorEditThingModal`).html(requiredMsg);
							$('#deviceNameErrorEditThingModal').show();
						}
					});
				});
				
				// 启动轮询
				function startPollingThings() {
					return setInterval(refreshThingsData, 2000); // 每5秒轮询一次
				}

				// 清理并重启轮询
				function resetPollingThings(intervalId) {
					clearInterval(intervalId);
					return startPollingThings();
				}

				// 停止轮询
				function stopPollingThings() {
					if (pollingIntervalIdThings) {
						clearInterval(pollingIntervalIdThings);
						pollingIntervalIdThings = null;
					}
				}

				// 初始启动轮询
				let pollingIntervalIdThings = null;

				// 每10分钟清理并重启轮询
				setInterval(function() {
					pollingIntervalIdThings = resetPollingThings(pollingIntervalIdThings);
				}, 10 * 60 * 1000); // 10分钟

				// 在组件卸载时停止调用
				window.addEventListener('beforeunload', stopPollingThings);

				document.addEventListener('visibilitychange', () => {
					console.log('visibilitychange things: ', document.visibilityState);
					if (document.visibilityState === 'hidden') {
						stopPollingThings();
					} else {
						pollingIntervalIdThings = startPollingThings();
					}
				});

				//打开弹框
				function openModal(modal) {
					if (modal === "scan") {
						scanNewThings();
					}
				}

				//生成输入、输出通道配置项-修改设备弹框
				function createChannelConfig (channel, channelType, thingIdentity) {
					const channelLabel = channelType === "in" ? "输入名称" : "输出名称";
					const controlType = channelType === "in" ? "deviceInChannelEdit" : "deviceOutChannelEdit";
					const $channelConfig = $(`
						<div class="mb-3 row">
							<label for="${channelType}_channel_aliase_${channel.id}" class="col-sm-3 col-form-label">
								${channelLabel}
							</label>
							<div class="col-sm-9">
								<div>
									<input 
										type="text" 
										class="form-control name-field" 
										name="${channelType}_channel_aliase_${channel.id}" 
										id="${channelType}_channel_aliase_${channel.id}"
										placeholder="${channelLabel}" 
										maxlength="20"
										value="${channel.aliase}" 
									/>
									<div id="${channelType}_channel_aliase_error_${channel.id}" class="text-danger inputError"></div>
								</div>
								<div style="display: flex; margin-top: 7px;">
									<input 
										type="range" 
										class="form-conrtol form-range" 
										min="0" 
										max="15" 
										step="1" 
										value="${channel.volume}" 
										id="${channelType}_channel_volume_${channel.id}"
									/>
									<div 
										id="${channelType}_channel_volumeLabel_${channel.id}" 
										style="text-align: right; width: 30px; line-height: 25px;"
									>
										${channel.volume}
									</div>
								</div>
							</div>
						</div>
					`);
					$(`#${channelType}_channels_container_EditThingModal`).append($channelConfig);

					$(`#${channelType}_channel_aliase_${channel.id}`).on('change blur keyup', function(event) {
						const channel_aliase = $(this).val();
						if (channel_aliase) {
							$(`#${channelType}_channel_aliase_error_${channel.id}`).empty();
							$(`#${channelType}_channel_aliase_error_${channel.id}`).hide();
							const queryData = _.cloneDeep(channel);
							queryData.aliase = channel_aliase;
							if (event.type === 'blur') {
								const data = {
									controlType:  controlType, 
									thingIdentity: thingIdentity,
									channelAttr: queryData,
								}
								controlThing(data);
							}
							
						} else {
							$(`#${channelType}_channel_aliase_error_${channel.id}`).html(requiredMsg);
							$(`#${channelType}_channel_aliase_error_${channel.id}`).show();
						}
					});

					$(`#${channelType}_channel_volume_${channel.id}`).on('input blur', function(event) {
						const channel_volume = $(this).val();
						$(`#${channelType}_channel_volumeLabel_${channel.id}`).html(channel_volume);
						const queryData = _.cloneDeep(channel);
						queryData.volume = Number(channel_volume);
						if (event.type === 'blur') {
							const data = {
								controlType:  controlType, 
								thingIdentity: thingIdentity,
								channelAttr: queryData,
							}
							controlThing(data);
						}
					});
				}

				//修改设备
				function editThing(id) {
					const callback = function () {
						const originalDevice = allThingsList.find(thing => thing.id === id);
						$("#editThingModal").attr("data-device_id", id);
						$('#moreEditThingModal').attr("data-device_id", id);
						$("#deviceNameEditThingModal").val(originalDevice.name);
						$('#out_channels_container_EditThingModal').empty();
						if (
							originalDevice.metadata && 
							originalDevice.metadata["info"] && 
							originalDevice.metadata["info"].out_channel &&
							originalDevice.metadata["info"].out_channel.channel && 
							originalDevice.metadata["info"].out_channel.channel.length
						) {
							originalDevice.metadata["info"].out_channel.channel.forEach((channel)=>{
								createChannelConfig(channel, 'out', originalDevice.credentials.identity);
							});
						}
						editThingModal.show();
					}
					getAllThingsList(callback);
				}

				//修改设备弹框-网络配置-切换手动、自动
				function handleChangeDHCPEnable(radio) {
					const deviceID = $(radio).attr("data-device_id");
					const device = allThingsList.find(thing => thing.id === deviceID);
					const deviceInfo = _.cloneDeep(device.metadata?.info);
					const dhcp_enable = Number(radio.value) === 1 ? true : false;
					let ip = deviceInfo.netcfg.static_ip, 
							gateway = deviceInfo.netcfg.static_gateway,
							netmask = deviceInfo.netcfg.static_netmask, 
							dns1 = deviceInfo.netcfg.static_dns1, 
							dns2 = deviceInfo.netcfg.static_dns2,
							disabled = false;
					if (dhcp_enable) {
						//自动
						ip = deviceInfo.netcfg.dhcp_ip;
						gateway = deviceInfo.netcfg.dhcp_gateway;
						netmask = deviceInfo.netcfg.dhcp_netmask;
						dns1 = deviceInfo.netcfg.dhcp_dns1;
						dns2 = deviceInfo.netcfg.dhcp_dns2;
						disabled = true;

						$('#ipError-moreEditThingModal').empty();
						$('#gatewayError-moreEditThingModal').empty();
						$('#netmaskError-moreEditThingModal').empty();
						$('#dns1Error-moreEditThingModal').empty();
						$('#dns2Error-moreEditThingModal').empty();
					}

					$('#ip-deviceNetCfg-moreEditThingModal').val(ip);
					$('#gateway-deviceNetCfg-moreEditThingModal').val(gateway);
					$('#netmask-deviceNetCfg-moreEditThingModal').val(netmask);
					$('#dns1-deviceNetCfg-moreEditThingModal').val(dns1);
					$('#dns2-deviceNetCfg-moreEditThingModal').val(dns2);

					$('#ip-deviceNetCfg-moreEditThingModal').prop('disabled', disabled);
					$('#gateway-deviceNetCfg-moreEditThingModal').prop('disabled', disabled);
					$('#netmask-deviceNetCfg-moreEditThingModal').prop('disabled', disabled);
					$('#dns1-deviceNetCfg-moreEditThingModal').prop('disabled', disabled);
					$('#dns2-deviceNetCfg-moreEditThingModal').prop('disabled', disabled);
				}

				//初始化更多设置
				function initMoreEditThingModal(device) {
					$("#deviceNameTitleMoreEditThingModal").html(device.name || "");
					//显示第一个tab标签
					const triggerEl = document.querySelector('#v-pills-tab button[data-bs-toggle="pill"]')
					bootstrap.Tab.getInstance(triggerEl).show();

					$(".moreEditThingModal-sysInfo-content").empty();
					$('#in_channels_container_EditThingModal').empty();

					const deviceInfo = _.cloneDeep(device.metadata?.info);
					if (deviceInfo && !_.isEmpty(deviceInfo)) {
						//网络设置
						let ip = deviceInfo.netcfg.static_ip, 
							gateway = deviceInfo.netcfg.static_gateway,
							netmask = deviceInfo.netcfg.static_netmask, 
							dns1 = deviceInfo.netcfg.static_dns1, 
							dns2 = deviceInfo.netcfg.static_dns2;
							dhcp_enable = deviceInfo.netcfg.dhcp_enable,
							disabled = false,
							deviceID = device.id;
						if (dhcp_enable) {
							ip = deviceInfo.netcfg.dhcp_ip;
							gateway = deviceInfo.netcfg.dhcp_gateway;
							netmask = deviceInfo.netcfg.dhcp_netmask;
							dns1 = deviceInfo.netcfg.dhcp_dns1;
							dns2 = deviceInfo.netcfg.dhcp_dns2;
							disabled = true;
							document.getElementById("dhcp_enable-deviceNetCfg-moreEditThingModal-manual").checked = false;
							document.getElementById("dhcp_enable-deviceNetCfg-moreEditThingModal-auto").checked = true;
						} else {
							document.getElementById("dhcp_enable-deviceNetCfg-moreEditThingModal-manual").checked = true;
							document.getElementById("dhcp_enable-deviceNetCfg-moreEditThingModal-auto").checked = false;
						}

						$('#ipError-moreEditThingModal').empty();
						$('#gatewayError-moreEditThingModal').empty();
						$('#netmaskError-moreEditThingModal').empty();
						$('#dns1Error-moreEditThingModal').empty();
						$('#dns2Error-moreEditThingModal').empty();
						
						$('#ip-deviceNetCfg-moreEditThingModal').attr('data-device_id', deviceID);
						$('#gateway-deviceNetCfg-moreEditThingModal').attr('data-device_id', deviceID);
						$('#netmask-deviceNetCfg-moreEditThingModal').attr('data-device_id', deviceID);
						$('#dns1-deviceNetCfg-moreEditThingModal').attr('data-device_id', deviceID);
						$('#dns2-deviceNetCfg-moreEditThingModal').attr('data-device_id', deviceID);
						$('#dhcp_enable-deviceNetCfg-moreEditThingModal-manual').attr('data-device_id', deviceID);
						$('#dhcp_enable-deviceNetCfg-moreEditThingModal-auto').attr('data-device_id', deviceID);
						$('#deviceNetCfgModal-confirm-button-moreEditThingModal').attr('data-device_id', deviceID);

						$('#ip-deviceNetCfg-moreEditThingModal').val(ip);
						$('#gateway-deviceNetCfg-moreEditThingModal').val(gateway);
						$('#netmask-deviceNetCfg-moreEditThingModal').val(netmask);
						$('#dns1-deviceNetCfg-moreEditThingModal').val(dns1);
						$('#dns2-deviceNetCfg-moreEditThingModal').val(dns2);

						$('#ip-deviceNetCfg-moreEditThingModal').prop('disabled', disabled);
						$('#gateway-deviceNetCfg-moreEditThingModal').prop('disabled', disabled);
						$('#netmask-deviceNetCfg-moreEditThingModal').prop('disabled', disabled);
						$('#dns1-deviceNetCfg-moreEditThingModal').prop('disabled', disabled);
						$('#dns2-deviceNetCfg-moreEditThingModal').prop('disabled', disabled);

						const netConfigArray = ['ip', 'gateway', 'netmask', 'dns1', 'dns2'];
						netConfigArray.forEach((config) => {
							validateAndSave(config, '-moreEditThingModal');
						});

						//设备网络配置修改-保存按钮
						$('#deviceNetCfgModal-confirm-button-moreEditThingModal').on('click', function() {
							const deviceID = $(this).attr('data-device_id');
							const device = allThingsList.find(thing => thing.id === deviceID);
							const deviceInfo = _.cloneDeep(device.metadata?.info);
							const dhcp_enable = document.getElementById("dhcp_enable-deviceNetCfg-moreEditThingModal-auto").checked;
							let canSave = true;

							function validateAndUpdateError(inputId) {
								const value =  $(`#${inputId}-deviceNetCfg-moreEditThingModal`).val();
								if (!IPV4REGX.test(value)) {
									$(`#${inputId}Error-moreEditThingModal`).html(IPERRORMSG);
									canSave = false;
								} else {
									$(`#${inputId}Error-moreEditThingModal`).empty();
								}
							}

							if (!dhcp_enable) {
								validateAndUpdateError('ip');
								validateAndUpdateError('gateway');
								validateAndUpdateError('netmask');
								validateAndUpdateError('dns1');
								validateAndUpdateError('dns2');
							}

							if (canSave) {
								deviceInfo.netcfg.dhcp_enable = dhcp_enable;
								if (!dhcp_enable) {
									deviceInfo.netcfg.static_ip = $(`#ip-deviceNetCfg-moreEditThingModal`).val();
									deviceInfo.netcfg.static_gateway = $(`#gateway-deviceNetCfg-moreEditThingModal`).val();
									deviceInfo.netcfg.static_netmask = $(`#netmask-deviceNetCfg-moreEditThingModal`).val();
									deviceInfo.netcfg.static_dns1 = $(`#dns1-deviceNetCfg-moreEditThingModal`).val();
									deviceInfo.netcfg.static_dns2 = $(`#dns2-deviceNetCfg-moreEditThingModal`).val();
								}
								const cancelCallback = function () {
									moreEditThingModal.show();
								};
								moreEditThingModal.hide();
								showConfirmModal("修改设备网络配置信息，设备会自动重启，确定要进行此操作吗，是否继续？", () => {
									const callback = function () {
										moreEditThingModal.hide();
										editThingModal.hide();
									}
									const data = {
										controlType:  "deviceInfoSet", 
										thingIdentity: device.credentials.identity, 
										deviceInfo: deviceInfo,
									}
									controlThing(data, callback);
								}, cancelCallback);
							}
						});

						//输入通道
						if (
							deviceInfo.in_channel && 
							deviceInfo.in_channel.channel && 
							deviceInfo.in_channel.channel.length
						) {
							$('#moreEditThingModal-inChannels-tab').show();
							deviceInfo.in_channel.channel.forEach((channel)=>{
								createChannelConfig(channel, 'in', device.credentials.identity);
							});
						} else {
							$('#moreEditThingModal-inChannels-tab').hide();
						}

						//显示设备信息
						$("#moreEditThingModal-sysInfo-firmware").html(deviceInfo.sw_version || "");
						$("#moreEditThingModal-sysInfo-manufacturer").html(deviceInfo.manufacturer || "");
						$("#moreEditThingModal-sysInfo-productName").html(deviceInfo.product_name || "");
						$("#moreEditThingModal-sysInfo-productSN").html(deviceInfo.product_serial || "");
						$("#moreEditThingModal-sysInfo-amplifierType").html(deviceInfo.pa_type || "");
						const total_capacity = deviceInfo.total_capacity || 0;
						const total_capacityStr = (total_capacity / 1024).toFixed(2) + "GB";
						const available_capacity = deviceInfo.available_capacity || 0;
						const available_capacityStr = (available_capacity / 1024).toFixed(2) + "GB";
						$("#moreEditThingModal-sysInfo-totalVolumn").html(total_capacityStr);
						$("#moreEditThingModal-sysInfo-availableVolumn").html(available_capacityStr);
						$("#moreEditThingModal-sysInfo-wifiMAC").html(deviceInfo.wifi_mac_addr || "");
						$("#moreEditThingModal-sysInfo-lanMAC").html(deviceInfo.eth_mac_addr || "");

						$('#moreEditThingModal-localSpeech-tab').hide();
						$('#moreEditThingModal-bluetooth-tab').hide();
						$('#moreEditThingModal-otherOperation-tab').hide();
						//其他设置
						const feature_list = _.cloneDeep(deviceInfo.feature_list);
						if (feature_list && !_.isEmpty(feature_list)) {
							//本地扩声
							if (feature_list.has_local_speech) {
								$('#moreEditThingModal-localSpeech-tab').show();
								//本地扩声开关
								$('#localSpeech-moreEditThingModal').prop('checked', false);
								if (deviceInfo.speech_cfg.speech_enable) {
									$('#localSpeech-moreEditThingModal').prop('checked', true);
								}
								//本地扩声区域
								$('select[multiple].localSpeech-local_speech_area-moreEditThingModal').multiselect({
									columns  : 1,
									search   : false,
									selectAll: true,
									texts    : {
										placeholder    : '请选择播放区域',
										selectedOptions: ' 选中',
										selectAll      : '全选', 
										unselectAll    : '取消全选',
										noneSelected   : '没选中'
									}
								});
								const local_speech_area_options = deviceInfo.out_channel?.channel?.map((item)=>{
									return {
										name   : item.aliase,
										value  : item.id,
										checked: deviceInfo.speech_cfg.local_speech_area.includes(item.id)
									}
								});
								$('select[multiple].localSpeech-local_speech_area-moreEditThingModal').multiselect('loadOptions', local_speech_area_options );
								const local_speech_area_selectedOptionNames = local_speech_area_options.filter((item)=>item.checked).map(item=>item.name).join(', ');
								// 通过 ID 选择器选择 <select> 元素
								const local_speech_area_selectElement = $("#localSpeech-local_speech_area-moreEditThingModal");
								// 选择 <select> 元素的紧邻兄弟元素 div
								const local_speech_area_msOptionsWrap = local_speech_area_selectElement.next(".ms-options-wrap.ms-has-selections");
								// 确定已经找到该元素
								if (local_speech_area_msOptionsWrap.length) {
									// 查找 ms-options-wrap 下的 button > span 元素
									const local_speech_area_buttonSpan = local_speech_area_msOptionsWrap.find("button > span");
									if (local_speech_area_buttonSpan.length) {
										local_speech_area_buttonSpan.html(local_speech_area_selectedOptionNames);
									}
								}

								//音量
								$('#localSpeech-volume-moreEditThingModal').val(deviceInfo.speech_cfg.volume);
								$('#localSpeech-volume-label-moreEditThingModal').html(deviceInfo.speech_cfg.volume);
								$('#localSpeech-volume-moreEditThingModal').on('change', function () {
									const volume = $(this).val();
									$('#localSpeech-volume-label-moreEditThingModal').html(volume);
								});
								//触发灵敏度
								$('#localSpeech-trigger_threshold-moreEditThingModal').val(deviceInfo.speech_cfg.trigger_threshold);
								$('#localSpeech-trigger_threshold-label-moreEditThingModal').html(deviceInfo.speech_cfg.trigger_threshold);
								$('#localSpeech-trigger_threshold-moreEditThingModal').on('change', function () {
									const trigger_threshold = $(this).val();
									$('#localSpeech-trigger_threshold-label-moreEditThingModal').html(trigger_threshold);
								});
							}

							//蓝牙配置
							if (feature_list.has_bluetooth_player) {
								$('#moreEditThingModal-bluetooth-tab').show();

								//蓝牙播放器开关
								$('#bluetooth-player-moreEditThingModal').prop('checked', false);
								if (deviceInfo.bluetooth_cfg.bluetooth_player_enable) {
									$('#bluetooth-player-moreEditThingModal').prop('checked', true);
								}

								$('#bluetooth-player-moreEditThingModal').on('change', function () {
									const bluetooth_player_enable = $(this).is(':checked');
									const play_area_list = $('select[multiple].bluetooth-play-area-moreEditThingModal').val();
									const bluetooth_delay = $('#bluetooth_delay-moreEditThingModal').val();
									const password = $('#bluetooth-password-moreEditThingModal').val();
									const bluetoothCfg = {
										...deviceInfo.bluetooth_cfg,
										bluetooth_player_enable,
										play_area: play_area_list.join(','),
										bluetooth_delay: Number(bluetooth_delay),
										password,
									};
									const data = {
										controlType:  "deviceBluetoothCfgSet", 
										thingIdentity: device.credentials.identity,
										bluetoothCfg,
									}
									// controlThing(data);
									console.log("changedTag: ", data);
								});

								//蓝牙密码
								$('#bluetooth-password-moreEditThingModal').val(deviceInfo.bluetooth_cfg.password);
								$('#bluetooth-password-moreEditThingModal').on('input change blur', function (event) {
									const bluetooth_player_enable = $('#bluetooth-player-moreEditThingModal').is(':checked');
									const play_area_list = $('select[multiple].bluetooth-play-area-moreEditThingModal').val();
									const bluetooth_delay = $('#bluetooth_delay-moreEditThingModal').val();
									const password = $(this).val();
									if (password) {
										$(`#bluetooth-password-moreEditThingModalError`).empty();
										$('#bluetooth-password-moreEditThingModalError').hide();
										if (event.type === 'blur') {
											const bluetoothCfg = {
												...deviceInfo.bluetooth_cfg,
												bluetooth_player_enable,
												play_area: play_area_list.join(','),
												bluetooth_delay: Number(bluetooth_delay),
												password,
											};
											const data = {
												controlType:  "deviceBluetoothCfgSet", 
												thingIdentity: device.credentials.identity,
												bluetoothCfg,
											}
											// controlThing(data);
											console.log("changedTag: ", data);
										}
									} else {
										$(`#bluetooth-password-moreEditThingModalError`).html(requiredMsg);
										$('#bluetooth-password-moreEditThingModalError').show();
									}
								});

								//蓝牙延迟
								$('#bluetooth_delay-moreEditThingModal').val(deviceInfo.bluetooth_cfg.bluetooth_delay);
								$('#bluetooth_delay-moreEditThingModal').on('blur', function (event) {
									const bluetooth_player_enable = $('#bluetooth-player-moreEditThingModal').is(':checked');
									const play_area_list = $('select[multiple].bluetooth-play-area-moreEditThingModal').val();
									const bluetooth_delay = $(this).val();
									const password = $('#bluetooth-password-moreEditThingModal').val();
									const bluetoothCfg = {
										...deviceInfo.bluetooth_cfg,
										bluetooth_player_enable,
										play_area: play_area_list.join(','),
										bluetooth_delay: Number(bluetooth_delay),
										password,
									};
									const data = {
										controlType:  "deviceBluetoothCfgSet", 
										thingIdentity: device.credentials.identity,
										bluetoothCfg,
									}
									// controlThing(data);
									console.log("changedTag: ", data);
								});

								//蓝牙播放区域
								$('select[multiple].bluetooth-play-area-moreEditThingModal').multiselect({
									columns  : 1,
									search   : false,
									selectAll: true,
									texts    : {
										placeholder    : '请选择播放区域',
										selectedOptions: ' 选中',
										selectAll      : '全选', 
										unselectAll    : '取消全选',
										noneSelected   : '没选中'
									}
								});
								const bluetooth_play_area_options = deviceInfo.out_channel?.channel?.map((item)=>{
									return {
										name   : item.aliase,
										value  : item.id,
										checked: deviceInfo.bluetooth_cfg.play_area.includes(item.id)
									}
								});
								$('select[multiple].bluetooth-play-area-moreEditThingModal').multiselect('loadOptions', bluetooth_play_area_options );
								const bluetooth_play_area_selectedOptionNames = bluetooth_play_area_options.filter((item)=>item.checked).map(item=>item.name).join(', ');
								const bluetooth_play_area_selectElement = $("#bluetooth-play-area-moreEditThingModal");
								const bluetooth_play_area_msOptionsWrap = bluetooth_play_area_selectElement.next(".ms-options-wrap.ms-has-selections");
								if (bluetooth_play_area_msOptionsWrap.length) {
									// 查找 ms-options-wrap 下的 button > span 元素
									const bluetooth_play_area_buttonSpan = bluetooth_play_area_msOptionsWrap.find("button > span");
									if (bluetooth_play_area_buttonSpan.length) {
										bluetooth_play_area_buttonSpan.html(bluetooth_play_area_selectedOptionNames);
									}
								}
								$('select[multiple].bluetooth-play-area-moreEditThingModal').on('change', function () {
									const bluetooth_player_enable = $('#bluetooth-player-moreEditThingModal').is(':checked');
									const play_area_list = $(this).val();
									const bluetooth_delay = $('#bluetooth_delay-moreEditThingModal').val();
									const password = $('#bluetooth-password-moreEditThingModal').val();
									const bluetoothCfg = {
										...deviceInfo.bluetooth_cfg,
										bluetooth_player_enable,
										play_area: play_area_list.join(','),
										bluetooth_delay: Number(bluetooth_delay),
										password,
									};
									const data = {
										controlType:  "deviceBluetoothCfgSet", 
										thingIdentity: device.credentials.identity,
										bluetoothCfg,
									}
									// controlThing(data);
									console.log("changedTag: ", data);
								});
							}

							if (feature_list.has_status_led || feature_list.has_stereo) {
								$('#moreEditThingModal-otherOperation-tab').show();

								// 状态灯、立体声按钮状态显示
								function toggleButtonState(button, status) {
									button.data('value', status);
									if (status) {
										button.removeClass('disabledBtn').addClass('primaryBtn');
									} else {
										button.removeClass('primaryBtn').addClass('disabledBtn');
									}
								}

								// 状态灯、立体声按钮初始化
								function setupButton(button, feature_status, enable_status, controlFunction) {
									button.show();
									button.data('value', enable_status);
									toggleButtonState(button, enable_status);

									button.on('click', function () {
										const callback = function (status) {
											moreEditThingModal.show();
											toggleButtonState(button, status);
										};

										const cancelCallback = function () {
											moreEditThingModal.show();
										};

										moreEditThingModal.hide();
										showConfirmModal("确定要进行此操作吗，是否继续？", () => {
											const current_status = Boolean(button.data('value'));
											controlFunction(!current_status, callback);
										}, cancelCallback);
									});
								}
							
								// 状态灯
								if (feature_list.has_status_led) {
									setupButton(
										$('#moreEditThingModal-otherOperation-ledBtn'),
										feature_list.has_status_led,
										feature_list.status_led_enable,
										function(new_status, callback) {
											const data = {
												controlType:  "deviceLEDSet", 
												thingIdentity: device.credentials.identity,
												enabled: new_status,
											}
											controlThing(data, callback(new_status));
										}
									);
								} else {
									$('#moreEditThingModal-otherOperation-ledBtn').hide();
								}
								// 立体声
								if (feature_list.has_stereo) {
									setupButton(
										$('#moreEditThingModal-otherOperation-stereoBtn'),
										feature_list.has_stereo,
										feature_list.stereo_enable,
										function(new_status, callback) {
											const data = {
												controlType:  "deviceStereoSet", 
												thingIdentity: device.credentials.identity,
												enabled: new_status,
											}
											controlThing(data, callback(new_status));
										}
									);
								} else {
									$('#moreEditThingModal-otherOperation-stereoBtn').hide();
								}
							}
						}
					}
					
					//获取日志
					controlThing({
						controlType:  "deviceLogGet",
						thingIdentity: device.credentials.identity
					});

					//设备操作按钮
					//重启设备
					$('#moreEditThingModal-deviceOperation-rebootBtn').on('click', function () {
						const callback = function () {
							moreEditThingModal.hide();
							editThingModal.hide();
						}
						const cancelCallback = function () {
							moreEditThingModal.show();
						}
						moreEditThingModal.hide();
						rebootThing(device.credentials.identity, callback, cancelCallback);
					});
					//删除设备
					$('#moreEditThingModal-deviceOperation-deleteBtn').on('click', function () {
						const callback = function () {
							moreEditThingModal.hide();
							editThingModal.hide();
						}
						const cancelCallback = function () {
							moreEditThingModal.show();
						}
						moreEditThingModal.hide();
						deleteThing(device.id, true, callback, cancelCallback);
					});
					//恢复出厂
					$('#moreEditThingModal-deviceOperation-resetBtn').on('click', function () {
						const callback = function () {
							moreEditThingModal.hide();
							editThingModal.hide();
							deleteThing(device.id, false);
						}
						const cancelCallback = function () {
							moreEditThingModal.show();
						}
						moreEditThingModal.hide();
						restoreThing(device.credentials.identity, callback, cancelCallback);
					});
				}

				//查看设备详情
				function viewThing(id, thingIdentity) {
					window.location.href = '{{printf "%s/things/" pathPrefix}}' + id;
				}

				//删除确认，接触通道关联
				function deleteThing(thingID, showConfirm, callback, cancelCallback) {
					const disconnectThenDeleteThing = () => {
						fetch(`/ui/things/${thingID}/channelsInJSON?page=1&limit=1000`, {
							method: "GET",
						})
							.then(response => {
								if (!response.ok) {
									throw new Error('Network response was not ok');
								}
								return response.json(); // 直接将流转换为JSON对象
							})
							.then(json => {
								const data = json.data;
								const channelsData = JSON.parse(data).channelsData;
								const channels = channelsData.groups;
								const fetchPromises = channels.map((channel) => disconnectThingsAndChannels(thingID, channel.id));
								Promise.all(fetchPromises).then(responses => {})
									.then(jsonData => { handleDelete(thingID, callback) })
									.catch(error => {
										// 如果有任何错误发生，这里会捕获到
										console.error('An error occurred:', error);
									});
							});
					}
					if (showConfirm) {
						showConfirmModal("确定要删除所选设备吗？", () => {
							disconnectThenDeleteThing();
						}, cancelCallback);
					} else {
						disconnectThenDeleteThing();
					}
				}

				//删除设备
				function handleDelete(thingID, callback) {
					fetch(`/ui/things/${thingID}`, {
						method: "DELETE",
					})
						.then(function (response) {
							if (!response.ok) {
								const errorMessage = response.headers.get("X-Error-Message");
								if (errorMessage) {
									console.log(errorMessage);
								} else {
									console.log(`Error: ${response.status}`);
								}
							} else {
								if (callback && typeof callback === "function") {
									callback();
								}
								const reqOnlineStatus = sessionStorage.getItem("onlineStatus");
								window.location.href = `/ui/things?limit=1000&onlineStatus=${reqOnlineStatus}`;
							}
						})
						.catch((error) => {
							if (callback && typeof callback === "function") {
								callback();
							}
							const reqOnlineStatus = sessionStorage.getItem("onlineStatus");
							window.location.href = `/ui/things?limit=1000&onlineStatus=${reqOnlineStatus}`;
						});
				}

				//恢复出厂
				function restoreThing(thingIdentity, callback, cancelCallback) {
					showConfirmModal("恢复出厂设置后需要重新添加该设备，确认继续？", () => {
						const data = {
							controlType:  "deviceRestore", 
							thingIdentity: thingIdentity,
						};
						controlThing(data, callback);
					}, cancelCallback);
				}

				//重启设备
				function rebootThing(thingIdentity, callback, cancelCallback) {
					showConfirmModal("确定要重启所选设备吗？", () => {
						const data = {
							controlType:  "deviceReboot", 
							thingIdentity: thingIdentity,
						};
						controlThing(data, callback);
					}, cancelCallback);
				}

				//控制设备
				function controlThing(controlThingData, callback = ()=>{}) {
					const domainID = sessionStorage.getItem("domainID");
					if (domainID) {
						fetch(`/ui/domains/${domainID}/domainInJSON`, {
							method: "GET",
						})
							.then(response => {
								if (!response.ok) {
									throw new Error('Network response was not ok');
								}
								return response.json(); // 直接将流转换为JSON对象
							})
							.then(json => {
								const data = json.data;
								const domainData = JSON.parse(data).domainData;
								const comID = domainData.metadata["comID"];
								if (comID) {
									const data = {
										channelID: comID, 
										...controlThingData
									}
									postMessage(data, callback);
								}
							});
					} else {
						redirectToLogin();
					}
				}

				//更改设备在线状态
				function changeOnlineStatus(thing){
					const onlineStatus = thing.metadata && thing.metadata.is_online === "1";
					if (onlineStatus) {
						$(`#${thing.id}-thingCardContent`).css('background', 'white');
						$(`#${thing.id}-rebootBtn`).css('display', 'block');
						$(`#${thing.id}-editBtn`).css('display', 'block');
					} else {
						$(`#${thing.id}-thingCardContent`).css('background', 'lightgray');
						$(`#${thing.id}-rebootBtn`).css('display', 'none');
						$(`#${thing.id}-editBtn`).css('display', 'none');
					}
					$(`#${thing.id}-deviceName`).html(thing.name);
					$(`#${thing.id}-deviceName`).prop("title", thing.name);
				}

				//轮询刷新thingslist，以实现监听things在线状态的
				function refreshThingsData() {
					// 获取当前页面的完整URL
					const currentUrl = window.location.href;
					// 创建URL对象
					const urlObj = new URL(currentUrl);
					// 使用URL对象的searchParams属性获取URLSearchParams对象
					const searchParams = urlObj.searchParams;
					// 使用get方法从URLSearchParams对象中获取page和limit的值
					const page = searchParams.get('page') || 1;
					const limit = searchParams.get('limit') || 1000;
					const reqOnlineStatus = sessionStorage.getItem("onlineStatus") || 1;
					fetch(`/ui/things/thingsInJSON?page=${page}&limit=${limit}&onlineStatus=${reqOnlineStatus}`, {
						method: "GET",
					})
						.then(response => {
							if (!response.ok) {
								throw new Error('Network response was not ok');
							}
							return response.json(); // 直接将流转换为JSON对象
						})
						.then(json => {
							const data = json.data;
							const thingsData = JSON.parse(data).thingsData;
							const things = thingsData && typeof thingsData === 'object' && thingsData.things && typeof thingsData.things === 'object' ?  
								thingsData.things.filter((thing)=>{
									//identity 中有下划线则表示为多通道，默认在设备页面隐藏
									return thing.credentials.identity && !thing.credentials.identity.includes("_");
								}) || [] : [];
							newDevices = {};
							// 所有在线\离线
							if (things.length) {
								things.forEach(device => {
									newDevices[device.id] = {
									id: device.id,
									name: device.name,
									credentials: device.credentials,
									metadata: device.metadata,
									status: device.status,
									created_at: device.created_at,
									updated_at: device.updated_at,
									};
								});
								updateThingsGrid(things);
							} else {
								currentDevices = {};
								$(`#thingsGrid`).empty();
							};
						})
						.catch(error => {
							currentDevices = {};
							$(`#thingsGrid`).empty();
						});
				}
				
				//更新设备显示表格
				function updateThingsGrid(devices) {
					const $thingsGrid = $('#thingsGrid');
					const currentDevicesLength = Object.keys(currentDevices).length;
					const newDevicesLength = Object.keys(newDevices).length;

					if (currentDevicesLength > newDevicesLength) {
						// 移除不在(查询在线时刚离线的，查询离线时刚上线的)的设备\
						Object.keys(currentDevices).forEach((curId)=>{
							if (
								(typeof newDevices === 'object' && Object.entries(newDevices).length === 0) || 
								(newDevices[curId] === null || newDevices[curId] === undefined) ||
								(typeof newDevices[curId] === 'object' && Object.entries(newDevices[curId]).length === 0)
							) {
								// 移除不在(查询在线时离线的，查询离线时上线的)的设备
								$(`#${curId}-thingCard`).remove();
							}
						});
					} else if (currentDevicesLength < newDevicesLength) {
						// 新增(查询在线时刚上线的，查询离线时刚离线的)的设备]
						Object.keys(newDevices).forEach((newId)=>{
							if (
								(typeof currentDevices === 'object' && Object.entries(currentDevices).length === 0) || 
								(currentDevices[newId] === null || currentDevices[newId] === undefined) ||
								(typeof currentDevices[newId] === 'object' && Object.entries(currentDevices[newId]).length === 0)
							) {
								const device = newDevices[newId];
								updateThingsGridDom(device);
							}
						});
					} else if (currentDevicesLength === newDevicesLength) {
						Object.keys(newDevices).forEach((newId)=>{
							const device = newDevices[newId];
							changeOnlineStatus(device);
						});
					}

					currentDevices = {};
					currentDevices = {...newDevices};
				}

				function updateThingsGridDom(device) {
					const deviceIcon = getDeviceIcon(device);
					const imgSpan = `<img loading="lazy" id="${device.id}-thingIcon" src="/images/${deviceIcon}" class="hoverCardIcon" />`;
					const btnSpan = `
						<div class="dropdown" style="float: right;">
							<button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
								<i class="fa-solid fa-ellipsis"></i>
							</button>
							<ul class="dropdown-menu">
								<li style="display: none;">
									<a class="dropdown-item" onclick="viewThing('${device.id}')">
										<i class="fa-solid fa-info" style="width: 16px;"></i> 查看
									</a>
								</li>
								<li 
									id="${device.id}-rebootBtn" 
									style="display: ${device.metadata && Number(device.metadata.is_online) === 1 ? 'block':'none'}"
								>
									<a class="dropdown-item" onclick="rebootThing('${device.credentials.identity}')">
										<i class="fa-solid fa-power-off" style="width: 16px;"></i> 设备重启
									</a>
								</li>
								<li 
									id="${device.id}-editBtn"
									style="display: ${device.metadata && Number(device.metadata.is_online) === 1 ? 'block':'none'}"
								>
									<a class="dropdown-item" onclick="editThing('${device.id}')">
										<i class="fa-solid fa-gear" style="width: 16px;"></i> 设备设置
									</a>
								</li>
								<li id="${device.id}-deleteBtn">
									<a class="dropdown-item" onclick="deleteThing('${device.id}', true)">
										<i class="fa-solid fa-trash-can" style="width: 16px;"></i> 设备删除
									</a>
								</li>
							</ul>
						</div>
					`;
					const deviceChannelIconDiv = device.metadata && 
						device.metadata.out_channel_array && 
						device.metadata.out_channel_array.length > 1 ? 
							`
								<div class="row" style="position: absolute; bottom: 40px; padding-left: 24px;">
									${device.metadata.out_channel_array.map(($o, $i) => {
										return `<i 
													class="fa-solid fa-${$i+1} deviceChannelIcon" 
													data-bs-toggle="tooltip" 
													data-bs-placement="bottom" 
													data-bs-title="${$o.aliase}" 
													title="${$o.aliase}"
												>
												</i>`
									}).join('')}
								</div>
							` : ``;
					const $thingCard = $(`
						<div class="mb-3" id="${device.id}-thingCard" style="width: 20%;">
							<div class="hoverCard card" id="${device.id}-thingCardContent" >
								<div class="card-body">
									<div class="row">
										<div class="col">
											${imgSpan}
										</div>
										<div class="col">
											${btnSpan}
										</div>
									</div>
									<div class="row" style="margin-top:50px">
										${deviceChannelIconDiv}
										<h5 
											class="card-title truncate-text" 
											data-bs-toggle="tooltip" 
											data-bs-placement="bottom" 
											data-bs-title="${device.name}"
											title="${device.name}"
										>
											${device.name}
										</h5>
									</div>
								</div>
							</div>
						</div>
					`);
					$(`#thingsGrid`).append($thingCard);
				}

				//根据在线类型获取设备列表
				function getThingsList(onlineStatus, isRender) {
					currentDevices = {}, newDevices = {};
					fetch(`/ui/things/thingsInJSON?limit=1000&onlineStatus=${onlineStatus}`, {
						method: "GET",
					})
						.then(response => {
							pollingIntervalIdThings = startPollingThings();
							if (!response.ok) {
								throw new Error('Network response was not ok');
							}
							return response.json(); // 直接将流转换为JSON对象
						})
						.then(json => {
							const data = json.data;
							const thingsData = JSON.parse(data).thingsData;
							const things = thingsData.things.filter((thing)=>{
								//identity 中有下划线则表示为多通道，默认在设备页面隐藏
								return thing.credentials && !thing.credentials.identity.includes("_");
							}) || [];

							if (things.length) {
								things.forEach(device => {
									currentDevices[device.id] = {
										id: device.id,
										name: device.name,
										credentials: device.credentials,
										metadata: device.metadata,
										status: device.status,
										created_at: device.created_at,
										updated_at: device.updated_at,
									};
								});
								if (isRender) {
									updateThingsGrid(things);
								}
							}
						})
						.catch(error => {});
				}

				// 获取所有设备列表
				function getAllThingsList(callback) {
					allThingsList = [];
					fetch(`/ui/things/thingsInJSON?limit=1000&onlineStatus=2`, {
						method: "GET",
					})
						.then(response => {
							if (!response.ok) {
								throw new Error('Network response was not ok');
							}
							return response.json(); // 直接将流转换为JSON对象
						})
						.then(json => {
							const data = json.data;
							const thingsData = JSON.parse(data).thingsData;
							const things = thingsData.things.filter((thing)=>{
								//identity 中有下划线则表示为多通道，默认在设备页面隐藏
								return thing.credentials && !thing.credentials.identity.includes("_");
							}) || [];

							if (things.length) {
								allThingsList = _.cloneDeep(things);
							}
							if (callback && typeof callback === 'function') {
								callback();
							}
						})
						.catch(error => {
							if (callback && typeof callback === 'function') {
								callback();
							}
						});
				}

				//给设备发信息
				function postMessage(data, callback) {
					const url = window.location.href; // 获取当前页面的URL
					const address = new URL(url);
					const port =  sessionStorage.getItem("socketBridgePort") || "63001";
					const userInfoStr = sessionStorage.getItem("userInfo");
					userInfo = JSON.parse(userInfoStr);
					const queryData = {
						...data,
						host: address.hostname,
						comID: data.channelID,
						username: userInfo.credentials.identity,
					}
					fetch(`http://${address.hostname}:${port}/controlDevice`, {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify(queryData),
					})
						.then(response => {
							if (callback && typeof callback === 'function') {
								callback();
							}
							console.log("postMessage: ", response)
						})
						.catch((error) => {
							console.error("error postMessage: ", error);
						});
				}
				
				//扫描添加设备弹框中手动设置网络信息验证
				function validateAndSave(property, postfix) {
					const $inputElement = $(`#${property}-deviceNetCfg${postfix}`);
					$inputElement.on('change blur keyup', function(event) {
						const deviceName = $(this).attr('data-device_name') || null;
						const deviceID = $(this).attr('data-device_id') || null;
						const deviceInfo = postfix ? 
							allThingsList.find(thing => thing.id === deviceID) : 
							scanNewThingsList.find(item => item.device_name === deviceName);
						const dhcp_enable = postfix ?  
							document.getElementById("dhcp_enable-deviceNetCfg-moreEditThingModal-auto").checked : 
							deviceInfo.netcfg.dhcp_enable;
						const value = $(this).val();
						const $errorElement = $(`#${property}Error${postfix}`);
						if (property === 'alias') {
							if (value) {
								$errorElement.empty();
								if (event.type === 'blur' && !postfix) {
									scanNewThingsList = scanNewThingsList.map(item => {
										if (item.device_name === deviceName) {
											item[`device_aliase`] = value;
										}
										return item;
									});
								}
							} else {
								$errorElement.html('请输入设备名称');
							}
						} else {
							if (!dhcp_enable) {
								if (IPV4REGX.test(value)) {
									$errorElement.empty();
									if (event.type === 'blur' && !postfix) {
										scanNewThingsList = scanNewThingsList.map(item => {
											if (item.device_name === deviceName) {
												item.netcfg[`static_${property}`] = value;
											}
											return item;
										});
									}
								} else {
									$errorElement.html(IPERRORMSG);
								}
							}
						}
					});
				}

				//扫描设备添加弹框设备列表-配置网络
				function deviceNetCfg(e) {
					if (event.target.classList.contains('form-check-input')) {
						// 阻止事件冒泡或默认行为
						e.stopPropagation();
					} else {
						scanThingsModal.hide();
						deviceNetCfgModal.show();

						$('#aliasError').empty();
						$('#ipError').empty();
						$('#gatewayError').empty();
						$('#netmaskError').empty();
						$('#dns1Error').empty();
						$('#dns2Error').empty();

						// event.currentTarget：指向事件监听器所附加的元素，即 <div> 元素。
						// event.target：指向触发事件的实际元素，即 <span> 或 <img> 元素。
						const deviceName = e.currentTarget.dataset.device_name;
						const deviceInfo = scanNewThingsList.find((item)=>item.device_name === deviceName); 
						let ip = deviceInfo.netcfg.static_ip, 
							gateway = deviceInfo.netcfg.static_gateway,
							netmask = deviceInfo.netcfg.static_netmask, 
							dns1 = deviceInfo.netcfg.static_dns1, 
							dns2 = deviceInfo.netcfg.static_dns2;
							dhcp_enable = "0",
							disabled = false;
						if (deviceInfo.netcfg.dhcp_enable) {
							ip = deviceInfo.netcfg.dhcp_ip;
							gateway = deviceInfo.netcfg.dhcp_gateway;
							netmask = deviceInfo.netcfg.dhcp_netmask;
							dns1 = deviceInfo.netcfg.dhcp_dns1;
							dns2 = deviceInfo.netcfg.dhcp_dns2;
							dhcp_enable = "1";
							disabled = true;
						}

						$('#dhcp_enable-deviceNetCfg').val(dhcp_enable);
						$('#alias-deviceNetCfg').attr('data-device_name', deviceName);
						$('#ip-deviceNetCfg').attr('data-device_name', deviceName);
						$('#gateway-deviceNetCfg').attr('data-device_name', deviceName);
						$('#netmask-deviceNetCfg').attr('data-device_name', deviceName);
						$('#dns1-deviceNetCfg').attr('data-device_name', deviceName);
						$('#dns2-deviceNetCfg').attr('data-device_name', deviceName);
						$('#dhcp_enable-deviceNetCfg').attr('data-device_name', deviceName);
						$('#deviceNetCfgModal-confirm-button').attr('data-device_name', deviceName);

						$('#alias-deviceNetCfg').val(deviceInfo.device_aliase);
						$('#ip-deviceNetCfg').val(ip);
						$('#gateway-deviceNetCfg').val(gateway);
						$('#netmask-deviceNetCfg').val(netmask);
						$('#dns1-deviceNetCfg').val(dns1);
						$('#dns2-deviceNetCfg').val(dns2);

						$('#ip-deviceNetCfg').prop('disabled', disabled);
						$('#gateway-deviceNetCfg').prop('disabled', disabled);
						$('#netmask-deviceNetCfg').prop('disabled', disabled);
						$('#dns1-deviceNetCfg').prop('disabled', disabled);
						$('#dns2-deviceNetCfg').prop('disabled', disabled);
					}
				}

				//扫描添加设备弹框设备列表-勾选设备
				function onSelectNewThing(e) {
					e.stopPropagation();
					const checkbox = e.target;
					const isChecked = checkbox.checked;
					const value = e.target.value;
					//判断是否全选，全反选
					if (value === 'selectAll') {
						if (isChecked) {
							selectedNewThingNames = scanNewThingsList.map((item)=>{
								return item.device_name;
							});
							scanNewThingsList.forEach((item)=>{
								$(`#checkbox_${item.device_name}`).prop("checked", true);
							});
						} else {
							selectedNewThingNames = [];
							scanNewThingsList.forEach((item)=>{
								$(`#checkbox_${item.device_name}`).prop("checked", false);
							});
						}
					} else {
						if (isChecked) {
							if (!selectedNewThingNames.includes(value)) {
								selectedNewThingNames.push(value);
							}
						} else {
							selectedNewThingNames = selectedNewThingNames.filter((name)=> name !== value)
						}
					}
					
					if (selectedNewThingNames.length) {
						$("#scan-add-thing-button").removeAttr("disabled");
						//判断全选框是否半勾选
						if (selectedNewThingNames.length === scanNewThingsList.length) {
							$(`#checkbox_selectAll`).prop("checked", true);
							$(`#checkbox_selectAll`).prop("indeterminate", false);
						} else {
							$(`#checkbox_selectAll`).prop("indeterminate", true);
							$(`#checkbox_selectAll`).prop("checked", false);
						}
					} else {
						$("#scan-add-thing-button").attr("disabled", true);
						$(`#checkbox_selectAll`).prop("indeterminate", false);
						$(`#checkbox_selectAll`).prop("checked", false);
					}
				}

				//显示扫描添加设备弹框设备列表
				function showNewThingsGrid (thingsList, selectedThingsIds) {
					scanThingsModal.show();
					$(`#scanThingsGrid`).empty();

					//全选按钮
					const $selectAll = $(`
						<li class="list-group-item newThingItemList" style="background: whitesmoke;">
							<input 
								class="form-check-input" 
								type="checkbox" 
								value="selectAll" 
								id="checkbox_selectAll"
								onchange="onSelectNewThing(event)"
							/>
							<label class="form-check-label" for="checkbox_selectAll" style="margin-left:5px">
								全选
							</label>
						</li>
					`);
					$(`#scanThingsGrid`).append($selectAll);

					//设备列表
					thingsList.forEach((thing, index)=>{
						const deviceIcon = getDeviceIcon(thing);
						const $thingList = $(`
							<li 
								class="list-group-item newThingItemList" 
								onclick="deviceNetCfg(event)"
								data-device_name="${thing.device_name}" 
							>
								<input 
									class="form-check-input" 
									type="checkbox" 
									value="${thing.device_name}" 
									id="checkbox_${thing.device_name}"
									onchange="onSelectNewThing(event)"
									data-device_name="${thing.device_name}" 
									${selectedThingsIds.includes(thing.device_name) ? `checked` : ``}
								/>
								<label class="form-check-label" data-device_name="${thing.device_name}" >
									<img
										loading="lazy" 
										src="/images/${deviceIcon}" 
										style="height: 18px; margin-top: -3px; margin-left: 5px;"
										data-device_name="${thing.device_name}" 
									/>
									<span data-device_name="${thing.device_name}" >${thing.device_aliase}</span>
								</label>
							</li>
						`);
						$(`#scanThingsGrid`).append($thingList);
					});

					if (selectedThingsIds.length) {
						$("#scan-add-thing-button").removeAttr("disabled");
						//判断全选框是否半勾选
						if (selectedThingsIds.length === thingsList.length) {
							$(`#checkbox_selectAll`).prop("checked", true);
							$(`#checkbox_selectAll`).prop("indeterminate", false);
						} else {
							$(`#checkbox_selectAll`).prop("indeterminate", true);
							$(`#checkbox_selectAll`).prop("checked", false);
						}
					} else {
						$("#scan-add-thing-button").attr("disabled", true);
						$(`#checkbox_selectAll`).prop("indeterminate", false);
						$(`#checkbox_selectAll`).prop("checked", false);
					}
				}

				//获取udp组播扫描到的新设备
				function scanNewThings(){
					const url = window.location.href; // 获取当前页面的URL
					const address = new URL(url);
					const port =  sessionStorage.getItem("socketBridgePort") || "63001";
					scanNewThingsList = []; selectedNewThingNames = [];
					fetch(`http://${address.hostname}:${port}/devices`, {
						method: "GET",
					})
						.then(response => {
							// 检查响应的内容类型是否为JSON
							if (
								response.headers.get('Content-Type') && 
								response.headers.get('Content-Type').includes('application/json')
							) {
								// 检查响应的内容长度
								if (response.headers.get('Content-Length') === '0') {
									// 如果内容长度为0，返回一个空对象或执行其他逻辑
									return {};
								}
								// 返回响应的JSON解析结果
								return response.json();
							} else {
								// 如果内容类型不是JSON，抛出错误或执行其他逻辑
								throw new Error('Response content type is not JSON');
							}
						})
						.then(json => {
							if (json && JSON.stringify(json) !== '{}' && json.length) {
								scanNewThingsList = json.map((item)=>{
									return JSON.parse(item.message)
								})
								showNewThingsGrid(scanNewThingsList, selectedNewThingNames)
							} else {
								showAlert("info", "没有可添加设备");
							}
						})
				}

				//添加扫描设备
				function addScanNewThings() {
					
					//获取当前domain的comID号
					const domainID = sessionStorage.getItem("domainID");
					fetch(`/ui/domains/${domainID}/domainInJSON`, {
						method: "GET",
					})
						.then(response => {
							if (!response.ok) {
								throw new Error('Network response was not ok');
							}
							return response.json(); // 直接将流转换为JSON对象
						})
						.then(json => {
							const data = json.data;
							const domainData = JSON.parse(data).domainData;
							const comID = domainData.metadata["comID"];
							const selectedNewThings = scanNewThingsList.filter(item => selectedNewThingNames.includes(item.device_name));
							const queryData = selectedNewThings.map((thing)=>{
								return {
									name: thing.device_aliase,
									credentials: {
										identity: thing.device_name,
										secret: thing.device_name,
									},
									tags: [],
									metadata: {
										product_name: thing.product_name,
										is_online: "0",
										out_channel: thing.out_channel && thing.out_channel.channel ? `${thing.out_channel.channel.length}` : "0",
										out_channel_array: thing.out_channel && thing.out_channel.channel ? thing.out_channel.channel : [],
										is_channel: "0",
										aliase: thing.out_channel && thing.out_channel.channel && thing.out_channel.channel.length ? 
											thing.device_aliase + "_" + thing.out_channel.channel[0].aliase : thing.device_aliase
									}
								}
							});
							fetch(`/ui/things/batch`, {
								method: "POST",
								headers: {
									"Content-Type": "application/json",
								},
								body: JSON.stringify(queryData),
							})
								.then(response => {
									const url = window.location.href; // 获取当前页面的URL
									const address = new URL(url);
									const port =  sessionStorage.getItem("socketBridgePort") || "63001";
									const newQueryData = selectedNewThings.map((item)=>{
										item.tenant_id = comID;
										item.netcfg.mqtt_server = "nxt-gateway.local" || address.hostname;
										return item;
									});
									// 添加成功后需要向UDP发送回执
									fetch(`http://${address.hostname}:${port}/addDeviceReply`, {
										method: "POST",
										headers: {
											"Content-Type": "application/json",
										},
										body: JSON.stringify(newQueryData),
									})
										.then(response => {
											// 获取当前 URL
											const currentUrl = new URL(window.location.href);
											const reqOnlineStatus = sessionStorage.getItem("onlineStatus");
											// 修改查询参数
											currentUrl.searchParams.set('onlineStatus', reqOnlineStatus);
											// 跳转到新的 URL
											window.location.href = currentUrl.toString();
										});
								});
						})
				}	
		   	</script>
        </body>
    </html>
{{ end }}
