<!-- Copyright (c) Abstract Machines
SPDX-License-Identifier: Apache-2.0 -->

{{ define "things" }}
    <!doctype html>
    <html lang="en">
        <head>
            <title>设备</title>
            {{ template "header" }}
        </head>

        <body>
            {{ template "navbar" . }}
            <div class="main-content pt-3">
                <div class="container-fluid">
                    <div class="row-mb-3 p-3">
                        <div class="col-lg-12 mx-auto py-3">
                            {{ template "breadcrumb" . }}
                            <div class="row">
                                <div class="buttons mb-3">
                                    <!-- Button trigger modal -->
                                    <button type="button" class="btn body-button" onclick="openModal('single')">添加设备</button>

                                    <!-- add thing modal -->
                                    <div 
                                      class="modal fade" 
                                      id="addThingModal" 
                                      tabindex="-1" 
                                      role="dialog" 
                                      aria-labelledby="addThingModalLabel"
                                      data-bs-backdrop="static" 
                                      data-bs-keyboard="false"  
                                      aria-hidden="true"
                                    >
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h1 class="modal-title" id="addThingModalLabel">添加设备</h1>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <form id="thingform">
                                                    <div class="modal-body">
                                                        <div id="alertMessage"></div>

                                                        <div class="mb-3">
                                                            <label for="name" class="form-label">名称</label>
                                                            <input type="text" class="form-control name-field" name="name" id="name" placeholder="设备名称" />
                                                            <div id="nameError" class="text-danger"></div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="identity" class="form-label">设备身份识别码</label>
                                                            <input type="text" class="form-control" name="identity" id="identity" placeholder="设备身份识别码" />
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="secret" class="form-label">密码</label>
                                                            <input type="text" class="form-control" name="secret" id="secret" placeholder="设备密码" />
                                                            <div id="secretError" class="error-message"></div>
                                                        </div>
                                                        <div class="mb-3" style="display: none;">
                                                            <label for="thingsTags" class="form-label">标识</label>
                                                            <div id="thingsTagsList" onclick="deleteItem(event)"></div>
                                                            <input
                                                                type="text"
                                                                class="form-control tags-field"
                                                                name="tags"
                                                                id="thingTags"
                                                                aria-describedby="tagHelp"
                                                                onkeydown="addItem(event, 'thingTags', 'thingsTagsList')"
                                                                placeholder="Add a tag"
                                                            />
                                                            <div id="tagHelp" class="form-text">以字符串数组形式输入标识.</div>
                                                            <div id="tagsError" class="text-danger"></div>
                                                        </div>
                                                        <div class="mb-3" style="display: none;">
                                                            <label for="metadata" class="form-label">附加属性</label>
                                                            <div class="metadata-field">
                                                                <textarea name="metadata" id="metadata"></textarea>
                                                            </div>
                                                            <div id="metadataHelp" class="form-text">以JSON形式输入附加属性.</div>
                                                            <div id="metadataError" class="text-danger"></div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                                        <button type="submit" class="btn body-button" id="create-thing-button" onclick="submitItemList('thingTags', 'thingsTagsList')">确定</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Button trigger modal -->
                                    <button type="button" class="btn body-button" onclick="openModal('bulk')" style="display: none;">批量添加设备</button>

                                    <!-- add things modal -->
                                    <div class="modal fade" id="addThingsModal" tabindex="-1" role="dialog" aria-labelledby="addThingsModalLabel" aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h1 class="modal-title" id="addThingsModalLabel">批量添加设备</h1>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <form method="post" enctype="multipart/form-data" id="bulkThingsForm">
                                                    <div class="modal-body">
                                                        <div id="alertBulkMessage"></div>

                                                        <div class="form-group mb-3">
                                                            <label for="thingsFile">
                                                                添加包含设备名称以及附加属性的CSV文件(附加属性可以为空). 在
                                                                <a href="/samples/things.csv" download="things.csv">这里</a>
                                                                可以下载模版文件
                                                            </label>
                                                            <input type="file" class="form-control-file" id="thingsFile" name="thingsFile" required />
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                                            <button type="submit" value="upload" class="btn body-button">确定</button>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- edit thing modal -->
                                    <div 
                                      class="modal fade" 
                                      id="editThingModal" 
                                      tabindex="-1" 
                                      role="dialog" 
                                      aria-labelledby="editThingModalLabel" 
                                      data-bs-backdrop="static" 
                                      data-bs-keyboard="false" 
                                      aria-hidden="true"
                                    >
                                      <div class="modal-dialog" role="document">
                                          <div class="modal-content">
                                              <div class="modal-header">
                                                  <h1 class="modal-title" id="editThingModalLabel">修改设备</h1>
                                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                              </div>
                                              <form id="editThingform">
                                                  <div class="modal-body">
                                                      <div id="editAlertMessage"></div>
                                                      <div class="mb-3">
                                                          <label for="name" class="form-label">名称</label>
                                                          <input type="text" class="form-control name-field" name="name" id="editName" placeholder="设备名称" />
                                                          <div id="editNameError" class="text-danger"></div>
                                                      </div>
                                                      <div class="mb-3">
                                                          <label for="id" class="form-label">设备ID</label>
                                                          <input type="text" class="form-control" name="id" id="editID" placeholder="设备ID" readonly />
                                                      </div>
                                                  </div>
                                                  <div class="modal-footer">
                                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                                      <button type="submit" class="btn body-button" id="edit-thing-button">确定</button>
                                                  </div>
                                              </form>
                                          </div>
                                      </div>
                                    </div>

                                    <button type="button" class="btn body-button" onclick="openModal('scan')">扫描添加设备</button>
                                    <div 
                                      class="modal fade" 
                                      id="scanThingsModal" 
                                      tabindex="-1" 
                                      role="dialog" 
                                      aria-labelledby="scanThingsModalLabel" 
                                      data-bs-backdrop="static" 
                                      data-bs-keyboard="false" 
                                      aria-hidden="true"
                                    >
                                      <div class="modal-dialog" role="document">
                                          <div class="modal-content">
                                              <div class="modal-header">
                                                  <h1 class="modal-title" id="scanThingsModalLabel">扫描添加设备</h1>
                                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                              </div>
                                              <div class="modal-body">
                                                  <div class="row">
                                                    <ul class="list-group" id="scanThingsGrid" style="padding-left: 10px;max-height: 400px;overflow-y: auto;">
                                                      <!-- <li class="list-group-item">An item</li> -->
                                                    </ul>
                                                  </div>
                                              </div>
                                              <div class="modal-footer">
                                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                                  <button type="button" class="btn body-button" id="scan-add-thing-button" disabled>添加设备</button>
                                              </div>
                                          </div>
                                      </div>
                                    </div>

                                    <div 
                                      class="modal fade" 
                                      id="deviceNetCfgModal" 
                                      tabindex="-1" 
                                      role="dialog" 
                                      aria-labelledby="deviceNetCfgModalLabel" 
                                      data-bs-backdrop="static" 
                                      data-bs-keyboard="false" 
                                      aria-hidden="true"
                                    >
                                      <div class="modal-dialog" role="document">
                                          <div class="modal-content">
                                              <div class="modal-header">
                                                  <h1 class="modal-title" id="scanThingsModalLabel">有线网络设置</h1>
                                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                              </div>
                                              <div class="modal-body">
                                                <div class="mb-3">
                                                  <label for="dhcp_enable" class="form-label">设置IP</label>
                                                  <select 
                                                    class="form-control" 
                                                    name="dhcp_enable" 
                                                    id="dhcp_enable-deviceNetCfg"
                                                  >
                                                    <option value="0">手动</option>
                                                    <option value="1">自动</option>
                                                  </select>
                                                </div>
                                                <div class="mb-3">
                                                  <label for="ip" class="form-label">IP地址</label>
                                                  <input type="text" class="form-control" name="ip" id="ip-deviceNetCfg" placeholder="IP地址" />
                                                  <div id="ipError" class="text-danger"></div>
                                                </div>
                                                <div class="mb-3">
                                                  <label for="gateway" class="form-label">网关</label>
                                                  <input type="text" class="form-control" name="gateway" id="gateway-deviceNetCfg" placeholder="网关" />
                                                  <div id="gatewayError" class="text-danger"></div>
                                                </div>
                                                <div class="mb-3">
                                                  <label for="netmask" class="form-label">子网掩码</label>
                                                  <input type="text" class="form-control" name="netmask" id="netmask-deviceNetCfg" placeholder="子网掩码" />
                                                  <div id="netmaskError" class="text-danger"></div>
                                                </div>
                                                <div class="mb-3">
                                                  <label for="dns1" class="form-label">主DNS</label>
                                                  <input type="text" class="form-control" name="dns1" id="dns1-deviceNetCfg" placeholder="主DNS" />
                                                  <div id="dns1Error" class="text-danger"></div>
                                                </div>
                                                <div class="mb-3">
                                                  <label for="dns2" class="form-label">从DNS</label>
                                                  <input type="text" class="form-control" name="dns2" id="dns2-deviceNetCfg" placeholder="从DNS" />
                                                  <div id="dns2Error" class="text-danger"></div>
                                                </div>
                                              </div>
                                              <div class="modal-footer">
                                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                                  <button 
                                                    type="button" 
                                                    class="btn body-button" 
                                                    id="deviceNetCfgModal-confirm-button"
                                                  >
                                                    确定
                                                  </button>
                                              </div>
                                          </div>
                                      </div>
                                    </div>
                                </div>
                                <div class="table-responsive table-container">
                                    <!-- {{ template "tableheader" . }} -->
                                    <div class="row buttons mb-3">
                                      <div class="btn-group col-4 offset-4" role="group">
                                        <input type="radio" class="btn-check" name="btnOnlineStatus" id="btnAll" autocomplete="off" />
                                        <label class="btn btn-outline-primary" for="btnAll">全部</label>
                                      
                                        <input type="radio" class="btn-check" name="btnOnlineStatus" id="btnOnline" autocomplete="off" />
                                        <label class="btn btn-outline-primary" for="btnOnline">在线</label>
                                      
                                        <input type="radio" class="btn-check" name="btnOnlineStatus" id="btnOffline" autocomplete="off" />
                                        <label class="btn btn-outline-primary" for="btnOffline">离线</label>
                                      </div>
                                    </div>
                                    <div class="row" id="thingsGrid">
                                      {{ range $i, $t := .Things }}
                                        <div class="col-sm-3 mb-3 mb-sm-0" id="{{ $t.ID }}-thingCard">
                                          <div class="channel-thing-card card">
                                            <div class="card-body">
                                              <h5 class="card-title">{{ $t.Name }}</h5>
                                              <p>{{ $t.Credentials.Identity }}</p>
                                              <p>{{ $t.Credentials.Secret }}</p>
                                              <p id="{{ $t.ID }}-onlineStatusTD" class="card-text">
                                                {{ if eq $t.Metadata.isOnline "1" }}
                                                    <span class="badge rounded-pill enabled-pill">在线</span>
                                                {{ else }}
                                                    <span class="badge rounded-pill disabled-pill">离线</span>
                                                {{ end }}
                                              </p>
                                              <p>
                                                <button class="btn body-button" onclick="viewThing('{{ $t.ID }}')" title="查看">
                                                  <i class="fa-solid fa-info"></i>
                                                </button>
                                                {{ if eq $t.Metadata.isOnline "1" }}
                                                  <button
                                                    id="{{ $t.ID }}-rebootBtn"
                                                    class="btn body-button"
                                                    onclick="conntrolThing('{{ $t.ID }}', '{{ $t.Credentials.Identity }}', 'reboot')"
                                                    title="重启"
                                                  >
                                                    <i class="fa-solid fa-arrows-rotate"></i>
                                                  </button>
                                                  <button 
                                                    id="{{ $t.ID }}-deleteBtn" 
                                                    class="btn body-button" 
                                                    title="删除" 
                                                    onclick="deleteThing('{{ $t.ID }}')" 
                                                    disabled
                                                  >
                                                    <i class="fa-solid fa-trash-can"></i>
                                                  </button>
                                                  <button 
                                                    id="{{ $t.ID }}-editBtn" 
                                                    class="btn body-button" 
                                                    title="修改" 
                                                    onclick="editThing('{{ $t.ID }}', '{{ $t.Name }}')" 
                                                    disabled
                                                  >
                                                    <i class="fa-solid fa-pencil-alt"></i>
                                                  </button>
                                                {{ else }}
                                                  <button
                                                    id="{{ $t.ID }}-rebootBtn"
                                                    class="btn body-button"
                                                    onclick="conntrolThing('{{ $t.ID }}', '{{ $t.Credentials.Identity }}', 'reboot')"
                                                    title="重启"
                                                    disabled
                                                  >
                                                    <i class="fa-solid fa-arrows-rotate"></i>
                                                  </button>
                                                  <button 
                                                    id="{{ $t.ID }}-deleteBtn" 
                                                    class="btn body-button" 
                                                    title="删除" 
                                                    onclick="deleteThing('{{ $t.ID }}')"
                                                  >
                                                    <i class="fa-solid fa-trash-can"></i>
                                                  </button>
                                                  <button 
                                                    id="{{ $t.ID }}-editBtn" 
                                                    class="btn body-button" 
                                                    title="修改" 
                                                    onclick="editThing('{{ $t.ID }}', '{{ $t.Name }}')"
                                                  >
                                                    <i class="fa-solid fa-pencil-alt"></i>
                                                  </button>
                                                {{ end }}
                                              </p>
                                            </div>
                                          </div>
                                        </div>
                                      {{ end }}
                                    </div>
                                    <!-- {{ template "tablefooter" . }} -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
              let currentDevices = {}, 
                  newDevices = {},
                  scanNewThingsList = [],
                  selectedNewThingNames = [];
              const deviceNetCfgModal = new bootstrap.Modal(document.getElementById("deviceNetCfgModal"));
              
              $(document).ready(function() {
                const url = window.location.href; // 获取当前页面的URL
                const address = new URL(url);
                const onlineStatusValue = (url.match(/onlineStatus=(\d+)/) || [])[1]; // 从URL获取onlineStatus的值
                
                getThingsList(onlineStatusValue);

                if (onlineStatusValue === '1') {
                  $('#btnAll').prop('checked', false);
                  $('#btnOnline').prop('checked', true);
                  $('#btnOffline').prop('checked', false);
                } else if (onlineStatusValue === '0') {
                  $('#btnAll').prop('checked', false);
                  $('#btnOnline').prop('checked', false);
                  $('#btnOffline').prop('checked', true);
                } else {
                  $('#btnAll').prop('checked', true);
                  $('#btnOnline').prop('checked', false);
                  $('#btnOffline').prop('checked', false);
                }

                $('input[name="btnOnlineStatus"]').change(function() {
                  let reqOnlineStatus = '2'; //all
                  if (this.id === 'btnOnline') {
                    reqOnlineStatus = '1'; //online
                  } else if (this.id === 'btnOffline') {
                    reqOnlineStatus = '0'; //offline
                  }
                  window.location.href = `/ui/things?limit=1000&onlineStatus=${reqOnlineStatus}`;
                });

                const intervalRefreshData = setInterval(refreshThingsData, 2000);

                //搜索添加设备确认添加按钮事件
                $('#scan-add-thing-button').on('click', addScanNewThings);

                //搜索添加设备-网络配置-手动、自动下拉选项
                $('#dhcp_enable-deviceNetCfg').change(function() {
                    const deviceName = $(this).data('device_name');
                    const deviceInfo = scanNewThingsList.find((item)=>item.device_name === deviceName); 
                    const dhcp_enable = $(this).val();
                    let ip = deviceInfo.netcfg.static_ip, 
                        gateway = deviceInfo.netcfg.static_gateway,
                        netmask = deviceInfo.netcfg.static_netmask, 
                        dns1 = deviceInfo.netcfg.static_dns1, 
                        dns2 = deviceInfo.netcfg.static_dns2,
                        readOnly = false;
                    if (dhcp_enable === "1") {
                      //自动
                      ip = deviceInfo.netcfg.dhcp_ip;
                      gateway = deviceInfo.netcfg.dhcp_gateway;
                      netmask = deviceInfo.netcfg.dhcp_netmask;
                      dns1 = deviceInfo.netcfg.dhcp_dns1;
                      dns2 = deviceInfo.netcfg.dhcp_dns2;
                      readOnly = true;

                      $('#ipError').empty();
                      $('#gatewayError').empty();
                      $('#netmaskError').empty();
                      $('#dns1Error').empty();
                      $('#dns2Error').empty();
                    }

                    $('#ip-deviceNetCfg').val(ip);
                    $('#gateway-deviceNetCfg').val(gateway);
                    $('#netmask-deviceNetCfg').val(netmask);
                    $('#dns1-deviceNetCfg').val(dns1);
                    $('#dns2-deviceNetCfg').val(dns2);

                    $('#ip-deviceNetCfg').prop('readOnly', readOnly);
                    $('#gateway-deviceNetCfg').prop('readOnly', readOnly);
                    $('#netmask-deviceNetCfg').prop('readOnly', readOnly);
                    $('#dns1-deviceNetCfg').prop('readOnly', readOnly);
                    $('#dns2-deviceNetCfg').prop('readOnly', readOnly);

                    scanNewThingsList = scanNewThingsList.map((item)=>{
                      if(item.device_name === deviceName) {
                        item.netcfg.dhcp_enable = dhcp_enable === "1";
                      }
                      return item;
                    });
                });

                //搜索添加设备-网络配置-手动-注册所有输入框的验证和保存逻辑
                validateAndSave('ip');
                validateAndSave('gateway');
                validateAndSave('netmask');
                validateAndSave('dns1');
                validateAndSave('dns2');

                //搜索添加设备-网络配置-确认按钮
                $('#deviceNetCfgModal-confirm-button').on('click', function() {
                  const deviceName = $(this).data('device_name');
                  const deviceInfo = scanNewThingsList.find(item => item.device_name === deviceName);
                  const dhcp_enable = deviceInfo.netcfg.dhcp_enable;
                  let canCloseModal = true;

                  function validateAndUpdateError(inputId, value) {
                    if (!IPV4REGX.test(value)) {
                      $(`#${inputId}Error`).html(IPERRORMSG);
                      canCloseModal = false;
                    } else {
                      $(`#${inputId}Error`).empty();
                    }
                  }

                  if (!dhcp_enable) {
                    validateAndUpdateError('ip', deviceInfo.netcfg.static_ip);
                    validateAndUpdateError('gateway', deviceInfo.netcfg.static_gateway);
                    validateAndUpdateError('netmask', deviceInfo.netcfg.static_netmask);
                    validateAndUpdateError('dns1', deviceInfo.netcfg.static_dns1);
                    validateAndUpdateError('dns2', deviceInfo.netcfg.static_dns2);
                  }

                  if (canCloseModal) {
                    deviceNetCfgModal.hide();
                  }
                });
              });
              
              function openModal(modal) {
                const thingModal = new bootstrap.Modal(document.getElementById("addThingModal"));
                const thingsModal = new bootstrap.Modal(document.getElementById("addThingsModal"));
                if (modal === "single") {
                  thingModal.show();
                } else if (modal === "bulk") {
                  thingsModal.show();
                } else if (modal === "scan") {
                  scanNewThings();
                }
              }

              //修改设备
              function editThing(id, name) {
                const editThingModal = new bootstrap.Modal(document.getElementById("editThingModal"));
                editThingModal.show();
                $("#editName").val(name);
                $("#editID").val(id);
              }

              //查看详情
              function viewThing(id) {
                window.location.href = '{{printf "%s/things/" pathPrefix}}' + id;
              }

              //删除
              function deleteThing(thingID) {
                // 显示确认对话框
                const userConfirmed = confirm("你确定要删除所选数据吗？");

                // 根据用户的选择执行不同的操作
                if (userConfirmed) {
                  fetch(`/ui/things/${thingID}/channelsInJSON?page=1&limit=1000`, {
                    method: "GET",
                  })
                    .then(response => {
                      if (!response.ok) {
                        throw new Error('Network response was not ok');
                      }
                      return response.json(); // 直接将流转换为JSON对象
                    })
                    .then(json => {
                      const data = json.data;
                      const channelsData = JSON.parse(data).channelsData;
                      const channels = channelsData.groups;
                      const fetchPromises = channels.map((channel) => disconnectThingsAndChannels(thingID, channel.id));
                      Promise.all(fetchPromises).then(responses => { })
                        .then(jsonData => { handleDelete(thingID) })
                        .catch(error => {
                          // 如果有任何错误发生，这里会捕获到
                          console.error('An error occurred:', error);
                        });
                    })
                } else {
                  console.log("用户点击了取消。");
                  // 执行取消后的操作
                }
              }

              function handleDelete(thingID) {
                fetch(`/ui/things/${thingID}`, {
                  method: "DELETE",
                })
                  .then(function (response) {
                    if (!response.ok) {
                      const errorMessage = response.headers.get("X-Error-Message");
                      if (errorMessage) {
                        console.log(errorMessage);
                      } else {
                        console.log(`Error: ${response.status}`);
                      }
                    } else {
                      window.location.reload();
                    }
                  })
                  .catch((error) => {
                    window.location.reload();
                    console.error("error submitting form: ", error);
                  });
              }

              //控制设备
              function conntrolThing(thingID, thingIdentity, controlType) {
                 //获取当前domain的ID号
                 const domainID = sessionStorage.getItem("domainID");

                fetch(`/ui/domains/${domainID}/domainInJSON`, {
                  method: "GET",
                })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok');
                    }
                    return response.json(); // 直接将流转换为JSON对象
                  })
                  .then(json => {
                    const data = json.data;
                    const domainData = JSON.parse(data).domainData;
                    const defaultChannelId = domainData.metadata["comID"];
                    const message = `${controlType} ${thingIdentity}`;
                    if (domainID && defaultChannelId) {
                      const message = `${controlType} ${thingIdentity}`;
                      postMessage(defaultChannelId, message)
                    }
                  })
              }

              //更改设备在线状态
              function changeOnlineStatus(thing){
                const onlineStatus = thing.metadata && thing.metadata.isOnline === "1";
                $(`#${thing.id}-onlineStatusTD`).empty();
                if (onlineStatus) {
                  $('<span class="badge rounded-pill enabled-pill">在线</span>').appendTo(`#${thing.id}-onlineStatusTD`);
                  $(`#${thing.id}-rebootBtn`).prop('disabled', false);
                  $(`#${thing.id}-deleteBtn`).prop('disabled', true);
                  $(`#${thing.id}-editBtn`).prop('disabled', true);
                } else {
                  $('<span class="badge rounded-pill disabled-pill">离线</span>').appendTo(`#${thing.id}-onlineStatusTD`);
                  $(`#${thing.id}-rebootBtn`).prop('disabled', true);
                  $(`#${thing.id}-deleteBtn`).prop('disabled', false);
                  $(`#${thing.id}-editBtn`).prop('disabled', false);
                }
              }

              //轮询刷新thingslist，以实现监听things在线状态的
              function refreshThingsData() {
                // 获取当前页面的完整URL
                const currentUrl = window.location.href;
                // 创建URL对象
                const urlObj = new URL(currentUrl);
                // 使用URL对象的searchParams属性获取URLSearchParams对象
                const searchParams = urlObj.searchParams;
                // 使用get方法从URLSearchParams对象中获取page和limit的值
                const page = searchParams.get('page') || 1;
                const limit = searchParams.get('limit') || 1000;
                const reqOnlineStatus = searchParams.get('onlineStatus') || 2;
                fetch(`/ui/things/thingsInJSON?page=${page}&limit=${limit}&onlineStatus=${reqOnlineStatus}`, {
                  method: "GET",
                })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok');
                    }
                    return response.json(); // 直接将流转换为JSON对象
                  })
                  .then(json => {
                    const data = json.data;
                    const thingsData = JSON.parse(data).thingsData;
                    const things = thingsData.things || [];
                    if (Number(reqOnlineStatus) === 2) {
                      // 所有设备
                      things.forEach((thing) => {
                        changeOnlineStatus(thing);
                      });
                    } else {
                      newDevices = {};
                       // 所有在线\离线
                      if (things.length) {
                        things.forEach(device => {
                          newDevices[device.id] = {
                            id: device.id,
                            name: device.name,
                            credentials: device.credentials,
                            metadata: device.metadata,
                            status: device.status,
                            created_at: device.created_at,
                            updated_at: device.updated_at,
                          };
                        });
                        updateThingsGrid(things);
                      } else {
                        currentDevices = {};
                        $(`#thingsGrid`).empty();
                      };
                    }
                  })
                  .catch(error => {
                    // console.error('处理fetch或JSON时出错:', error);
                  });
              }
              
              //更新设备显示表格
              function updateThingsGrid(devices) {
                const $thingsGrid = $('#thingsGrid');
                const currentDevicesLength = Object.keys(currentDevices).length;
                const newDevicesLength = Object.keys(newDevices).length;

                if (currentDevicesLength > newDevicesLength) {
                  // 移除不在(查询在线时刚离线的，查询离线时刚上线的)的设备\
                  Object.keys(currentDevices).forEach((curId)=>{
                    if (
                      (typeof newDevices === 'object' && Object.entries(newDevices).length === 0) || 
                      (newDevices[curId] === null || newDevices[curId] === undefined) ||
                      (typeof newDevices[curId] === 'object' && Object.entries(newDevices[curId]).length === 0)
                    ) {
                      // 移除不在(查询在线时离线的，查询离线时上线的)的设备
                      $(`#${curId}-thingCard`).remove();
                    }
                  })
                } else if (currentDevicesLength < newDevicesLength) {
                  // 新增(查询在线时刚上线的，查询离线时刚离线的)的设备]
                  Object.keys(newDevices).forEach((newId)=>{
                    if (
                      (typeof currentDevices === 'object' && Object.entries(currentDevices).length === 0) || 
                      (currentDevices[newId] === null || currentDevices[newId] === undefined) ||
                      (typeof currentDevices[newId] === 'object' && Object.entries(currentDevices[newId]).length === 0)
                    ) {
                      const device = newDevices[newId];
                      const onlineSpan = device.metadata && Number(device.metadata.isOnline) === 1 ? 
                        $(`<span class="badge rounded-pill enabled-pill">在线</span>`) : 
                        $(`<span class="badge rounded-pill disabled-pill">离线</span>`);
                      const btnSpan = device.metadata && Number(device.metadata.isOnline) === 1 ? 
                        $(`
                          <p>
                            <button class="btn body-button" onclick="viewThing(${device.id})" title="查看">
                              <i class="fa-solid fa-info"></i>
                            </button>
                            <button
                              id="${device.id}-rebootBtn"
                              class="btn body-button"
                              onclick="conntrolThing(${device.id}, ${device.credentials.identity}, 'reboot')"
                              title="重启"
                            >
                              <i class="fa-solid fa-arrows-rotate"></i>
                            </button>
                            <button 
                              id="${device.id}-deleteBtn" 
                              class="btn body-button" 
                              onclick="deleteThing(${device.id})" 
                              title="删除"
                              disabled
                            >
                              <i class="fa-solid fa-trash-can"></i>
                            </button>
                            <button 
                              id="${device.id}-editBtn" 
                              title="修改" 
                              class="btn body-button" 
                              onclick="editThing(${device.id}, ${device.name})"
                              disabled
                            >
                              <i class="fa-solid fa-pencil-alt"></i>
                            </button>
                          </p>
                        `) : 
                        $(`
                          <p>
                            <button class="btn body-button" onclick="viewThing(${device.id})" title="查看">
                              <i class="fa-solid fa-info"></i>
                            </button>
                            <button
                              id="${device.id}-rebootBtn"
                              class="btn body-button"
                              onclick="conntrolThing(${device.id}, ${device.credentials.identity}, 'reboot')"
                              title="重启"
                              disabled
                            >
                              <i class="fa-solid fa-arrows-rotate"></i>
                            </button>
                            <button 
                              id="${device.id}-deleteBtn" 
                              class="btn body-button" 
                              onclick="deleteThing(${device.id})" 
                              title="删除"
                            >
                              <i class="fa-solid fa-trash-can"></i>
                            </button>
                            <button 
                              id="${device.id}-editBtn" 
                              title="修改" 
                              class="btn body-button" 
                              onclick="editThing(${device.id}, ${device.name})"
                            >
                              <i class="fa-solid fa-pencil-alt"></i>
                            </button>
                          </p>
                        `);
                      const $thingCard = $(`
                        <div class="col-sm-3 mb-3 mb-sm-0" id="${device.id}-thingCard">
                          <div class="channel-thing-card card">
                            <div class="card-body">
                              <h5 class="card-title">${device.name}</h5>
                              <p>${device.credentials.identity}</p>
                              <p id="${device.id}-onlineStatusTD" class="card-text">
                                ${onlineSpan}
                              </p>
                              ${btnSpan}
                            </div>
                          </div>
                        </div>
                      `);
                      $(`#thingsGrid`).append($thingCard);
                    }
                  })
                }

                currentDevices = {};
                currentDevices = newDevices;
              }

              //根据在线类型获取设备列表
              function getThingsList(onlineStatus) {
                currentDevices = {};
                fetch(`/ui/things/thingsInJSON?limit=1000&onlineStatus=${onlineStatus}`, {
                  method: "GET",
                })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok');
                    }
                    return response.json(); // 直接将流转换为JSON对象
                  })
                  .then(json => {
                    const data = json.data;
                    const thingsData = JSON.parse(data).thingsData;
                    const things = thingsData.things || [];
                    currentDevices = {};
                    if (things.length) {
                      things.forEach(device => {
                        currentDevices[device.id] = {
                          id: device.id,
                          name: device.name,
                          credentials: device.credentials,
                          metadata: device.metadata,
                          status: device.status,
                          created_at: device.created_at,
                          updated_at: device.updated_at,
                        };
                      });
                    }
                  })
                  .catch(error => {
                    //
                  });
              }

              //给设备发信息
              function postMessage(channelID, message) {
                let formData = new FormData();
                formData.append("channelID", channelID);
                formData.append("message", message);
                formData.append("thingSecret", "platform");
                fetch(`/ui/channels/messages`, {
                  method: "POST",
                  body: formData,
                })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok');
                    }
                    return response.json(); // 直接将流转换为JSON对象
                  })
                  .then(json => {
                    //
                  })
                  .catch(error => {
                    console.error('处理fetch或JSON时出错:', error);
                  });
              }
              
              //扫描添加设备弹框中手动设置网络信息验证
              function validateAndSave(property) {
                const $inputElement = $(`#${property}-deviceNetCfg`);
                $inputElement.on('change blur keyup', function(event) {
                  const deviceName = $(this).data('device_name');
                  const deviceInfo = scanNewThingsList.find(item => item.device_name === deviceName);
                  const dhcp_enable = deviceInfo.netcfg.dhcp_enable;
                  const value = $(this).val();
                  
                  if (!dhcp_enable) {
                    if (IPV4REGX.test(value)) {
                      $(`#${property}Error`).empty();
                      if (event.type === 'blur') {
                        scanNewThingsList = scanNewThingsList.map(item => {
                          if (item.device_name === deviceName) {
                            item.netcfg[`static_${property}`] = value;
                          }
                          return item;
                        });
                      }
                    } else {
                      $(`#${property}Error`).html(IPERRORMSG);
                    }
                  }
                });
              }

              //扫描设备添加弹框设备列表-配置网络
              function deviceNetCfg(e) {
                e.stopPropagation();
                deviceNetCfgModal.show();

                const deviceName = e.target.dataset.device_name;
                const deviceInfo = scanNewThingsList.find((item)=>item.device_name === deviceName); 
                let ip = deviceInfo.netcfg.static_ip, 
                    gateway = deviceInfo.netcfg.static_gateway,
                    netmask = deviceInfo.netcfg.static_netmask, 
                    dns1 = deviceInfo.netcfg.static_dns1, 
                    dns2 = deviceInfo.netcfg.static_dns2;
                    dhcp_enable = "0",
                    readOnly = false;
                if (deviceInfo.netcfg.dhcp_enable) {
                  ip = deviceInfo.netcfg.dhcp_ip;
                  gateway = deviceInfo.netcfg.dhcp_gateway;
                  netmask = deviceInfo.netcfg.dhcp_netmask;
                  dns1 = deviceInfo.netcfg.dhcp_dns1;
                  dns2 = deviceInfo.netcfg.dhcp_dns2;
                  dhcp_enable = "1";
                  readOnly = true;
                }

                $('#dhcp_enable-deviceNetCfg').val(dhcp_enable);
                $('#ip-deviceNetCfg').attr('data-device_name', deviceName);
                $('#gateway-deviceNetCfg').attr('data-device_name', deviceName);
                $('#netmask-deviceNetCfg').attr('data-device_name', deviceName);
                $('#dns1-deviceNetCfg').attr('data-device_name', deviceName);
                $('#dns2-deviceNetCfg').attr('data-device_name', deviceName);
                $('#dhcp_enable-deviceNetCfg').attr('data-device_name', deviceName);
                $('#deviceNetCfgModal-confirm-button').attr('data-device_name', deviceName);

                $('#ip-deviceNetCfg').val(ip);
                $('#gateway-deviceNetCfg').val(gateway);
                $('#netmask-deviceNetCfg').val(netmask);
                $('#dns1-deviceNetCfg').val(dns1);
                $('#dns2-deviceNetCfg').val(dns2);

                $('#ip-deviceNetCfg').prop('readOnly', readOnly);
                $('#gateway-deviceNetCfg').prop('readOnly', readOnly);
                $('#netmask-deviceNetCfg').prop('readOnly', readOnly);
                $('#dns1-deviceNetCfg').prop('readOnly', readOnly);
                $('#dns2-deviceNetCfg').prop('readOnly', readOnly);
              }

              //扫描添加设备弹框设备列表-勾选设备
              function onSelectNewThing(e) {
                e.stopPropagation();
                const checkbox = e.target;
                const isChecked = checkbox.checked;
                const value = e.target.value;
                //判断是否全选，全反选
                if (value === 'selectAll') {
                  if (isChecked) {
                    selectedNewThingNames = scanNewThingsList.map((item)=>{
                      return item.device_name;
                    });
                    scanNewThingsList.forEach((item)=>{
                      $(`#checkbox_${item.device_name}`).prop("checked", true);
                    });
                  } else {
                    selectedNewThingNames = [];
                    scanNewThingsList.forEach((item)=>{
                      $(`#checkbox_${item.device_name}`).prop("checked", false);
                    });
                  }
                } else {
                  if (isChecked) {
                    if (!selectedNewThingNames.includes(value)) {
                      selectedNewThingNames.push(value);
                    }
                  } else {
                    selectedNewThingNames = selectedNewThingNames.filter((name)=> name !== value)
                  }
                }
                
                if (selectedNewThingNames.length) {
                  $("#scan-add-thing-button").removeAttr("disabled");
                  //判断全选框是否半勾选
                  if (selectedNewThingNames.length === scanNewThingsList.length) {
                    $(`#checkbox_selectAll`).prop("checked", true);
                    $(`#checkbox_selectAll`).prop("indeterminate", false);
                  } else {
                    $(`#checkbox_selectAll`).prop("indeterminate", true);
                    $(`#checkbox_selectAll`).prop("checked", false);
                  }
                } else {
                  $("#scan-add-thing-button").attr("disabled", true);
                  $(`#checkbox_selectAll`).prop("indeterminate", false);
                  $(`#checkbox_selectAll`).prop("checked", false);
                }
                console.log("selectedNewThingNames: ", selectedNewThingNames);
              }

              //显示扫描添加设备弹框设备列表
              function showNewThingsGrid (thingsList) {
                const scanThingsModal = new bootstrap.Modal(document.getElementById("scanThingsModal"));
                scanThingsModal.show();
                $(`#scanThingsGrid`).empty();

                //全选按钮
                const $selectAll = $(`
                    <li class="list-group-item newThingItemList">
                      <input 
                        class="form-check-input" 
                        type="checkbox" 
                        value="selectAll" 
                        id="checkbox_selectAll"
                        onchange="onSelectNewThing(event)"
                      />
                      <label class="form-check-label" for="checkbox_selectAll">
                        全选
                      </label>
                    </li>
                  `);
                $(`#scanThingsGrid`).append($selectAll);

                //设备列表
                thingsList.forEach((thing, index)=>{
                  const $thingList = $(`
                    <li class="list-group-item newThingItemList">
                      <input 
                        class="form-check-input" 
                        type="checkbox" 
                        value="${thing.device_name}" 
                        id="checkbox_${thing.device_name}"
                        onchange="onSelectNewThing(event)"
                      />
                      <label class="form-check-label" for="checkbox_${thing.device_name}">
                        ${thing.device_aliase}
                      </label>
                      <span 
                        style="float:right; cursor:pointer; color:#20afbf;" 
                        data-device_name="${thing.device_name}" 
                        onclick="deviceNetCfg(event)"
                      >
                        配置网络
                      </span>
                    </li>
                  `);
                  $(`#scanThingsGrid`).append($thingList);
                })
              }

              //获取udp组播扫描到的新设备
              function scanNewThings(){
                const url = window.location.href; // 获取当前页面的URL
                const address = new URL(url);
                const port =  sessionStorage.getItem("socketBridgePort") || "63001";
                fetch(`http://${address.hostname}:${port}/devices`, {
                    method: "GET",
                  })
                    .then(response => {
                      // 检查响应的内容类型是否为JSON
                      if (
                        response.headers.get('Content-Type') && 
                        response.headers.get('Content-Type').includes('application/json')
                      ) {
                        // 检查响应的内容长度
                        if (response.headers.get('Content-Length') === '0') {
                          // 如果内容长度为0，返回一个空对象或执行其他逻辑
                          return {};
                        }

                        // 返回响应的JSON解析结果
                        return response.json();
                      } else {
                        // 如果内容类型不是JSON，抛出错误或执行其他逻辑
                        throw new Error('Response content type is not JSON');
                      }
                    })
                    .then(json => {
                      if (json && JSON.stringify(json) !== '{}' && json.length) {
                        scanNewThingsList = json.map((item)=>{
                          return JSON.parse(item.message)
                        })
                        showNewThingsGrid(scanNewThingsList)
                      } else {
                        alert("没有扫描到设备")
                      }
                    })
              }

              //添加扫描设备
              function addScanNewThings() {
                // 显示确认对话框
                const userConfirmed = confirm("你确定要添加所选设备吗？");

                console.log("userConfirmed: ", userConfirmed);
                // 根据用户的选择执行不同的操作
                if (userConfirmed) {
                  console.log("selectedNewThingNames: ", selectedNewThingNames);
                  console.log("scanNewThingsList: ", scanNewThingsList);

                  const selectedNewThings = scanNewThingsList.filter(item => selectedNewThingNames.includes(item.device_name));
                  const query = selectedNewThings.map((thing)=>{
                    return {
                      name: thing.device_aliase,
                      credentials: {
                        identity: thing.device_name,
                        secret: thing.device_name,
                      },
                      tags: [],
                      metadata: {
                        netcfg: thing.netcfg,
                        productName: thing.product_name,
                        isOnline: "0",
                      }
                    }
                  })
                  console.log("query: ", query);
                  fetch(`/ui/things/batch`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify(query),
                  })
                    .then(response => {
                      // 获取当前 URL
                      const currentUrl = new URL(window.location.href);
                      // 修改查询参数
                      currentUrl.searchParams.set('onlineStatus', '2');
                      // 跳转到新的 URL
                      window.location.href = currentUrl.toString();
                    })
                } else {
                  console.log("用户点击了取消。");
                }
              }
            </script> 
            <script type="module">
              import {
                attachValidationListener,
                validateName,
                validateJSON,
                validateStringArray,
              } from "/js/validation.js";
              import { submitCreateForm } from "/js/forms.js";

              const thingModal = new bootstrap.Modal(document.getElementById("addThingModal"));
              const thingsModal = new bootstrap.Modal(document.getElementById("addThingsModal"));
              const editThingModal = new bootstrap.Modal(document.getElementById("editThingModal"));

              attachValidationListener({
                buttonId: "create-thing-button",
                errorDivs: {
                  name: "nameError",
                  // metadata: "metadataError",
                  thingsTags: "tagsError",
                },
                validations: {
                  name: validateName,
                  // metadata: validateJSON,
                  thingsTags: validateStringArray,
                },
                fields: {
                  name: "name-field",
                  // metadata: "metadata-field",
                  thingsTags: "tags-field",
                },
              });

              submitCreateForm({
                url: '{{printf "%s/things" pathPrefix}}',
                formId: "thingform",
                alertDiv: "alertMessage",
                modal: thingModal,
                type:"addThing"
              });

              submitCreateForm({
                url: '{{printf "%s/things/bulk" pathPrefix}}',
                formId: "bulkThingsForm",
                alertDiv: "alertBulkMessage",
                modal: thingsModal,
              });

              attachValidationListener({
                buttonId: "edit-thing-button",
                errorDivs: {
                  name: "editNameError",
                },
                validations: {
                  editName: validateName,
                },
                fields: {
                  editName: "name-field",
                },
              });

              submitCreateForm({
                url: '{{ printf "%s/things" pathPrefix }}',
                formId: "editThingform",
                alertDiv: "editAlertMessage",
                modal: editThingModal,
                type: "edit"
              });
            </script>
        </body>
    </html>
{{ end }}
