<!-- Copyright (c) Abstract Machines
SPDX-License-Identifier: Apache-2.0 -->

{{ define "task" }}
  <!doctype html>
  <html lang="en">
    <head>
      <title>日程</title>
      {{ template "header" }}
      <style>
        
      </style>
    </head>
    <body>
      {{ template "navbar" . }}
      <div class="main-content pt-3">
        <div class="container-fluid">
          <div class="row-mb-3 p-3">
            <div class="col-lg-12 mx-auto">
              <!-- 新增、修改任务弹框 -->
              <div 
                class="modal fade" 
                id="taskModal" 
                tabindex="-1" 
                role="dialog" 
                aria-labelledby="taskModalLabel" 
                aria-hidden="true"
                data-bs-backdrop="static" 
                data-bs-keyboard="false"  
              >
                <div class="modal-dialog" role="document">
                  <div class="modal-content" style="width: 570px;">
                    <div class="modal-header">
                      <h1 class="modal-title" id="taskModalLabel">
                        <i class="fa-solid fa-plus"></i> 新建日程
                      </h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" id="addTaskForm">
                      <div class="modal-body">
                          <div class="form-group mb-3" style="padding: 0px 16px;">
                            <div class="mb-3 row">
                              <label for="taskName" class="col-sm-2 col-form-label">日程名称</label>
                              <div class="col-sm-10">
                                <input type="text" class="form-control name-field" name="taskName" id="taskName" placeholder="请输入日程名称" required />
                                <div id="taskNameError" class="text-danger" style="margin-top: 10px;"></div>
                              </div>
                            </div>
                            <div class="mb-3 row">
                              <label for="startTime" class="col-sm-2 col-form-label">开始时间</label>
                              <div class="col-sm-10">
                                <input 
                                  type="text" 
                                  class="form-control dateinput dateicon moredate" 
                                  name="startTime" 
                                  placeholder="请选择开始时间" 
                                  data-formater="YYYY-MM-DD hh:mm:ss" 
                                  id="startTime" 
                                  required 
                                  readonly
                                />
                                <div id="startTimeError" class="text-danger" style="margin-top: 10px;"></div>
                              </div>
                            </div>
                            <div class="mb-3 row">
                              <label for="sourceName" class="col-sm-2 col-form-label">选择音源</label>
                              <div class="col-sm-10" style="display: flex;">
                                <input type="text" class="form-control name-field" name="sourceName" id="sourceName" placeholder="请选择音源" required readonly />
                                <div style="width: 110px; text-align: right;">
                                  <button type="button" class="btn body-button" id="selectSourceBtn">
                                    <i class="fa-solid fa-plus"></i> 选择
                                  </button>
                                </div>
                              </div>
                              <div class="col-sm-10 offset-sm-2 text-danger"  id="sourceNameError" style="margin-top: 10px;"></div>
                            </div>
                            <div class="mb-3 row">
                              <label for="playbackCycle" class="col-sm-2 col-form-label">播放周期</label>
                              <div class="col-sm-10">
                                <select class="form-control form-select" placeholder="请选择播放周期" name="playbackCycle" id="playbackCycle" required>
                                  <option value="0" selected>请选择播放周期</option>
                                  <option value="once">单次</option>
                                  <option value="day">每天</option>
                                  <option value="week">每周</option>
                                  <option value="month">每月</option>
                                  <option value="year">每年</option>
                                </select>
                                <div 
                                  class="form-conrtol" 
                                  id="weekCheckboxGroup" 
                                  style="
                                    border: none; 
                                    padding-left: 0; 
                                    padding-top: 10px; 
                                    display: none;
                                  "
                                >
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input taskWeekCheckbox" type="checkbox" name="weeks[]" id="weekCheckbox1" value="mon">
                                    <label class="form-check-label" for="weekCheckbox1">一</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input taskWeekCheckbox" type="checkbox" name="weeks[]" id="weekCheckbox2" value="tue">
                                    <label class="form-check-label" for="weekCheckbox2">二</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input taskWeekCheckbox" type="checkbox" name="weeks[]" id="weekCheckbox3" value="wed">
                                    <label class="form-check-label" for="weekCheckbox3">三</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input taskWeekCheckbox" type="checkbox" name="weeks[]" id="weekCheckbox4" value="thu">
                                    <label class="form-check-label" for="weekCheckbox4">四</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input taskWeekCheckbox" type="checkbox" name="weeks[]" id="weekCheckbox5" value="fri">
                                    <label class="form-check-label" for="weekCheckbox5">五</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input taskWeekCheckbox" type="checkbox" name="weeks[]" id="weekCheckbox6" value="sat">
                                    <label class="form-check-label" for="weekCheckbox6">六</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input taskWeekCheckbox" type="checkbox" name="weeks[]" id="weekCheckbox7" value="sun">
                                    <label class="form-check-label" for="weekCheckbox7">七</label>
                                  </div>
                                </div>
                                <div id="playbackCycleError" class="text-danger" style="margin-top: 10px;"></div>
                              </div>
                            </div>
                            <div class="mb-3 row">
                              <label for="playArea" class="col-sm-2 col-form-label">播放区域</label>
                              <div class="col-sm-10">
                                <div class="playAreaBox">
                                  <div class="row g-1" style="margin-bottom: 5px;">
                                    <div class="d-grid col-sm-6">
                                      <button type="button" class="btn btn-light" style="color: dodgerblue;" id="playAreasAddBtn">
                                        <i class="fa-solid fa-plus"></i> 添加
                                      </button>
                                    </div>
                                    <div class="d-grid col-sm-6">
                                      <button type="button" class="btn btn-light" style="color: dimgray;" id="playAreasDetailBtn">
                                        <i class="fa-solid fa-ellipsis"></i> 详情
                                      </button>
                                    </div>
                                  </div>
                                  <div class="row row-cols-6 g-1" id="playAreaListsContainer"></div>
                                </div>
                                <div id="playAreaError" class="text-danger" style="margin-top: 10px;"></div>
                              </div>
                            </div>
                            <div class="mb-3 row">
                              <div class="col-sm-12" style="text-align: center;">
                                <div id="moreSettingBtnTaskModal" class="moreSettingBtn">
                                  <i class="fa-solid fa-chevron-down"></i>
                                </div>
                              </div>
                            </div>
                            <div class="mb-3" id="moreSettingContainerTaskModal" style="display: none;">
                              <div class="mb-3 row">
                                <label for="endTime" class="col-sm-2 col-form-label">结束时间</label>
                                <div class="col-sm-10">
                                  <input 
                                    type="text" 
                                    class="form-control dateinput dateicon moredate" 
                                    name="endTime" 
                                    placeholder="请选择结束时间" 
                                    data-formatter="YYYY-MM-DD hh:mm:ss" 
                                    id="endTime" 
                                    required 
                                    readonly
                                  />
                                  <div id="endTimeError" class="text-danger" style="margin-top: 10px;"></div>
                                </div>
                              </div>
                              <div class="mb-3 row" id="repeatNumContainer">
                                <label for="repeatNum" class="col-sm-2 col-form-label" style="line-height: 35px;">重复次数</label>
                                <div class="col-sm-10" style="display: flex; margin-top: 7px;">
                                  <select class="form-control form-select" placeholder="请选择重复次数" name="repeatNum" id="repeatNum">
                                  </select>
                                  <div style="margin-left: 10px; width: 32px;">
                                    <div class="form-control form-check form-switch" style="border: none;">
                                      <input class="form-check-input" type="checkbox" role="switch" name="repeatNumSwitch" id="repeatNumSwitch" />
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="mb-3 row">
                                <label for="randomPlay" class="col-sm-2 col-form-label">随机播放</label>
                                <div class="col-sm-10">
                                  <div class="form-control form-check form-switch" style="border: none;">
                                    <input class="form-check-input" type="checkbox" role="switch" name="randomPlay" id="randomPlay" />
                                  </div>
                                </div>
                              </div>
                              <div class="mb-3 row">
                                <label for="volumeControl" class="col-sm-2 col-form-label">音量微调</label>
                                <div class="col-sm-10" style="display: flex; margin-top: 7px;">
                                  <input 
                                    type="range" 
                                    class="form-conrtol form-range" 
                                    min="-7" 
                                    max="7" 
                                    step="1" 
                                    id="volumeControl"
                                    name="volumeControl"
                                  />
                                  <div id="volumeLabel" style="text-align: right; width: 30px; line-height: 25px;">0</div>
                                </div>
                              </div>
                              <div class="mb-3 row">
                                <label for="level" class="col-sm-2 col-form-label">优先级</label>
                                <div class="col-sm-10">
                                  <div class="btn-group form-conrtol" role="group">
                                    <input type="radio" class="btn-check" name="level" id="level1" autocomplete="off" value="1" />
                                    <label class="btn btn-outline-primary" for="level1">!</label>
                                    <input type="radio" class="btn-check" name="level" id="level2" autocomplete="off" value="2" />
                                    <label class="btn btn-outline-primary" for="level2">!!</label>
                                    <input type="radio" class="btn-check" name="level" id="level3" autocomplete="off" value="3" />
                                    <label class="btn btn-outline-primary" for="level3">!!!</label>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                              <button type="submit" class="btn body-button" id="taskModalConfirmBtn">确定</button>
                          </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- 播放区域详情弹框 -->
              <div 
                class="modal fade" 
                id="playAreasAddModal" 
                tabindex="-1" 
                role="dialog" 
                aria-labelledby="playAreasAddModalLabel" 
                aria-hidden="true"
                data-bs-backdrop="static" 
                data-bs-keyboard="false"  
              >
                <div class="modal-dialog" role="document">
                  <div class="modal-content" style="width: 570px;">
                    <div class="modal-header">
                      <h1 class="modal-title" id="playAreasAddModal">播放区域</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closePlayAreasAddModal();"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3" style="max-height: 400px; overflow-y: auto;">
                        <div id="playAreaTree"></div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closePlayAreasAddModal();">取消</button>
                        <button type="button" class="btn body-button" id="confirmPlayAreasAddModalBtn">确定</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 播放区域详情弹框 -->
              <div 
                class="modal fade" 
                id="playAreasDetailModal" 
                tabindex="-1" 
                role="dialog" 
                aria-labelledby="playAreasDetailModalLabel" 
                aria-hidden="true"
                data-bs-backdrop="static" 
                data-bs-keyboard="false"  
              >
                <div class="modal-dialog" role="document">
                  <div class="modal-content" style="width: 570px;">
                    <div class="modal-header">
                      <h1 class="modal-title" id="playAreasDetailModal">播放区域</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="taskModal.show();"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3" style="max-height: 400px; overflow-y: auto;">
                        <div class="row row-cols-4 g-3" id="playAreasDetailListContainer"></div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="taskModal.show();">取消</button>
                        <button type="button" class="btn body-button" id="confirmPlayAreasDetailModalBtn">确定</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 选择音源弹框 -->
              <div 
                class="modal fade" 
                id="sourceModal" 
                tabindex="-1" 
                role="dialog" 
                aria-labelledby="sourceModalLabel" 
                aria-hidden="true"
                data-bs-backdrop="static" 
                data-bs-keyboard="false"  
              >
                <div class="modal-dialog" role="document">
                  <div class="modal-content" style="width: 570px;">
                    <div class="modal-header">
                      <h1 class="modal-title" id="sourceModalLabel">音源列表</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="taskModal.show();"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3" style="padding: 0px 16px;">
                        <div class="mb-3">
                          <div 
                            style="
                              border-radius: 5px;
                              display: flex; 
                              justify-content: space-between; 
                              background: whitesmoke;
                            "
                          >
                            <div style="line-height: 38px; margin-left: 10px;">文件列表</div>
                            <div>
                              <button 
                                type="button" 
                                class="btn btn-link" 
                                style="text-decoration: none; color: #20afbf;"
                                id="addSourceModalFileBtn"
                              >
                                <i class="fa-solid fa-plus"></i> 添加
                              </button>
                            </div>
                          </div>
                          <ul class="list-group list-group-flush sourceModalList" id="sourceModalFileListContainer">
                          </ul>
                        </div>
                        <div class="mb-3 row">
                          <div class="col-sm-12" style="text-align: center;">
                            <div id="moreSettingBtnSourceModal" class="moreSettingBtn">
                              <i class="fa-solid fa-chevron-down"></i>
                            </div>
                          </div>
                        </div>
                        <div class="mb-3" id="moreSettingContainerSourceModal" style="display: none;">
                          <div class="mb-3">
                            <div 
                              style="
                                border-radius: 5px;
                                display: flex; 
                                justify-content: space-between; 
                                background: whitesmoke;
                              "
                            >
                              <div style="line-height: 38px; margin-left: 10px;">采播通道列表</div>
                              <div>
                                <button 
                                  type="button" 
                                  class="btn btn-link" 
                                  style="text-decoration: none; color: #20afbf;"
                                  id="addSourceModalDeviceBtn"
                                >
                                  <i class="fa-solid fa-plus"></i> 添加
                                </button>
                              </div>
                            </div>
                            <ul class="list-group list-group-flush sourceModalList" id="sourceModalDeviceListContainer">
                            </ul>
                          </div>
                          <div class="mb-3 row">
                            <label for="backgroundSource" class="col-sm-2 col-form-label">背景音</label>
                            <div class="col-sm-10">
                              <select class="form-control form-select" placeholder="请选择背景音" name="backgroundSource" id="backgroundSource">
                                <option value="0" selected>无</option>
                              </select>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="taskModal.show();">取消</button>
                        <button type="button" class="btn body-button" id="sourceModalConfirmBtn">确定</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 选择文件弹框 -->
              <div 
                class="modal fade" 
                id="filesModal" 
                tabindex="-1" 
                role="dialog" 
                aria-labelledby="filesModalLabel" 
                aria-hidden="true"
                data-bs-backdrop="static" 
                data-bs-keyboard="false"  
              >
                <div class="modal-dialog" role="document">
                  <div class="modal-content" style="width: 570px;">
                    <div class="modal-header">
                      <h1 class="modal-title" id="filesModal">音频文件</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="sourceModal.show();"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3">
                        <nav>
                          <ol class="breadcrumb" id="breadcrumbNavigator" style="margin-left: 5px; margin-bottom: 5px;"></ol>
                        </nav>
                      </div>
                      <div class="mb-3 row modalTableContainer">
                        <table 
                          id="filesModalTable"
                          class="table table-hover"
                          data-checkbox-header="true"
                          data-click-to-select="true"
                        >
                          <thead>
                            <tr>
                              <th data-field="state" data-checkbox="true" data-formatter="fileNameTableStateFormatter"></th>
                              <th data-field="fileName" data-formatter="fileNameTableFormatter">文件名</th>
                            </tr>
                          </thead>
                        </table>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="sourceModal.show();">取消</button>
                        <button type="button" class="btn body-button" id="confirmFileBtn">确定</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 输入通道弹框 -->
              <div 
                class="modal fade" 
                id="inputChannelsModal" 
                tabindex="-1" 
                role="dialog" 
                aria-labelledby="inputChannelsModalLabel" 
                aria-hidden="true"
                data-bs-backdrop="static" 
                data-bs-keyboard="false"  
              >
                <div class="modal-dialog" role="document">
                  <div class="modal-content" style="width: 570px;">
                    <div class="modal-header">
                      <h1 class="modal-title" id="inputChannelsModal">输入通道</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="sourceModal.show();"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3 row modalTableContainer">
                        <table 
                          id="inputChannelsModalTable"
                          class="table table-hover"
                          data-checkbox-header="true"
                          data-click-to-select="true"
                        >
                          <thead>
                            <tr>
                              <th data-field="state" data-checkbox="true"></th>
                              <th data-field="deviceName" data-formatter="inputChannelNameTableFormatter">设备</th>
                            </tr>
                          </thead>
                        </table>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="sourceModal.show();">取消</button>
                        <button type="button" class="btn body-button" id="confirmInputChannelsBtn">确定</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 同步任务弹框 -->
              <div 
                class="modal fade" 
                id="syncTaskModal" 
                tabindex="-1" 
                role="dialog" 
                aria-labelledby="syncTaskModalLabel" 
                aria-hidden="true"
                data-bs-backdrop="static" 
                data-bs-keyboard="false"  
              >
                <div class="modal-dialog" role="document">
                  <div class="modal-content" style="width: 500px;">
                    <div class="modal-header">
                      <h1 class="modal-title" id="syncTaskModalLabel">设备任务同步</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3 row modalTableContainer">
                        <table 
                          id="syncTaskTable"
                          class="table table-hover"
                          data-checkbox-header="false"
                          data-click-to-select="false"
                        >
                          <thead>
                            <tr>
                              <th data-field="deviceName" data-formatter="deviceNameTableFormatter">设备</th>
                              <th data-field="syncStatus" data-formatter="syncStatusTableFormatter">同步状态</th>
                            </tr>
                          </thead>
                        </table>
                      </div>
                      <div class="modal-footer" style="display: block; text-align: center;">
                        <button type="button" class="btn body-button" id="oneClickSyncTaskBtn">一键同步</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 任务主页面 -->
              <div class="table-responsive table-container" id="taskPageContainer">
                <!-- 任务列表 -->
                <div class="taskContent">
                  <div class="taskContentHeaderBar">
                    <div>
                      <h5 style="display: flex;">
                        <div>
                          <span id="taskDateTitle"></span>
                        </div>
                        <div class="taskDateBadgeContainer">
                          <span class="badge bg-warning rounded-pill" id="taskDateBadge" style="font-size:10px; min-width: 30px">0</span>
                        </div>
                      </h5>
                    </div>
                    <div>
                      <div class="btn-group">
                        <button type="button" class="btn body-button" style="width: 110px;" id="addTaskBtn">
                          <i class="fa-solid fa-plus"></i> 新建日程
                        </button>
                        <button type="button" class="btn body-button" style="width: 80px;" id="allTasksToggleBtn">
                          <i class="fa-solid fa-list"></i> 全部
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="taskContentList" id="taskContentList"></div>
                </div>

                <!-- 任务日历侧边栏 -->
                <div class="tackCalendar"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <script>
        const requiredMsg = '不能为空', 
              endTimeBeforeStartTimeMsg = '结束时间不能早于开始时间',
              playbackCycleWeekMsg = '当播放周期为每周时, 必须选择一周中的某一天或者某几天';
        const taskModal = new bootstrap.Modal(document.getElementById("taskModal")), // 任务弹框
              syncTaskModal = new bootstrap.Modal(document.getElementById("syncTaskModal")), // 同步任务弹框
              sourceModal = new bootstrap.Modal(document.getElementById("sourceModal")), // 音源弹框
              filesModal = new bootstrap.Modal(document.getElementById("filesModal")), // 文件弹框
              inputChannelsModal = new bootstrap.Modal(document.getElementById("inputChannelsModal")), // 输入通道弹框
              playAreasAddModal = new bootstrap.Modal(document.getElementById("playAreasAddModal")), // 新增播放区域弹框
              playAreasDetailModal = new bootstrap.Modal(document.getElementById("playAreasDetailModal")); // 播放区域详情弹框
        const $filesModalTable = $('#filesModalTable');
        const protocol = window.location.protocol,
              hostname = window.location.hostname,
              domainID = sessionStorage.getItem("domainID");
        let comID = "";
        if (domainID) {
          fetch(`/ui/domains/${domainID}/domainInJSON`, {
            method: "GET",
          })
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json(); // 直接将流转换为JSON对象
            })
            .then(json => {
              const data = json.data;
              const domainData = JSON.parse(data).domainData;
              comID = domainData.metadata["comID"];
            })
        }

        let isListAllTask = false, 
            selectedDate = moment().format('YYYY-MM-DD'),
            showMoreSettingTaskModal = false, 
            showMoreSettingSourceModal = false,
            selectedFilesModal = [],
            selectedPlayAreas = [],
            playAreaTreeData = [],
            $playAreaTree = null,
            addPlayAreaModalIsOpenedFromDetailModal = false,
            selectedSourceObject = {
              files:[],
              devices: [],
            },
            taskModalType = 'add',
            taskDateBadgeCurrentValue = 0,
            taskDateBadgeTargetValue = 0,
            taskDateBadgeIncrement = 1,
            allThingsList = [],
            breadCrumbFolderList = [], //当前选中文件夹列表-文件弹框
            currentFolderKey = ""; //当前文件夹key-文件弹框;

        $(function() {
          // 初始化设定页面标题为当天
          $('#taskDateTitle').html(selectedDate);

          // 初始化日历
          $('.tackCalendar').pignoseCalendar({
            lang: 'ch',
            scheduleOptions: {
              colors: {
                offer: '#67c23a',
                ad: '#f56c6c'
              }
            },
            schedules: [{
              name: 'offer',
              date: '2024-07-01'
            }, {
              name: 'ad',
              date: '2024-07-03'
            }, {
              name: 'offer',
              date: '2024-07-05',
            }],
            page: function(info, context) {
              setTimeout(() => {
                highlightTodayOnCalendar();
              }, 0);
            },
            select: function(dates, context) {
              isListAllTask = false;
              selectedDate = moment(dates[0]).format('YYYY-MM-DD');
              $('#taskDateTitle').html(selectedDate);
              $('#allTasksToggleBtn').html(`<i class="fa-solid fa-list"></i> 全部`);
              highlightTodayOnCalendar();
              getTaskList(selectedDate);
            }
          });

          // 点击全部/当天按钮时，切换任务列表
          $('#allTasksToggleBtn').click(function() {
            onClickAllTasksToggleBtn();
          });

          // 点击新建日程按钮时，显示新建日程模态框
          $('#addTaskBtn').click(function() {
            initAddTaskModal();
            createPlayAreasList();
            taskModal.show();
          });

          // 点击添加播放区域按钮-任务弹框
          $('#playAreasAddBtn').click(function() {
            addPlayAreaModalIsOpenedFromDetailModal = false;
            taskModal.hide();
            playAreasAddModal.show();

            $playAreaTree.uncheckAll();
            $playAreaTree.collapseAll();  

            const node = $playAreaTree.getNodeByText('全部');
            $playAreaTree.expand(node);
            if(selectedPlayAreas.length > 0) {
              const selectedPlayAreasId = selectedPlayAreas.map(playArea => playArea.id);
              selectedPlayAreasId.forEach(playAreaId => {
                const node = $playAreaTree.getNodeById(playAreaId);
                $playAreaTree.check(node);
              });
            }
          });

          // 点击添加播放区域弹框确定按钮-添加播放区域弹框
          $('#confirmPlayAreasAddModalBtn').click(function() {
            const checkedIds = $playAreaTree.getCheckedNodes().filter(id => !id.includes("group_"));
            const checkedPlayAreas = allThingsList.filter(thing => checkedIds.includes(thing.id));
            selectedPlayAreas = checkedPlayAreas.map(thing => thing);
            closePlayAreasAddModal();
          });

          // 点击播放区域详情按钮-任务弹框
          $('#playAreasDetailBtn').click(function() {
            taskModal.hide();
            playAreasDetailModal.show();
            createPlayAreasDetailList();
          });

           // 点击播放区域详情弹框确定按钮-播放区域详情弹框
           $('#confirmPlayAreasDetailModalBtn').click(function() {
            playAreasDetailModal.hide();
            taskModal.show();
            createPlayAreasList();
          });

          // 播放周期选择框变化时，改变周数选择框是否显示-任务弹框
          $('#playbackCycle').on('change blur', function() {
            const playbackCycleValue = $(this).val();
            if (!playbackCycleValue) {
              $('#playbackCycleError').html(requiredMsg);
              $('#playbackCycleError').show();
            } else {
              $('#playbackCycleError').hide();
              if (playbackCycleValue === 'week') {
                $('#weekCheckboxGroup').show();
              } else {
                $('#weekCheckboxGroup').hide();
              }
            }
          });

          // 音量微调选择框变化时，改变音量标签-任务弹框
          $('#volumeControl').change(function() {
            const volumeControlValue = $(this).val();
            $('#volumeLabel').html(volumeControlValue);
          });

          // 点击更多设置按钮时，切换显示更多设置-任务弹框
          $('#moreSettingBtnTaskModal').click(function() {
            showMoreSettingTaskModal = !showMoreSettingTaskModal;
            $('#moreSettingBtnTaskModal').empty();
            if (showMoreSettingTaskModal) {
              $('#moreSettingBtnTaskModal').append($(`<i class="fa-solid fa-chevron-up"></i>`));
              $('#moreSettingContainerTaskModal').show();
            } else {
              $('#moreSettingBtnTaskModal').append($(`<i class="fa-solid fa-chevron-down"></i>`));
              $('#moreSettingContainerTaskModal').hide();
            }
          });

          // 验证表单日程名称是否为空-任务弹框
          $('#taskName').on('change blur keyup', function(event) {
            const value = $(this).val();
            if (value) {
              $(`#taskNameError`).empty();
              $('#taskNameError').hide();
            } else {
              $(`#taskNameError`).html(requiredMsg);
              $('#taskNameError').show();
            }
          });

          // 验证表单音源名称是否为空-任务弹框
          $('#sourceName').on('change blur keyup', function(event) {
            const value = $(this).val();
            if (value) {
              $(`#sourceNameError`).empty();
              $('#sourceNameError').hide();
            } else {
              $(`#sourceNameError`).html(requiredMsg);
              $('#sourceNameError').show();
            }
          });

          // 开始时间初始化-任务弹框
          const startTimeFormatter = $(`#startTime`).data("formatter");
          jeDate(`#startTime`, {
            onClose:false,
            format: startTimeFormatter,
            clearfun:function(elem, val) {
              $('#startTimeError').html(requiredMsg);
              $('#startTimeError').show();
            },
            donefun: function(obj){
              const startTime = obj.val;
              const endTime = $(`#endTime`).val();
              if (startTime) {
                if (!endTime) {
                  $(`#endTime`).val(startTime);
                  $('#endTimeError').hide();
                }
                $('#startTimeError').hide();
              } else {
                $('#startTimeError').html(requiredMsg);
                $('#startTimeError').show();
              }
            },
          });
          
          // 结束时间初始化-任务弹框
          const endTimeFormatter = $(`#endTime`).data("formatter");
          jeDate(`#endTime`, {
            onClose:false,
            format: endTimeFormatter,
            clearfun:function(elem, val) {
              $('#endTimeError').html(requiredMsg);
              $('#endTimeError').show();
            },
            donefun: function(obj){
              const endTime = obj.val;
              if (!endTime) {
                $('#endTimeError').html(requiredMsg);
                $('#endTimeError').show();
              } else {
                const startTime = $(`#startTime`).val();
                if (!startTime) {
                  $('#endTimeError').html('请先设置开始时间');
                  $('#endTimeError').show();
                  $('#endTime').val('');
                } else {
                  // 将时间字符串转换为 Date 对象
                  const startTimeDate = new Date(startTime.replace(' ', 'T'));
                  const endTimeDate = new Date(endTime.replace(' ', 'T'));

                  // 比较两个 Date 对象
                  if (endTimeDate < startTimeDate) {
                    $(`#endTimeError`).html(endTimeBeforeStartTimeMsg);
                    $('#endTimeError').show();
                    $('#endTime').val('');
                  } else {
                    $('#endTimeError').hide();
                  }
                }
              }
            },
          });
          
          // 当选择开始时间时，如果结束时间为空，则自动填充结束时间-任务弹框
          $(`#startTime`).on('change blur', function(event) {
            const startTime = $(this).val();
            const endTime = $(`#endTime`).val();
            if (startTime) {
              if (!endTime) {
                $(`#endTime`).val(startTime);
              }
            } else {
              $(`#startTimeError`).html(requiredMsg);
              $('#startTimeError').show();
            }
          });

          // 当选择结束时间时，如果开始时间为空，则自动填充开始时间-任务弹框
          $(`#endTime`).on('change blur', function(event) {
            const endTime = $(this).val();
            const startTime = $(`#startTime`).val();
            if (endTime) {
              // 将时间字符串转换为 Date 对象
              const startTimeDate = new Date(startTime.replace(' ', 'T'));
              const endTimeDate = new Date(endTime.replace(' ', 'T'));

              // 比较两个 Date 对象
              if (endTimeDate < startTimeDate) {
                $(`#endTimeError`).html(endTimeBeforeStartTimeMsg);
                $('#endTimeError').show();
              } else {
                $('#endTimeError').hide();
              }
            } else {
              $(`#endTimeError`).html(requiredMsg);
              $('#endTimeError').show();
            }
          });

          // 验证表单播放周期是否为空-任务弹框
          $('.taskWeekCheckbox').change(function() {
            let checkedWeeks = [];
            $('.taskWeekCheckbox:checked').each(function() {
                checkedWeeks.push($(this).val());
            });
            if (!checkedWeeks.length) {
              $(`#playbackCycleError`).html(playbackCycleWeekMsg);
              $('#playbackCycleError').show();
            } else {
              $('#playbackCycleError').hide();
            }
          });

          // 点击新建日程表单的提交按钮时，验证表单数据是否合法-任务弹框
          $(`#addTaskForm`).on('submit', function(e) {
            e.preventDefault();
            const taskName = $(`#taskName`).val();
            const sourceName = $(`#sourceName`).val();
            const startTime = $(`#startTime`).val();
            const endTime = $(`#endTime`).val();
            const playbackCycleValue = $(`#playbackCycle`).val();

            if(!taskName || !sourceName || !playbackCycleValue || !startTime || !endTime || !selectedPlayAreas || !selectedPlayAreas.length) {
              if (!taskName) {
                $(`#taskNameError`).html(requiredMsg);
                $('#taskNameError').show();
              } 
              if (!sourceName) {
                $(`#sourceNamerror`).html(requiredMsg);
                $('#sourceNameError').show();
              } 
              if (!playbackCycleValue || playbackCycleValue === '0') {
                $('#playbackCycleError').html(requiredMsg);
                $('#playbackCycleError').show();
              } 
              if (!startTime) {
                $(`#startTimeError`).html(requiredMsg);
                $('#startTimeError').show();
              }
              if (!endTime) {
                $(`#endTimeError`).html(requiredMsg);
                $('#endTimeError').show();
              }
              if (!selectedPlayAreas || !selectedPlayAreas.length) {
                $('#playAreaError').html(requiredMsg);
                $('#playAreaError').show();
              }
              return;
            } else {
              if (startTime && endTime) {
                // 将时间字符串转换为 Date 对象
                const startTimeDate = new Date(startTime.replace(' ', 'T'));
                const endTimeDate = new Date(endTime.replace(' ', 'T'));
                // 比较两个 Date 对象
                if (endTimeDate < startTimeDate) {
                  $(`#endTimeError`).html(endTimeBeforeStartTimeMsg);
                  $('#endTimeError').show();
                  return;
                }
              }
              if (playbackCycleValue === 'week') {
                let checkedWeeks = [];
                $('.taskWeekCheckbox:checked').each(function() {
                  checkedWeeks.push($(this).val());
                });
                if (!checkedWeeks.length) {
                  $(`#playbackCycleError`).html(playbackCycleWeekMsg);
                  $('#playbackCycleError').show();
                  return;
                }
              }
              
              if (taskModalType === 'add') {
                showAlert('success', '日程创建成功');
              } else {
                showAlert('success', '日程编辑成功');
              }
              taskModal.hide();
            }
          });

          // 重复次数开关-任务弹框
          $('#repeatNumSwitch').on('change', function() {
            if ($(this).is(':checked')) {
              $('#endTime').prop('disabled', true);
              $('#endTimeError').hide();
            } else {
              $('#endTime').prop('disabled', false);
            }
          });

          //重复次数下拉框生成-任务弹框
          $('#repeatNum').empty();
          for(let i = 1; i <= 100; i++) {
            const $option = $(`<option value="${i}">${i}</option>`);
            $('#repeatNum').append($option);
          }

          //点击音源选择按钮-打开音源弹框
          $('#selectSourceBtn').click(function() {
            showMoreSettingSourceModal = false;
            $('#moreSettingBtnSourceModal').empty();
            $('#moreSettingBtnSourceModal').append($(`<i class="fa-solid fa-chevron-down"></i>`));
            $('#moreSettingContainerSourceModal').hide();
            createSourceModalFileList();
            createSourceModalDeviceList();
            taskModal.hide();
            sourceModal.show();
          });

          // 点击更多设置按钮时，切换显示更多设置-音源弹框
          $('#moreSettingBtnSourceModal').click(function() {
            showMoreSettingSourceModal = !showMoreSettingSourceModal;
            $('#moreSettingBtnSourceModal').empty();
            if (showMoreSettingSourceModal) {
              $('#moreSettingBtnSourceModal').append($(`<i class="fa-solid fa-chevron-up"></i>`));
              $('#moreSettingContainerSourceModal').show();
            } else {
              $('#moreSettingBtnSourceModal').append($(`<i class="fa-solid fa-chevron-down"></i>`));
              $('#moreSettingContainerSourceModal').hide();
            }
          });

          // 点击音源弹框中的关闭按钮时，隐藏音源弹框
          $('#sourceModalConfirmBtn').click(function() {
            sourceModal.hide();
            taskModal.show();
          });

          $filesModalTable.bootstrapTable({});
          // 点击添加文件按钮打开文件弹框
          $('#addSourceModalFileBtn').click(function() {
            sourceModal.hide();
            filesModal.show();
            loadFilesTable("");
          });
          // 文件弹框中点击确认按钮时，隐藏文件弹框并更新音源弹框中的文件列表
          $('#confirmFileBtn').click(function() {
            filesModal.hide();
            sourceModal.show();
            const selectedRows = $filesModalTable.bootstrapTable('getSelections');
            if (!selectedSourceObject.files.length) {
              selectedSourceObject.files = selectedRows;
            } else {
              // 将b中在a中不存在的项找到
              const itemsToAdd = selectedRows.filter(itemB => !selectedSourceObject.files.some(itemA => itemA.key === itemB.key));
              // 将这些项添加到a中
              const updatedFiles = selectedSourceObject.files.concat(itemsToAdd);
              selectedSourceObject.files = updatedFiles;
            }
            createSourceModalFileList();
          });

          const $inputChannelsModalTable = $('#inputChannelsModalTable');
          $inputChannelsModalTable.bootstrapTable({
            data: [],
          });
          // 点击添加设备按钮打开设备弹框
          $('#addSourceModalDeviceBtn').click(function() {
            sourceModal.hide();
            inputChannelsModal.show();
            $inputChannelsModalTable.bootstrapTable('load', []);
          });
          
          // 设备弹框中点击确认按钮时，隐藏设备弹框并更新音源弹框中的设备列表
          $('#confirmInputChannelsBtn').click(function() {
            inputChannelsModal.hide();
            sourceModal.show();
            const selectedRows = $inputChannelsModalTable.bootstrapTable('getSelections');
            selectedSourceObject.devices = selectedRows;
            createSourceModalDeviceList();
          });

          // 高亮日历侧边栏中的今天
          highlightTodayOnCalendar();

          // 获取任务列表
          getTaskList(selectedDate);

          getPlayAreaTree();
        });

        // 点击全部/当天按钮时，切换任务列表
        function onClickAllTasksToggleBtn() {
          if (isListAllTask) {
            isListAllTask = false;
            $('#taskDateTitle').html(selectedDate);
            $('#allTasksToggleBtn').html(`<i class="fa-solid fa-list"></i> 全部`);
            getTaskList(selectedDate);
          } else {
            isListAllTask = true;
            $('#taskDateTitle').html("全部日程");
            $('#allTasksToggleBtn').html(`<i class="fa-solid fa-list"></i> 当天`);
            getTaskList();
          }
        }

        // 高亮当前日历中的今天
        function highlightTodayOnCalendar() {
          // 获取当前日期
          const currentDate = moment().format('YYYY-MM-DD');

          // 遍历所有具有特定类名的元素
          $('.pignose-calendar-unit-date').each(function() {
            const dataDate = $(this).data('date');
            const classes = $(this).attr('class').split(' ');

            // 检查类中是否包含 pignose-calendar-unit-active 或 pignose-calendar-unit-first-active
            if (dataDate === currentDate) {
              if (
                !classes.includes('pignose-calendar-unit-active') && 
                !classes.includes('pignose-calendar-unit-first-active')
              ) {
                // 修改 <a> 标签的 style.color 样式
                $(this).find('a').css('color', '#f56c6c');
              } else {
                $(this).find('a').css('color', '#ffffff');
              }
            }
          });
        }

        // 创建任务列表项
        function getTaskList(date) {
          $(`#taskContentList`).empty();
          setTaskDateBadgeValue(0);
;          const rawData = [
            {id: 1, time: '16:27', name: '任务1', status: 'stopped', repeatType: '日重复', enabled: true},
            {id: 2, time: '17:27', name: '任务2', status: 'running', repeatType: '日重复', enabled: true},
            {id: 3, time: '18:27', name: '任务3', status: 'stopped', repeatType: '周重复', enabled: false},
          ];
          let taskList = [];
          if (date) {
            taskList = [rawData[0], rawData[1]];
          } else {
            taskList = [rawData[0], rawData[1], rawData[2]];
          }
          taskList.forEach(function(task) {
            createTaskItem(task);
          });
          setTaskDateBadgeValue(taskList.length);
        }

        // 创建任务列表项
        function createTaskItem(task) {
          const taskSwitch = task.enabled ? 
            `
              <label class="switch">
                <input class="switchCheckbox" type="checkbox" checked  data-id="${task.id}" onchange="enableOrDisableTask(this)" />
                <span class="switchSlider"></span>
              </label>
            ` : 
            `
              <label class="switch">
                <input class="switchCheckbox" type="checkbox"  data-id="${task.id}" onchange="enableOrDisableTask(this)" />
                <span class="switchSlider"></span>
              </label>
            `;
          const playBtnBox = task.status === 'running' ? 
            `<i class="fa-solid fa-circle-stop" style="color: #f56c6c;" data-id="${task.id}" onclick="stopTask(this)"></i>` : 
            `<i class="fa-solid fa-circle-play" style="color: #2ec6cc;" data-id="${task.id}" onclick="playTask(this)"></i>`;
          const btnGroup = task.status === 'running' ? 
            `
              <div class="runningTaskIndicatorContainer">
                <image src="/images/icon_runningTask.gif" />
              </div>
            ` : 
            `
              <div class="dropdown" style="float: right; top: 5px;">
                <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="color: dimgray;">
                  <i class="fa-solid fa-ellipsis"></i>
                </button>
                <ul class="dropdown-menu">
                  <li>
                    <a class="dropdown-item" data-id="${task.name}" data-taskname="${task.name}" onclick="syncTask(this)">
                      <i class="fa-solid fa-rotate" style="width: 16px;"></i> 同步
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" data-id="${task.id}" data-taskname="${task.name}" onclick="editTask(this)">
                      <i class="fa-solid fa-pencil-alt" style="width: 16px;"></i> 编辑
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" data-id="${task.id}" data-taskname="${task.name}" onclick="copyTask(this)">
                      <i class="fa-solid fa-copy" style="width: 16px;"></i> 复制
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" data-id="${task.id}" data-taskname="${task.name}" onclick="deleteTask(this)">
                      <i class="fa-solid fa-trash-can" style="width: 16px;"></i> 删除
                    </a>
                  </li>
                </ul>
              </div>
            `;
          const $taskItem = $(`
            <div class="taskItem ${task.status === 'running' ? 'activeTask' : ''}" style="border-color: ${task.status === 'running' ? '#ff8a00' : '#00c6ff'}">
              <div style="display: flex; align-items: center;">
                <div class="taskTime">${task.time}</div>
                <div class="line" style="margin: 0px 50px;"></div>
                <div>
                  <div title="1" class="textEllipsis">${task.name}</div>
                  <div title="${task.repeatType}" class="textEllipsis" style="height: 27px; color: rgb(174, 186, 194); font-size: 12px;">
                    <i class="fa-solid fa-location-dot" style="margin-right: 3px;"></i>
                    ${task.repeatType}
                  </div>
                </div>
              </div>
              <div style="min-width: 140px;">
                <div style="display: inline-block; line-height: 35px;">
                  ${taskSwitch}
                </div>
                <div class="playBtnBox">
                  ${playBtnBox}
                </div>
                <div style="display: inline-block;">
                  ${btnGroup}
                </div>
              </div>
            </div>
          `);
          
          $(`#taskContentList`).append($taskItem);
        } 

        // 启用、禁用任务
        function enableOrDisableTask(element) {
          const taskId = $(element).data("id");
          if ($(this).is(':checked')) {
            showAlert('success', '启用成功！');
          } else {
            showAlert('success', '禁用成功！');
          }
        }

        // 播放任务
        function playTask(element) {
          const taskId = $(element).data("id");
          showAlert('success', '播放成功！');
        }

        // 停止任务
        function stopTask(element) {
          const taskId = $(element).data("id");
          showAlert('success', '停止成功！');
        }

        // 同步任务
        function syncTask(element) {
          const taskId = $(element).data("id");
          syncTaskModal.show();

          const $syncTaskTable = $('#syncTaskTable');
          $syncTaskTable.bootstrapTable({
            data: [],
          });

          $('#oneClickSyncTaskBtn').on('click', () => {
            syncTaskModal.hide();
            showAlert('success', '同步成功！');
          });
        }

        // 同步任务表格格式化-设备名称
        function deviceNameTableFormatter(value, row, index) {
          if (row.isDir) {
            return `<div style="cursor: pointer">
                      <img src="/images/icon_folder.png" style="width: 16px; margin-bottom: 3px;"/>
                      <span data-key="${row.key}" data-filename="${row.fileName}">${value}</span>
                    </div>`;
          } else {
            return `<div>
                      <img src="/images/icon_mp3.png" style="width: 16px; margin-bottom: 3px;"/>
                      <span>${value}</span>
                    </div>`;
          }
        }

        // 同步状态表格格式化-同步状态
        function syncStatusTableFormatter(value, row, index) {
          if (row.isDir) {
            return `<div style="cursor: pointer">
                      <img src="/images/icon_folder.png" style="width: 16px; margin-bottom: 3px;"/>
                      <span data-key="${row.key}" data-filename="${row.fileName}">${value}</span>
                    </div>`;
          } else {
            return `<div>
                      <img src="/images/icon_mp3.png" style="width: 16px; margin-bottom: 3px;"/>
                      <span>${value}</span>
                    </div>`;
          }
        }

        // 复制任务
        function copyTask(element) {
          const taskId = $(element).data("id");
          showAlert('success', '复制成功！');
        }

        // 编辑任务
        function editTask(element) {
          const taskName = $(element).data("taskname");
          $('#taskModalLabel').html('编辑日程');
          taskModalType = 'edit';
          $('#endTime').attr("disabled", true);
          $('#repeatNumContainer').show();
          $('#repeatNum').val('1');
          $('#repeatNumSwitch').prop("checked", true );
          taskModal.show();
        }

        // 删除任务
        function deleteTask(element) {
          const taskId = $(element).data("id");
          showConfirmModal("你确定要删除所选数据吗？", () => {
            showAlert('success', '删除成功！');
          });
        }

        // 更新任务数量
        function updateDisplay() {
          if (taskDateBadgeCurrentValue !== taskDateBadgeTargetValue) {
            taskDateBadgeCurrentValue += taskDateBadgeIncrement;
            $(`#taskDateBadge`).html(taskDateBadgeCurrentValue);
            requestAnimationFrame(updateDisplay);
          }
        }

        // 生成播放区域列表-任务弹框
        function createPlayAreasList(){
          $('#playAreaListsContainer').empty();
          if (selectedPlayAreas.length > 0) {
            const limit = selectedPlayAreas.length >= 4 ? 4 : selectedPlayAreas.length;
            for (let i = 0; i < limit; i++) {
              const $playArea = $(`
                <div class="d-grid col-6" title="${selectedPlayAreas[i].metadata.aliase}">
                  <button disabled type="button" class="btn btn-light truncate-text" style="color: #20afbf;">
                    <img src="/images/icon_channel.png" class="channel-icon" />
                    <span>${selectedPlayAreas[i].metadata.aliase}</span>
                  </button>
                </div>
              `);
              $('#playAreaListsContainer').append($playArea);
            }
          }
        }

        // 关闭添加播放区域弹框-添加播放区域弹框
        function closePlayAreasAddModal() {
          playAreasAddModal.hide();
          if (addPlayAreaModalIsOpenedFromDetailModal) {
            playAreasDetailModal.show();
            createPlayAreasDetailList();
          } else {
            taskModal.show();
          }
          createPlayAreasList();
        }

        // 获取组装播放区域设备树-播放区域弹框
        function getPlayAreaTree() {
          playAreaTreeData = [{
            id: "root",
            key: 'group_root',
            text: "全部",
            flagUrl: null,
            children: [
              {
                id: "unassigned",
                key: "group_unassigned",
                text: "未分区",
                flagUrl: "/images/icon_organization_area.svg",
                metadata: {
                  "thing_ids": []
                },
                children: []
              },
            ]
          }];
          allThingsList = [];
          // 获取所有设备
          fetch(`/ui/things/thingsInJSON?page=1&limit=1000&onlineStatus=2`, {
            method: "GET",
          })
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json(); // 直接将流转换为JSON对象
            })
            .then(json => {
              const data = json.data;
              const thingsData = JSON.parse(data).thingsData;
              const things = thingsData.things;
              if (things.length) {
                allThingsList = things.map((thing) => thing);
              }
              // 获取所有分区
              fetch(`/ui/channels/channelsInJSON?page=1&limit=1000`, {
                method: "GET",
              })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json(); // 直接将流转换为JSON对象
                })
                .then((json) => {
                    const data = json.data;
                    const channelsData = JSON.parse(data).channelsData;
                    const channels = channelsData.groups;
                    if (channels.length) {
                      channels.forEach((channel) => {
                        const channelNode = {
                          id: channel.id,
                          text: channel.name,
                          name: channel.name,
                          key: `group_${channel.id}`,
                          flagUrl: "/images/icon_organization_area.svg",
                          metadata: channel.metadata,
                          children: channel.metadata && channel.metadata.thing_ids && channel.metadata.thing_ids.length ? 
                            channel.metadata.thing_ids.map((thingId) => {
                              const targetThing = allThingsList.find((thing) => thingId === thing.id);
                              if (targetThing && targetThing.id) {
                                return {
                                  id: targetThing.id,
                                  text: targetThing.metadata.aliase,
                                  name: targetThing.name,
                                  key: `${targetThing.id}`,
                                  flagUrl: "/images/icon_channel.png",
                                  metadata: targetThing.metadata,
                                }
                              } else {
                                return {}
                              }
                            }).filter((thing)=>thing.id) : [],
                        };
                        playAreaTreeData[0].children.push(channelNode);
                      });
                      const allConnectedThingsID = [...new Set(channels.flatMap(channel => channel.metadata.thing_ids))]; // 获取所有已连接分区的设备ID
                      const allUnconnectedThings = allThingsList.filter((thing) => !allConnectedThingsID.includes(thing.id)); // 获取所有未连接分区的设备
                      // 未分区
                      allUnconnectedThings.forEach((thing) => {
                        const thingNode = {
                          id: thing.id,
                          text: thing.metadata.aliase,
                          name: thing.name,
                          key: `${thing.id}`,
                          flagUrl: "/images/icon_channel.png",
                          metadata: thing.metadata,
                        };
                        playAreaTreeData[0].children[0].children.push(thingNode);
                      });
                    } else {
                      //没有分区时，所有设备都属于未分区
                      allThingsList.forEach((thing) => {
                        const thingNode = {
                          id: thing.id,
                          text: thing.metadata.aliase,
                          name: thing.name,
                          key: `${thing.id}`,
                          flagUrl: "/images/icon_channel.png",
                          metadata: thing.metadata,
                        };
                        playAreaTreeData[0].children[0].children.push(thingNode);
                      });
                    }
                    $playAreaTree = $('#playAreaTree').tree({
                      primaryKey: 'key',
                      uiLibrary: 'bootstrap5',
                      dataSource: playAreaTreeData,
                      checkboxes: true,
                      imageUrlField: 'flagUrl'
                    });
                });
            })
            .catch(error => {});
        }

        // 打开添加播放区域弹框-播放区域详情弹框
        function openPlayAreasAddModalFromDetailModal() {
          addPlayAreaModalIsOpenedFromDetailModal = true;
          playAreasDetailModal.hide();
          playAreasAddModal.show();
        }

        // 生成播放区域详情列表-播放区域详情弹框
        function createPlayAreasDetailList() {
          $('#playAreasDetailListContainer').empty();
          const $addPlayAreaCard = $(`
            <div class="d-grid col-4" title="添加" style="cursor: pointer;">
              <div class="channel-thing-card card" style="height:95px;" onclick="openPlayAreasAddModalFromDetailModal()">
                <div class="card-body" style="text-align: center;">
                  <i class="fa-solid fa-plus" style="font-size: 32px; color: #20afbf;"></i>
                  <div class="truncate-text" style="font-size: 14px; width: 100%;">
                    添加
                  </div>
                </div>
              </div>
            </div>
          `);

          if (selectedPlayAreas.length > 0) {
            const limit = selectedPlayAreas.length;
            for (let i = 0; i < limit; i++) {
              const $playAreaDetailItem = $(`
                <div class="d-grid col-4" title="${selectedPlayAreas[i].metadata.aliase}">
                  <div class="channel-thing-card card" style="height:95px;">
                    <div class="card-body" style="text-align: center;">
                      <img src="/images/icon_channel.png" style="margin-bottom: 5px; width: 32px;" />
                      <div class="truncate-text" style="font-size: 14px; width: 100%;">
                        ${selectedPlayAreas[i].metadata.aliase}
                      </div>
                    </div>
                  </div>
                </div>
              `);
              $('#playAreasDetailListContainer').append($playAreaDetailItem);
            }
            $('#playAreasDetailListContainer').append($addPlayAreaCard);
          } else {
            $('#playAreasDetailListContainer').append($addPlayAreaCard);
          }
        }

        // 设置任务数量
        function setTaskDateBadgeValue(newValue) {
          taskDateBadgeTargetValue = newValue;
          taskDateBadgeIncrement = (taskDateBadgeTargetValue > taskDateBadgeCurrentValue) ? 1 : -1;
          requestAnimationFrame(updateDisplay);
        }

        // 初始化添加任务模态框表单
        function initAddTaskModal () {
          taskModalType = 'add';
          selectedFilesModal = [];
          $('#taskModalLabel').html('新建日程');

          $('#taskName').val('');
          $('#taskNameError').hide();

          $('#sourceName').val('');
          $('#sourceNameError').hide();

          $('#startTime').val('');
          $('#startTimeError').hide();

          $('#endTime').val('');
          $('#endTimeError').hide();
          $('#endTime').attr("disabled", false);

          $('#playbackCycle').val('0');
          $('#playbackCycleError').hide();

          $('#weekCheckboxGroup').hide();
          $('.taskWeekCheckbox').prop('checked', false);

          selectedPlayAreas = [];
          $('#playAreaError').hide();

          showMoreSettingTaskModal = false;
          $('#moreSettingBtnTaskModal').empty();
          $('#moreSettingBtnTaskModal').append($(`<i class="fa-solid fa-chevron-down"></i>`));
          $('#moreSettingContainerTaskModal').hide();
         
          $('#randomPlay').prop('checked', false);

          $('#volumeControl').val('0');
          $('#volumeLabel').html(0);

          $('#level1').prop('checked', false);
          $('#level2').prop('checked', true);
          $('#level3').prop('checked', false);

          $('#repeatNumContainer').hide();

          // 音源选择弹框相关
          showMoreSettingSourceModal = false;
          $('#moreSettingBtnSourceModal').empty();
          $('#moreSettingBtnSourceModal').append($(`<i class="fa-solid fa-chevron-down"></i>`));
          $('#moreSettingContainerSourceModal').hide();

          $('#backgroundSource').empty();
          $('#backgroundSource').append($(`<option value="0" selected>无</option>`));
          selectedSourceObject = {
            files:[],
            devices: [],
          };
          
          $('#sourceModalFileListContainer').empty();
          $('#sourceModalDeviceListContainer').empty();
        }
      
        // 生成音源文件列表-音源弹框
        function createSourceModalFileList() {
          $('#sourceModalFileListContainer').empty();
          if (selectedSourceObject.files && selectedSourceObject.files.length) {
            selectedSourceObject.files.forEach((file, index) => {
              const $fileItem = $(`
                <li class="list-group-item sourceModalListItem">
                  <div>
                    <span>${file.fileName}</span>
                  </div>
                  <div>
                    <span
                      title="复制"
                      style="margin-right: 10px; color: #20afbf; cursor: pointer;"
                      onclick="copyFileForSourceModal('${file.key}')"
                    >
                      <i class="fa-solid fa-copy"></i>
                    </span>
                    <span
                      title="移除"
                      style="color: #20afbf; cursor: pointer;"
                      onclick="removeFileForSourceModal('${file.key}', '${index}')"
                    >
                      <i class="fa-solid fa-trash"></i>
                    </span>
                  </div>
                </li>
              `);
              $('#sourceModalFileListContainer').append($fileItem);
            });
          }
          updateBackgroundSourceOptions();
        }

        // 音源文件列表中复制文件-音源弹框
        function copyFileForSourceModal(key) {
          const targetFile = selectedSourceObject.files.find(file => String(file.key) === key);
          const targetIndex = selectedSourceObject.files.findIndex(file => String(file.key) === key);
          if (targetIndex !== -1) {
            selectedSourceObject.files.splice(targetIndex, 0, targetFile);
            createSourceModalFileList();
          }
        }

        // 音源文件列表中移除文件-音源弹框
        function removeFileForSourceModal(key, index) {
          selectedSourceObject.files.splice(index, 1);
          createSourceModalFileList();
        }

        // 生成音源设备列表-音源弹框
        function createSourceModalDeviceList() {
          $('#sourceModalDeviceListContainer').empty();
          if (selectedSourceObject.devices && selectedSourceObject.devices.length) {
            selectedSourceObject.devices.forEach((device, index) => {
              const $deviceItem = $(`
                <li class="list-group-item sourceModalListItem">
                  <div>
                    <img src="/images/icon_channel.png" class="channel-icon" />
                    <span>${device.name}</span>
                  </div>
                  <div>
                    <span
                      title="移除"
                      style="color: #20afbf; cursor: pointer;"
                      onclick="removeDeviceForSourceModal('${device.key}', '${index}')"
                    >
                      <i class="fa-solid fa-trash"></i>
                    </span>
                  </div>
                </li>
              `);
              $('#sourceModalDeviceListContainer').append($deviceItem);
            });
          }
          updateBackgroundSourceOptions();
        }

        // 音源设备列表中移除设备-音源弹框
        function removeDeviceForSourceModal(key, index) {
          selectedSourceObject.devices.splice(index, 1);
          createSourceModalDeviceList();
        }

        // 更新音源选择弹框中背景音下拉框的选项-音源弹框
        function updateBackgroundSourceOptions() {
          $('#backgroundSource').empty();
          $('#backgroundSource').append($(`<option value="0">无</option>`));
          if (selectedSourceObject.files.length) {
            $('#backgroundSource').append($(`<option value="file">文件</option>`));
          }
          if (selectedSourceObject.devices.length) {
            selectedSourceObject.devices.forEach(device => {
              $('#backgroundSource').append($(`<option value="${device.id}">${device.name}</option>`));
            });
          }
        }

        // 音源设备表格设备名称-设备弹框
        function inputChannelNameTableFormatter(value, row, index) {
          return `<div>
                    <img src="/images/icon_channel.png" style="width: 16px; margin-bottom: 3px;"/>
                    <span data-key="${row.key}" data-devicename="${row.deviceName}">${value}</span>
                  </div>`;
        }

        // 初始化加载文件列表-文件弹框
        function loadFilesTable(folder) {
          $filesModalTable.bootstrapTable('load', []);
          if (!folder) {
            breadCrumbFolderList = [];
            breadCrumbFolderList.push({fileName: "文件列表", key: ""});
            currentFolderKey = "";
            generateBreadCrumb(breadCrumbFolderList);
          }

          fetch(`${protocol}//${hostname}:9102/resourceList`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ path: folder, comID: comID })
          })
            .then(response => {
              if (!response.ok) {
                  throw new Error("Network response was not ok");
              }
              return response.json(); // 直接将流转换为JSON对象
            }).then(data => {
              $filesModalTable.bootstrapTable('load', data || []);
              if(selectedSourceObject.files && selectedSourceObject.files.length) {
                const selectKeys = selectedSourceObject.files.map(file => file.key);
                $filesModalTable.bootstrapTable('checkBy', {field: 'key', values: selectKeys});
              }
            }).catch(error => {
              console.error('Error:', error);
            });
        }

        // 禁用文件夹勾选框-文件弹框
        function fileNameTableStateFormatter(value, row, index) {
          if (row.isDir) {
            return {
              disabled: true
            }
          }
          return value
        }
        
        // 文件名称-文件弹框
        function fileNameTableFormatter(value, row, index) {
          if (row.isDir) {
            return `<div style="cursor: pointer">
                      <img src="/images/icon_folder.png" style="width: 16px; margin-bottom: 3px;"/>
                      <span data-key="${row.key}" data-filename="${row.fileName}" onclick="onClickFolder(event)">${value}</span>
                    </div>`;
          } else {
            return `<div>
                      <img src="/images/icon_mp3.png" style="width: 16px; margin-bottom: 3px;"/>
                      <span>${value}</span>
                    </div>`;
          }
        }

        //生成面包屑导航-文件弹框
        function generateBreadCrumb(folderList) {
          //监听breadCrumbFolderList变化，更新面包屑导航
          const breadcrumbNavigator = $("#breadcrumbNavigator");
          breadcrumbNavigator.empty();
          folderList.forEach((folder, index) => {
            let activeClass = "";
            if (index === folderList.length - 1) {
              activeClass = "active";
            }
            const li = $(`
              <li 
                class="breadcrumb-item ${activeClass}" 
                data-key="${folder.key}" 
                data-filename="${folder.fileName}" 
                onclick="onClickBreadcrumbItem(event)"
              >
                ${folder.fileName}
              </li>
            `);
            breadcrumbNavigator.append(li);
          });
        }

        //点击breadCrumb-文件弹框
        function onClickBreadcrumbItem(e) {
          console.log(e.target);
          const key = e.target.dataset.key;
          currentFolderKey = key;
          //删除后面的所有文件夹
          const rowIndex = breadCrumbFolderList.findIndex(item => item.key === key);
          breadCrumbFolderList.splice(rowIndex + 1, breadCrumbFolderList.length - rowIndex);

          generateBreadCrumb(breadCrumbFolderList);
          loadFilesTable(key);
        }

        //点击表格中文件夹-文件弹框
        function onClickFolder(e) {
          const key = e.target.dataset.key;
          const fileName = e.target.dataset.filename;
          currentFolderKey = key;
          breadCrumbFolderList.push({fileName: fileName, key: key});
          generateBreadCrumb(breadCrumbFolderList);
          loadFilesTable(key);
        }
      </script>
    </body>
  </html>
{{ end }}
