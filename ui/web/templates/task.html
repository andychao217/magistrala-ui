<!-- Copyright (c) Abstract Machines
SPDX-License-Identifier: Apache-2.0 -->

{{ define "task" }}
  <!doctype html>
  <html lang="en">
    <head>
      <title>日程</title>
      {{ template "header" }}
      <style>
        
      </style>
    </head>
    <body>
      {{ template "navbar" . }}
      <div class="main-content pt-3">
        <div class="container-fluid">
          <div class="row-mb-3 p-3">
            <div class="col-lg-12 mx-auto">

              <!-- add task modal -->
              <div class="modal fade" id="addTaskModal" tabindex="-1" role="dialog" aria-labelledby="addTaskModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                  <div class="modal-content" style="width: 570px;">
                    <div class="modal-header">
                      <h1 class="modal-title" id="addTaskModalLabel">新建日程</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" id="addTaskForm">
                      <div class="modal-body">
                          <div class="form-group mb-3">
                            <div class="mb-3 row">
                              <label for="taskName" class="col-sm-2 col-form-label">日程名称</label>
                              <div class="col-sm-10">
                                <input type="text" class="form-control name-field" name="taskName" id="taskName" placeholder="请输入日程名称" required />
                              </div>
                              <div id="taskNameError" class="text-danger"></div>
                            </div>
                            <div class="mb-3 row">
                              <label for="startTime" class="col-sm-2 col-form-label">开始时间</label>
                              <div class="col-sm-10">
                                <input 
                                  type="text" 
                                  class="form-control dateinput dateicon moredate" 
                                  name="startTime" 
                                  placeholder="请选择开始时间" 
                                  data-formater="YYYY-MM-DD hh:mm:ss" 
                                  id="startTime" 
                                  required 
                                />
                              </div>
                              <div id="startTimeError" class="text-danger"></div>
                            </div>
                            <div class="mb-3 row">
                              <label for="playbackCycle" class="col-sm-2 col-form-label">播放周期</label>
                              <div class="col-sm-10">
                                <select class="form-control form-select" placeholder="请选择播放周期" name="playbackCycle" id="playbackCycle" required>
                                  <option value="0" selected>请选择播放周期</option>
                                  <option value="once">单次</option>
                                  <option value="day">每天</option>
                                  <option value="week">每周</option>
                                  <option value="month">每月</option>
                                  <option value="year">每年</option>
                                </select>
                                <div 
                                  class="form-conrtol" 
                                  id="weekCheckboxGroup" 
                                  style="
                                    border: none; 
                                    padding-left: 0; 
                                    padding-top: 10px; 
                                    display: none;
                                  "
                                >
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input taskWeekCheckbox" type="checkbox" name="weeks[]" id="weekCheckbox1" value="mon">
                                    <label class="form-check-label" for="weekCheckbox1">一</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="weeks[]" id="weekCheckbox2" value="tue">
                                    <label class="form-check-label" for="weekCheckbox2">二</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input taskWeekCheckbox" type="checkbox" name="weeks[]" id="weekCheckbox3" value="wed">
                                    <label class="form-check-label" for="weekCheckbox3">三</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input taskWeekCheckbox" type="checkbox" name="weeks[]" id="weekCheckbox4" value="thu">
                                    <label class="form-check-label" for="weekCheckbox4">四</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input taskWeekCheckbox" type="checkbox" name="weeks[]" id="weekCheckbox5" value="fri">
                                    <label class="form-check-label" for="weekCheckbox5">五</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input taskWeekCheckbox" type="checkbox" name="weeks[]" id="weekCheckbox6" value="sat">
                                    <label class="form-check-label" for="weekCheckbox6">六</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input taskWeekCheckbox" type="checkbox" name="weeks[]" id="weekCheckbox7" value="sun">
                                    <label class="form-check-label" for="weekCheckbox7">七</label>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="mb-3 row">
                              <div class="col-sm-12" style="text-align: center;">
                                <div id="moreSettingBtn" style="cursor: pointer;">
                                  <i class="fa-solid fa-chevron-down"></i>
                                </div>
                              </div>
                            </div>
                            <div class="mb-3" id="moreSettingContainer" style="display: none;">
                              <div class="mb-3 row">
                                <label for="endTime" class="col-sm-2 col-form-label">结束时间</label>
                                <div class="col-sm-10">
                                  <input 
                                  type="text" 
                                  class="form-control dateinput dateicon moredate" 
                                  name="startTime" 
                                  placeholder="请选择结束时间" 
                                  data-formatter="YYYY-MM-DD hh:mm:ss" 
                                  id="endTime" 
                                  required 
                                />
                                </div>
                                <div id="endTimeError" class="text-danger"></div>
                              </div>
                              <div class="mb-3 row">
                                <label for="randomPlay" class="col-sm-2 col-form-label">随机播放</label>
                                <div class="col-sm-10">
                                  <div class="form-control form-check form-switch" style="border: none;">
                                    <input class="form-check-input" type="checkbox" role="switch" name="randomPlay" id="randomPlay" />
                                  </div>
                                </div>
                              </div>
                              <div class="mb-3 row">
                                <label for="volumeControl" class="col-sm-2 col-form-label">音量微调</label>
                                <div class="col-sm-10" style="display: flex; margin-top: 7px;">
                                  <input 
                                    type="range" 
                                    class="form-conrtol form-range" 
                                    min="-7" 
                                    max="7" 
                                    step="1" 
                                    id="volumeControl"
                                    name="volumeControl"
                                  />
                                  <div id="volumeLabel" style="text-align: right; width: 30px; line-height: 25px;">0</div>
                                </div>
                              </div>
                              <div class="mb-3 row">
                                <label for="level" class="col-sm-2 col-form-label">优先级</label>
                                <div class="col-sm-10">
                                  <div class="btn-group form-conrtol" role="group">
                                    <input type="radio" class="btn-check" name="level" id="level1" autocomplete="off" value="1" />
                                    <label class="btn btn-outline-primary" for="level1">!</label>
                                    <input type="radio" class="btn-check" name="level" id="level2" autocomplete="off" value="2" />
                                    <label class="btn btn-outline-primary" for="level2">!!</label>
                                    <input type="radio" class="btn-check" name="level" id="level3" autocomplete="off" value="3" />
                                    <label class="btn btn-outline-primary" for="level3">!!!</label>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                              <button type="submit" class="btn body-button">确定</button>
                          </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="table-responsive table-container" id="taskPageContainer">
                <div class="taskContent">
                  <div class="taskContentHeaderBar">
                    <div>
                      <h5 style="display: flex;">
                        <div>
                          <span id="taskDateTitle"></span>
                        </div>
                        <div class="taskDateBadgeContainer">
                          <span class="badge bg-warning rounded-pill" id="taskDateBadge" style="font-size:10px; min-width: 30px">0</span>
                        </div>
                      </h5>
                    </div>
                    <div>
                      <div class="btn-group">
                        <button type="button" class="btn body-button" style="width: 90px;" id="addTaskBtn">新建日程</button>
                        <button type="button" class="btn body-button" style="width: 60px;" id="allTasksToggleBtn">全部</button>
                      </div>
                    </div>
                  </div>
                  <div class="taskContentList" id="taskContentList"></div>
                </div>
                <div class="tackCalendar"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <script>
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;
        const userInfoStr = sessionStorage.getItem("userInfo");

        let comID = "";
        if (userInfoStr) {
          const userInfo = JSON.parse(userInfoStr);
          comID = userInfo.metadata.comID;
        }

        let isListAllTask = false, 
            selectedDate = moment().format('YYYY-MM-DD'),
            showMoreSetting = false;

        const addTaskModal = new bootstrap.Modal(document.getElementById("addTaskModal"));
        $(function() {
          $('#taskDateTitle').html(selectedDate);

          // 初始化日历
          $('.tackCalendar').pignoseCalendar({
            lang: 'ch',
            scheduleOptions: {
              colors: {
                offer: '#67c23a',
                ad: '#f56c6c'
              }
            },
            schedules: [{
              name: 'offer',
              date: '2024-07-01'
            }, {
              name: 'ad',
              date: '2024-07-03'
            }, {
              name: 'offer',
              date: '2024-07-05',
            }],
            page: function(info, context) {
              setTimeout(() => {
                highlightTodayOnCalendar();
              }, 0);
            },
            select: function(dates, context) {
              isListAllTask = false;
              selectedDate = moment(dates[0]).format('YYYY-MM-DD');
              $('#taskDateTitle').html(selectedDate);
              $('#allTasksToggleBtn').html("全部");
              highlightTodayOnCalendar();
              getTaskList(selectedDate);
            }
          });

          // 点击全部/当天按钮时，切换任务列表
          $('#allTasksToggleBtn').click(function() {
            onClickAllTasksToggleBtn();
          });

          // 点击新建日程按钮时，显示新建日程模态框
          $('#addTaskBtn').click(function() {
            initAddTaskModal();
            addTaskModal.show();
          });

          // 播放周期选择框变化时，改变周数选择框是否显示
          $('#playbackCycle').change(function() {
            const playbackCycleValue = $(this).val();
            if (playbackCycleValue === 'week') {
              $('#weekCheckboxGroup').show();
            } else {
              $('#weekCheckboxGroup').hide();
            }
          });

          // 音量微调选择框变化时，改变音量标签
          $('#volumeControl').change(function() {
            const volumeControlValue = $(this).val();
            $('#volumeLabel').html(volumeControlValue);
          });

          // 点击更多设置按钮时，切换显示更多设置
          $('#moreSettingBtn').click(function() {
            showMoreSetting = !showMoreSetting;
            $('#moreSettingBtn').empty();
            if (showMoreSetting) {
              $('#moreSettingBtn').append($(`<i class="fa-solid fa-chevron-up"></i>`));
              $('#moreSettingContainer').show();
            } else {
              $('#moreSettingBtn').append($(`<i class="fa-solid fa-chevron-down"></i>`));
              $('#moreSettingContainer').hide();
            }
          });

          highlightTodayOnCalendar();

          getTaskList(selectedDate);
        });

        // 点击全部/当天按钮时，切换任务列表
        function onClickAllTasksToggleBtn() {
          if (isListAllTask) {
            isListAllTask = false;
            $('#taskDateTitle').html(selectedDate);
            $('#allTasksToggleBtn').html("全部");
            getTaskList(selectedDate);
          } else {
            isListAllTask = true;
            $('#taskDateTitle').html("全部日程");
            $('#allTasksToggleBtn').html("当天");
            getTaskList();
          }
        }

        // 高亮当前日历中的今天
        function highlightTodayOnCalendar() {
          // 获取当前日期
          const currentDate = moment().format('YYYY-MM-DD');

          // 遍历所有具有特定类名的元素
          $('.pignose-calendar-unit-date').each(function() {
            const dataDate = $(this).data('date');
            const classes = $(this).attr('class').split(' ');

            // 检查类中是否包含 pignose-calendar-unit-active 或 pignose-calendar-unit-first-active
            if (dataDate === currentDate) {
              if (
                !classes.includes('pignose-calendar-unit-active') && 
                !classes.includes('pignose-calendar-unit-first-active')
              ) {
                // 修改 <a> 标签的 style.color 样式
                $(this).find('a').css('color', '#f56c6c');
              } else {
                $(this).find('a').css('color', '#ffffff');
              }
            }
          });
        }

        // 创建任务列表项
        function getTaskList(date) {
          $(`#taskContentList`).empty();
          setTaskDateBadgeValue(0);
;          const rawData = [
            {id: 1, time: '16:27', name: '任务1', status: 'stopped', repeatType: '日重复', enabled: true},
            {id: 2, time: '17:27', name: '任务2', status: 'running', repeatType: '日重复', enabled: true},
            {id: 3, time: '18:27', name: '任务3', status: 'stopped', repeatType: '周重复', enabled: false},
          ];
          let taskList = [];
          if (date) {
            taskList = [rawData[0], rawData[1]];
          } else {
            taskList = [rawData[0], rawData[1], rawData[2]];
          }
          taskList.forEach(function(task) {
            createTaskItem(task);
          });
          setTaskDateBadgeValue(taskList.length);
        }

        function createTaskItem(task) {
          const taskSwitch = task.enabled ? 
            `
              <label class="switch">
                <input class="switchCheckbox" type="checkbox" checked />
                <span class="switchSlider"></span>
              </label>
            ` : 
            `
              <label class="switch">
                <input class="switchCheckbox" type="checkbox" />
                <span class="switchSlider"></span>
              </label>
            `;
          const playBtnBox = task.status === 'running' ? 
            `<i class="fa-solid fa-circle-stop" style="color: #f56c6c;"></i>` : 
            `<i class="fa-solid fa-circle-play" style="color: #2ec6cc;"></i>`;
          const btnGroup = task.status === 'running' ? 
            `
              <div class="runningTaskIndicatorContainer">
                <image src="/images/icon_runningTask.gif" />
              </div>
            ` : 
            `
              <div class="dropdown" style="float: right; top: 5px;">
                <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="color: dimgray;">
                  <i class="fa-solid fa-ellipsis"></i>
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item">
                    <i class="fa-solid fa-rotate" style="width: 16px;"></i> 同步</a>
                  </li>
                  <li>
                    <a class="dropdown-item">
                      <i class="fa-solid fa-pencil-alt" style="width: 16px;"></i> 编辑
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item">
                      <i class="fa-solid fa-copy" style="width: 16px;"></i> 复制
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item">
                      <i class="fa-solid fa-trash-can" style="width: 16px;"></i> 删除
                    </a>
                  </li>
                </ul>
              </div>
            `;
          const $taskItem = $(`
            <div class="taskItem">
              <div style="display: flex; align-items: center;">
                <div class="taskTime">${task.time}</div>
                <div class="line" style="margin: 0px 50px;"></div>
                <div>
                  <div title="1" class="textEllipsis">${task.name}</div>
                  <div title="${task.repeatType}" class="textEllipsis" style="height: 27px; color: rgb(174, 186, 194); font-size: 12px;">
                    <i class="fa-solid fa-location-dot" style="margin-right: 3px;"></i>
                    ${task.repeatType}
                  </div>
                </div>
              </div>
              <div style="min-width: 140px;">
                <div style="display: inline-block; line-height: 35px;">
                  ${taskSwitch}
                </div>
                <div class="playBtnBox">
                  ${playBtnBox}
                </div>
                <div style="display: inline-block;">
                  ${btnGroup}
                </div>
              </div>
            </div>
          `);
          
          $(`#taskContentList`).append($taskItem);
        } 


        let taskDateBadgeCurrentValue = 0,
            taskDateBadgeTargetValue = 0,
            taskDateBadgeIncrement = 1;

        // 更新任务数量
        function updateDisplay() {
          if (taskDateBadgeCurrentValue !== taskDateBadgeTargetValue) {
            taskDateBadgeCurrentValue += taskDateBadgeIncrement;
            $(`#taskDateBadge`).html(taskDateBadgeCurrentValue);
            requestAnimationFrame(updateDisplay);
          }
        }

        // 设置任务数量
        function setTaskDateBadgeValue(newValue) {
          taskDateBadgeTargetValue = newValue;
          taskDateBadgeIncrement = (taskDateBadgeTargetValue > taskDateBadgeCurrentValue) ? 1 : -1;
          requestAnimationFrame(updateDisplay);
        }

        // 初始化添加任务模态框表单
        function initAddTaskModal () {
          $('#taskName').val('');
          //一次绑定多个选择
          $(".moredate").each(function(index, element) {
            const mat = $(element).data("formatter");
            jeDate(element, {
              format: mat
            });
          });
          $('#startTime').val('');
          $('#endTime').val('');

          $('#playbackCycle').val('');

          $('#weekCheckboxGroup').hide();
          $('.taskWeekCheckbox').prop('checked', false);

          showMoreSetting = false;
          $('#moreSettingBtn').empty();
          $('#moreSettingBtn').append($(`<i class="fa-solid fa-chevron-down"></i>`));
          $('#moreSettingContainer').hide();
         
          $('#randomPlay').prop('checked', false);

          $('#volumeControl').val('0');
          $('#volumeLabel').html(0);

          $('#level1').prop('checked', false);
          $('#level2').prop('checked', true);
          $('#level3').prop('checked', false);
        }
      </script>
    </body>
  </html>
{{ end }}
