<!-- Copyright (c) Abstract Machines
SPDX-License-Identifier: Apache-2.0 -->

{{ define "channelthings" }}
    <!doctype html>
    <html lang="en">
        <head>
            <title>分区关联设备</title>
            {{ template "header" }}
        </head>
        <body>
            {{ template "navbar" . }}
            <div class="main-content pt-3">
                <div class="container-fluid">
                    <div class="row-mb-3 p-3">
                        <!-- edit thing modal -->
                        <div class="modal fade" id="editThingModal" tabindex="-1" role="dialog" aria-labelledby="editThingModalLabel" aria-hidden="true">
                          <div class="modal-dialog" role="document">
                              <div class="modal-content">
                                  <div class="modal-header">
                                      <h1 class="modal-title" id="editThingModalLabel">修改设备</h1>
                                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                  </div>
                                  <form id="editThingform">
                                      <div class="modal-body">
                                          <div id="editAlertMessage"></div>

                                          <div class="mb-3">
                                              <label for="name" class="form-label">名称</label>
                                              <input type="text" class="form-control name-field" name="name" id="editName" placeholder="设备名称" />
                                              <div id="editNameError" class="text-danger"></div>
                                          </div>
                                          <div class="mb-3">
                                              <label for="id" class="form-label">设备ID</label>
                                              <input type="text" class="form-control" name="id" id="editID" placeholder="设备ID" readonly />
                                          </div>
                                      </div>
                                      <div class="modal-footer">
                                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                          <button type="submit" class="btn body-button" id="edit-thing-button">确定</button>
                                      </div>
                                  </form>
                              </div>
                          </div>
                        </div>

                        <div class="col-lg-12 mx-auto py-3">
                            {{ template "breadcrumb" . }}
                            <div class="row">
                                <div class="table-responsive table-container">
                                    {{ $shareButton := false }}
                                    {{ if (hasPermission .Permissions "share") }}
                                        {{ $shareButton = true }}
                                    {{ end }}
                                    <div class="d-flex flex-row justify-content-between">
                                        <h4 class="page-header-title">分区关联设备</h4>
                                        <button
                                            role="button"
                                            class="btn body-button"
                                            onclick="openThingModal()"
                                            {{ if not $shareButton }}disabled{{ end }}
                                        >
                                            <i class="fa-solid fa-link fs-4"></i>
                                        </button>
                                        <!-- add thing modal -->
                                        <div class="modal fade" id="addThingModal" tabindex="-1" aria-labelledby="addThingModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h1 class="modal-title" id="addThingModalLabel">添加设备</h1>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <form action="{{ printf "%s/channels/%s/things/connect?item=channels" pathPrefix .ChannelID }}" method="post">
                                                        <div class="modal-body">
                                                            <div class="mb-3">
                                                                <label for="infiniteScroll" class="form-label">设备ID</label>
                                                                <input type="text" name="thingFilter" id="thingFilter" placeholder="通过设备ID过滤" />
                                                                <select class="form-select" name="thingID" id="infiniteScroll" size="5" required>
                                                                    <option disabled>选择设备</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                                            <button type="submit" class="btn body-button">关联</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- {{ template "tableheader" . }} -->
                                    <div class="row buttons mb-3">
                                      <div class="btn-group col-4 offset-4" role="group">
                                        <input type="radio" class="btn-check" name="btnOnlineStatus" id="btnAll" autocomplete="off" />
                                        <label class="btn btn-outline-primary" for="btnAll">全部</label>
                                      
                                        <input type="radio" class="btn-check" name="btnOnlineStatus" id="btnOnline" autocomplete="off" />
                                        <label class="btn btn-outline-primary" for="btnOnline">在线</label>
                                      
                                        <input type="radio" class="btn-check" name="btnOnlineStatus" id="btnOffline" autocomplete="off" />
                                        <label class="btn btn-outline-primary" for="btnOffline">离线</label>
                                      </div>
                                    </div>
                                    <div class="row" id="thingsGrid">
                                        {{ $channelID := .ChannelID }}
                                        {{ range $i, $t := .Things }}
                                            <div class="col-sm-3 mb-3 mb-sm-0" id="{{ $t.ID }}-thingCard">
                                              <div class="channel-thing-card card">
                                                <div class="card-body">
                                                  <h5 class="card-title">{{ $t.Name }}</h5>
                                                  <p>{{ $t.Credentials.Identity }}</p>
                                                  <p>{{ $t.Credentials.Secret }}</p>
                                                  <p id="{{ $t.ID }}-onlineStatusTD" class="card-text">
                                                      {{ if eq $t.Metadata.isOnline "1" }}
                                                          <span class="badge rounded-pill enabled-pill">在线</span>
                                                      {{ else }}
                                                          <span class="badge rounded-pill disabled-pill">离线</span>
                                                      {{ end }}
                                                  </p>
                                                  <p>
                                                      <form action="{{ printf "%s/channels/%s/things/disconnect?item=channels" pathPrefix $channelID }}" method="post">
                                                          <input type="hidden" name="thingID" value="{{ $t.ID }}" />
                                                          <button
                                                              type="submit"
                                                              class="btn body-button"
                                                              title="移除设备"
                                                              {{ if not $shareButton }}disabled{{ end }}
                                                          >
                                                              <i class="fas fa-link-slash"></i>
                                                          </button>
                                                          <button type="button" class="btn body-button" onclick="viewThing('{{ $t.ID }}')" title="查看">
                                                            <i class="fa-solid fa-info"></i>
                                                          </button>
                                                          {{ if eq $t.Metadata.isOnline "1" }}
                                                              <button
                                                                  type="button"
                                                                  id="{{ $t.ID }}-rebootBtn"
                                                                  class="btn body-button"
                                                                  onclick="conntrolThing('{{ $t.ID }}', '{{ $t.Credentials.Identity }}', 'reboot')"
                                                                  title="重启"
                                                              >
                                                                  <i class="fa-solid fa-arrows-rotate"></i>
                                                              </button>
                                                              <button 
                                                                id="{{ $t.ID }}-editBtn" 
                                                                type="button" 
                                                                title="修改" 
                                                                class="btn body-button" 
                                                                title="修改" 
                                                                disabled
                                                              >
                                                                <i class="fa-solid fa-pencil-alt"></i>
                                                              </button>
                                                          {{ else }}
                                                              <button
                                                                  type="button"
                                                                  id="{{ $t.ID }}-rebootBtn"
                                                                  class="btn body-button"
                                                                  title="重启"
                                                                  disabled
                                                              >
                                                                  <i class="fa-solid fa-arrows-rotate"></i>
                                                              </button>
                                                              <button 
                                                                id="{{ $t.ID }}-editBtn" 
                                                                type="button" 
                                                                title="修改" 
                                                                class="btn body-button" 
                                                                onclick="editThing('{{ $t.ID }}', '{{ $t.Name }}')"
                                                              >
                                                                <i class="fa-solid fa-pencil-alt"></i>
                                                              </button>
                                                          {{ end }}
                                                      </form>
                                                  </p>
                                                </div>
                                              </div>
                                            </div>
                                        {{ end }}
                                    </div>
                                    <!-- {{ template "tablefooter" . }} -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
              let currentDevices = {}, newDevices = {};

              $(document).ready(function() {
                const currentUrl = window.location.href; // 获取当前页面的URL
                const urlObj = new URL(currentUrl);
                const onlineStatusValue = (currentUrl.match(/onlineStatus=(\d+)/) || [])[1]; // 从URL获取onlineStatus的值

                getThingsList(onlineStatusValue);

                if (onlineStatusValue === '1') {
                  $('#btnAll').prop('checked', false);
                  $('#btnOnline').prop('checked', true);
                  $('#btnOffline').prop('checked', false);
                } else if (onlineStatusValue === '0') {
                  $('#btnAll').prop('checked', false);
                  $('#btnOnline').prop('checked', false);
                  $('#btnOffline').prop('checked', true);
                } else {
                  $('#btnAll').prop('checked', true);
                  $('#btnOnline').prop('checked', false);
                  $('#btnOffline').prop('checked', false);
                }


                $('input[name="btnOnlineStatus"]').change(function() {
                  let reqOnlineStatus = '2'; //all
                  if (this.id === 'btnOnline') {
                    reqOnlineStatus = '1'; //online
                  } else if (this.id === 'btnOffline') {
                    reqOnlineStatus = '0'; //offline
                  }
                  window.location.href = `${urlObj.pathname}?limit=1000&onlineStatus=${reqOnlineStatus}`;
                });

                const intervalRefreshData = setInterval(refreshThingsData, 2000);
              });

              const thingModal = new bootstrap.Modal(document.getElementById("addThingModal"));
              const editThingModal = new bootstrap.Modal(document.getElementById("editThingModal"));

              function openThingModal() {
                thingModal.show();
              }

              function editThing(id, name) {
                editThingModal.show();
                $("#editName").val(name);
                $("#editID").val(id);
              }

              //查看详情
              function viewThing(id) {
                window.location.href = '{{printf "%s/things/" pathPrefix}}' + id;
              }

              //控制设备
              function conntrolThing(thingID, thingIdentity, controlType) {
                //获取当前domain的ID号
                const domainID = sessionStorage.getItem("domainID");

                fetch(`/ui/domains/${domainID}/domainInJSON`, {
                  method: "GET",
                })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok');
                    }
                    return response.json(); // 直接将流转换为JSON对象
                  })
                  .then(json => {
                    const data = json.data;
                    const domainData = JSON.parse(data).domainData;
                    const defaultChannelId = domainData.metadata["comID"];
                    const message = `${controlType} ${thingIdentity}`;
                    if (domainID && defaultChannelId) {
                      const message = `${controlType} ${thingIdentity}`;
                      postMessage(defaultChannelId, message)
                    }
                  })
              }

              function changeOnlineStatus(thing){
                const onlineStatus = thing.metadata && thing.metadata.isOnline === "1";
                $(`#${thing.id}-onlineStatusTD`).empty();
                if (onlineStatus) {
                  $('<span class="badge rounded-pill enabled-pill">在线</span>').appendTo(`#${thing.id}-onlineStatusTD`);
                  $(`#${thing.id}-rebootBtn`).prop('disabled', false);
                  // $(`#${thing.id}-deleteBtn`).prop('disabled', true);
                  $(`#${thing.id}-editBtn`).prop('disabled', true);
                } else {
                  $('<span class="badge rounded-pill disabled-pill">离线</span>').appendTo(`#${thing.id}-onlineStatusTD`);
                  $(`#${thing.id}-rebootBtn`).prop('disabled', true);
                  // $(`#${thing.id}-deleteBtn`).prop('disabled', false);
                  $(`#${thing.id}-editBtn`).prop('disabled', false);
                }
              }

              //轮询刷新thingslist，以实现监听things在线状态的
              function refreshThingsData() {
                // 获取当前页面的完整URL
                const currentUrl = window.location.href;
                // 创建URL对象
                const urlObj = new URL(currentUrl);
                // 使用URL对象的searchParams属性获取URLSearchParams对象
                const searchParams = urlObj.searchParams;
                // 使用get方法从URLSearchParams对象中获取page和limit的值
                const page = searchParams.get('page') || 1;
                const limit = searchParams.get('limit') || 1000;
                const reqOnlineStatus = searchParams.get('onlineStatus') || 2;
                fetch(`${urlObj.pathname}InJSON?page=${page}&limit=${limit}&onlineStatus=${reqOnlineStatus}`, {
                  method: "GET",
                })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok');
                    }
                    return response.json(); // 直接将流转换为JSON对象
                  })
                  .then(json => {
                    const data = json.data;
                    const thingsData = JSON.parse(data).thingsData;
                    const things = thingsData.things;
                    if (Number(reqOnlineStatus) === 2) {
                      // 所有设备
                      things.forEach((thing) => {
                        changeOnlineStatus(thing);
                      });
                    } else {
                      newDevices = {};
                       // 所有在线\离线
                      if (things.length) {
                        things.forEach(device => {
                          newDevices[device.id] = {
                            id: device.id,
                            name: device.name,
                            credentials: device.credentials,
                            metadata: device.metadata,
                            status: device.status,
                            created_at: device.created_at,
                            updated_at: device.updated_at,
                          };
                        });
                        updateThingsGrid(things);
                      } else {
                        currentDevices = {};
                        $(`#thingsGrid`).empty();
                      };
                    }
                  })
                  .catch(error => {
                    // console.error('处理fetch或JSON时出错:', error);
                  });
              }
              
              function updateThingsGrid(devices) {
                const $thingsGrid = $('#thingsGrid');
                const currentDevicesLength = Object.keys(currentDevices).length;
                const newDevicesLength = Object.keys(newDevices).length;
                const urlObj = new URL(window.location.href);
                const match = urlObj.pathname.match(/\/channels\/([^\/]+)\/things/);
                let channelID = '';
                if (match) {
                  channelID = match[1];
                }

                if (currentDevicesLength > newDevicesLength) {
                  // 移除不在(查询在线时刚离线的，查询离线时刚上线的)的设备\
                  Object.keys(currentDevices).forEach((curId)=>{
                    if (
                      (typeof newDevices === 'object' && Object.entries(newDevices).length === 0) || 
                      (newDevices[curId] === null || newDevices[curId] === undefined) ||
                      (typeof newDevices[curId] === 'object' && Object.entries(newDevices[curId]).length === 0)
                    ) {
                      // 移除不在(查询在线时离线的，查询离线时上线的)的设备
                      $(`#${curId}-thingCard`).remove();
                    }
                  })
                } else if (currentDevicesLength < newDevicesLength) {
                  // 新增(查询在线时刚上线的，查询离线时刚离线的)的设备]
                  Object.keys(newDevices).forEach((newId)=>{
                    if (
                      (typeof currentDevices === 'object' && Object.entries(currentDevices).length === 0) || 
                      (currentDevices[newId] === null || currentDevices[newId] === undefined) ||
                      (typeof currentDevices[newId] === 'object' && Object.entries(currentDevices[newId]).length === 0)
                    ) {
                      const device = newDevices[newId];
                      const onlineSpan = device.metadata && Number(device.metadata.isOnline) === 1 ? 
                        $(`<span class="badge rounded-pill enabled-pill">在线</span>`) : 
                        $(`<span class="badge rounded-pill disabled-pill">离线</span>`);
                      
                      const btnSpan = device.metadata && Number(device.metadata.isOnline) === 1 ? 
                        $(`
                          <p>
                            <form action="/ui/channels/${channelID}/things/disconnect?item=channels" method="post">
                              <input type="hidden" name="thingID" value="${device.id}" />
                              <button
                                  type="submit"
                                  class="btn body-button"
                                  title="移除设备"
                              >
                                  <i class="fas fa-link-slash"></i>
                              </button>
                              <button class="btn body-button" onclick="viewThing(${device.id})" title="查看">
                                <i class="fa-solid fa-info"></i>
                              </button>
                              <button
                                id="${device.id}-rebootBtn"
                                class="btn body-button"
                                onclick="conntrolThing(${device.id}, ${device.credentials.identity}, 'reboot')"
                                title="重启"
                              >
                                <i class="fa-solid fa-arrows-rotate"></i>
                              </button>
                              <button 
                                id="${device.id}-editBtn" 
                                title="修改" 
                                class="btn body-button" 
                                onclick="editThing(${device.id}, ${device.name})"
                                disabled
                              >
                                <i class="fa-solid fa-pencil-alt"></i>
                              </button>
                            </form>
                          </p>
                        `) : 
                        $(`
                          <p>
                            <form action="/ui/channels/${channelID}/things/disconnect?item=channels" method="post">
                              <input type="hidden" name="thingID" value="${device.id}" />
                              <button
                                  type="submit"
                                  class="btn body-button"
                                  title="移除设备"
                              >
                                  <i class="fas fa-link-slash"></i>
                              </button>
                              <button class="btn body-button" onclick="viewThing(${device.id})" title="查看">
                                <i class="fa-solid fa-info"></i>
                              </button>
                              <button
                                id="${device.id}-rebootBtn"
                                class="btn body-button"
                                onclick="conntrolThing(${device.id}, ${device.credentials.identity}, 'reboot')"
                                title="重启"
                                disabled
                              >
                                <i class="fa-solid fa-arrows-rotate"></i>
                              </button>
                              <button 
                                id="${device.id}-editBtn" 
                                title="修改" 
                                class="btn body-button" 
                                onclick="editThing(${device.id}, ${device.name})"
                              >
                                <i class="fa-solid fa-pencil-alt"></i>
                              </button>
                            </form>
                          </p>
                        `);
                      const $thingCard = $(`
                        <div class="col-sm-3 mb-3 mb-sm-0" id="${device.id}-thingCard">
                          <div class="channel-thing-card card">
                            <div class="card-body">
                              <h5 class="card-title">${device.name}</h5>
                              <p>${device.credentials.identity}</p>
                              <p id="${device.id}-onlineStatusTD" class="card-text">
                                ${onlineSpan}
                              </p>
                              ${btnSpan}
                            </div>
                          </div>
                        </div>
                      `);
                      $(`#thingsGrid`).append($thingCard);
                    }
                  })
                }

                currentDevices = {};
                currentDevices = newDevices;
              }

              //根据在线类型获取设备列表
              function getThingsList(onlineStatus) {
                const urlObj = new URL(window.location.href);
                currentDevices = {};
                fetch(`${urlObj.pathname}InJSON?limit=1000&onlineStatus=${onlineStatus}`, {
                  method: "GET",
                })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok');
                    }
                    return response.json(); // 直接将流转换为JSON对象
                  })
                  .then(json => {
                    const data = json.data;
                    const thingsData = JSON.parse(data).thingsData;
                    const things = thingsData.things || [];
                    currentDevices = {};
                    if (things.length) {
                      things.forEach(device => {
                        currentDevices[device.id] = {
                          id: device.id,
                          name: device.name,
                          credentials: device.credentials,
                          metadata: device.metadata,
                          status: device.status,
                          created_at: device.created_at,
                          updated_at: device.updated_at,
                        };
                      });
                    }
                  })
                  .catch(error => {
                    //
                  });
              }

              function postMessage(channelID, message) {
                let formData = new FormData();
                formData.append("channelID", channelID);
                formData.append("message", message);
                formData.append("thingSecret", "platform");
                fetch(`/ui/channels/messages`, {
                  method: "POST",
                  body: formData,
                })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok');
                    }
                    return response.json(); // 直接将流转换为JSON对象
                  })
                  .then(json => {
                    //
                  })
                  .catch(error => {
                    console.error('处理fetch或JSON时出错:', error);
                  });
              }
            </script>      
            <script type="module">
              import {
                attachValidationListener,
                validateName,
              } from "/js/validation.js";
              import { submitCreateForm } from "/js/forms.js";
              import { fetchIndividualEntity } from "/js/infinitescroll.js";

              fetchIndividualEntity({
                input: "thingFilter",
                itemSelect: "infiniteScroll",
                item: "things",
                pathPrefix: "{{ pathPrefix }}",
              });

              attachValidationListener({
                buttonId: "edit-thing-button",
                errorDivs: {
                  name: "editNameError",
                },
                validations: {
                  editName: validateName,
                },
                fields: {
                  editName: "name-field",
                },
              });

              submitCreateForm({
                url: '{{ printf "%s/things" pathPrefix }}',
                formId: "editThingform",
                alertDiv: "editAlertMessage",
                modal: editThingModal,
                type: "edit"
              });
            </script>
        </body>
    </html>
{{ end }}
